# Maestro — Agent Rules

## Identity

Maestro — AI music composition backend (FastAPI + MCP) for the Stori DAW, a **macOS app** (never say "iOS"). Tagline: "the infinite music machine."

- **Entry points:** `POST /api/v1/maestro/stream` (human in DAW) and MCP tools (Cursor/Claude). Same engine, same pipeline.
- **Stack:** Python 3.11+, FastAPI, Pydantic v2, fully async. Storpheus required for generation (no fallback).
- **Models:** Exactly two — `anthropic/claude-sonnet-4.6` and `anthropic/claude-opus-4.6` via OpenRouter. No others.
- **Version:** Single source of truth in `pyproject.toml`. Everything else derives from `maestro/protocol/version.py`.

## Agent scope

You may: implement features, fix bugs, refactor, extend architecture, add tests, update docs.
You may NOT: introduce new frameworks/dependencies without justification, redesign architecture unless requested, weaken security, skip tests.
When uncertain: (1) preserve existing patterns, (2) prefer smaller changes over rewrites, (3) choose correct over simple, (4) document assumptions, (5) ask the user.

## Architecture (do not weaken)

- **Intent-first:** Classify → REASONING / EDITING / COMPOSING.
- **Layers:** Routes (thin) → Core (`maestro/core/`) → Services (`maestro/services/`) → Models. Never collapse.
- **Single engine:** Stream and MCP share pipeline, tools, DAW state.
- **No deprecated APIs:** Frontend and backend ship in lockstep. No fallbacks. Remove dead code on sight.

## Execution

- **Docker-first:** Never run Python on the host. `docker compose exec <service> <cmd>`.
- **Dev bind mounts are active.** `docker-compose.override.yml` bind-mounts `maestro/`, `tests/`, `scripts/`, `storpheus/`, and `pyproject.toml` into the containers. Host file edits are **instantly visible** inside the container — no rebuild needed for code changes. Only rebuild (`docker compose build <service> && docker compose up -d`) when you change `requirements.txt`, `Dockerfile`, or `entrypoint.sh`.
- **Two containers:** `maestro` (`maestro/`, `tests/`) and `storpheus` (`storpheus/`). Both have mypy and pytest.
- **Verification order: mypy → tests → docs.** Always run mypy first. Fix type errors before running tests so you only need one test pass.
- **Mypy (both):** `docker compose exec maestro mypy maestro/ tests/` AND `docker compose exec storpheus mypy .`. Both pass before committing.
- **Tests:** Run individual files yourself; user runs full suite. Regression test for every bug fix: `test_<what_broke>_<fixed_behavior>`.
- **Show full output:** Never truncate, pipe through `head`/`tail`, or hide shell output.
- **After tests pass:** Update affected docs, then commit — don't wait to be asked.

## Code standards

- **Every Python file** starts with `from __future__ import annotations`. No exceptions.
- Black formatting. Type hints everywhere. `list[...]`/`dict[...]` style. No `# type: ignore` without reason.
- **Mypy before tests:** Run `docker compose exec <service> mypy <file>` on every Python file you create or modify. Fix all type errors before running tests — this avoids needing to re-run the test suite after type fixes.
- Async for all I/O. `logging.getLogger(__name__)` — never `print()`. `STORI_*` env vars via `app.config.settings`.
- Sparse logs with emoji prefixes (❌ error, ⚠️ warning, ✅ success). No noise.
- Docstrings on public modules/classes/functions. "Why" over "what." Update docs in the same commit as code changes.

## Testing

- Naming: `test_<behavior>_<scenario>`. Shared fixtures in `tests/conftest.py`. `@pytest.mark.anyio` for async.
- Coverage: `docker compose exec maestro sh -c "export COVERAGE_FILE=/tmp/.coverage && python -m coverage run -m pytest tests/ -v && python -m coverage report --fail-under=80 --show-missing"`

## Streaming & E2E

- Streaming curl: `block_until_ms: 300000` (5 min). Never `block_until_ms: 0` (kills visibility).
- E2E tests use `e2e_pocket_groove` from `prompts_world.py` with `Mode: compose`.
- Ephemeral scripts go to `/tmp/` — never committed.

## Storpheus service

- `music_service.py` — FastAPI (port 10002), flat module layout. Proxies to HF Space Gradio API for inference.
- **Instrument resolution:** `resolve_gm_program(role)` → GM program, `resolve_tmidix_name(role)` → TMIDIX string, `_resolve_melodic_index(role)` → channel (0=bass, 1=keys, 2=other).
- **MIDI pipeline:** `select_seed()` → transpose → control vector → Gradio → score candidates → post-process → `parse_midi_to_notes()` → `filter_channels_for_instruments()` → notes to Maestro.
- When adding GM aliases: extend `_GM_ALIASES` AND add parametrized cases in `test_gm_resolution.py`.

## Anti-patterns (never do these)

- **No legacy, no deprecated, no backwards compatibility.** Frontend and backend ship in lockstep. Remove dead code, dead fields, dead endpoints on sight. Never add fallback paths for old API shapes. If a field or function is unused, delete it — don't leave it "for backwards compatibility."
- Business logic in route handlers. Global mutable state outside designated stores.
- Hardcoded model IDs, secrets, URLs, or instrument dicts outside config/`_GM_ALIASES`.
- Tests on live APIs without skip guards. `sleep()` in tests. Asserting implementation details instead of behavior.
- `print()` for diagnostics. Backgrounding streaming curl. Committing ephemeral scripts.
- Adding pip dependencies without updating Dockerfile. Running Python on the host.

## Doc locations

| Topic | File |
|-------|------|
| Setup/deploy | `docs/guides/setup.md` |
| Frontend/MCP/JWT | `docs/guides/integrate.md` |
| API reference | `docs/reference/api.md` |
| Architecture | `docs/reference/architecture.md` |
| **Storpheus** | `docs/reference/storpheus.md` |
| Muse VCS | `docs/architecture/muse-vcs.md` |
| Testing | `docs/guides/testing.md` |
| Security | `docs/guides/security.md` |
| Protocol specs | `docs/protocol/` |

## Services

| Service | Container | Port |
|---------|-----------|------|
| Maestro | `maestro-app` | 10001 |
| Storpheus | `maestro-storpheus` | 10002 |
| Postgres | `maestro-postgres` | 5432 |
| Qdrant | `maestro-qdrant` | 6333/6334 |
| Nginx | `maestro-nginx` | 80/443 |

## Quick reference

| Area | Code | Tests |
|------|------|-------|
| Config | `maestro/config.py` | `tests/test_config.py` |
| Intent | `maestro/core/intent*.py` | `tests/test_intent*.py` |
| Pipeline | `maestro/core/pipeline.py` | `tests/test_pipeline.py` |
| Maestro | `maestro/core/maestro_handlers.py` | `tests/test_maestro_handlers.py` |
| Agent Teams | `maestro/core/maestro_agent_teams/` | `tests/test_section_agent.py` |
| Storpheus | `storpheus/music_service.py` | `storpheus/test_*.py` |
| MCP | `maestro/mcp/` | `tests/test_mcp.py` |
| DAW Adapter | `maestro/daw/` | `tests/test_daw_adapter.py` |
| Muse VCS | `maestro/services/muse_*.py` | `tests/test_muse_*.py` |
| Muse Routes | `maestro/api/routes/muse.py` | `tests/e2e/test_muse_e2e_harness.py` |
| Muse Render | `maestro/services/muse_log_render.py` | `tests/e2e/test_muse_e2e_harness.py` |
