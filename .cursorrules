# Stori Maestro — Agent Rules

## Identity

Stori Maestro — AI music composition backend (FastAPI + MCP) for the Stori DAW, a **macOS app** (never say "iOS"). Tagline: "the infinite music machine."

- **Entry points:** `POST /api/v1/maestro/stream` (human in DAW) and MCP tools (Cursor/Claude). Same engine, same pipeline.
- **Stack:** Python 3.11+, FastAPI, Pydantic v2, fully async. Orpheus required for generation (no fallback).
- **Models:** Exactly two — `anthropic/claude-sonnet-4.6` and `anthropic/claude-opus-4.6` via OpenRouter. No others.
- **Version:** Single source of truth in `pyproject.toml`. Everything else derives from `app/protocol/version.py`.

## Agent scope

You may: implement features, fix bugs, refactor, extend architecture, add tests, update docs.
You may NOT: introduce new frameworks/dependencies without justification, redesign architecture unless requested, weaken security, skip tests.
When uncertain: (1) preserve existing patterns, (2) prefer smaller changes over rewrites, (3) choose correct over simple, (4) document assumptions, (5) ask the user.

## Architecture (do not weaken)

- **Intent-first:** Classify → REASONING / EDITING / COMPOSING.
- **Layers:** Routes (thin) → Core (`app/core/`) → Services (`app/services/`) → Models. Never collapse.
- **Single engine:** Stream and MCP share pipeline, tools, DAW state.
- **No deprecated APIs:** Frontend and backend ship in lockstep. No fallbacks. Remove dead code on sight.

## Execution

- **Docker-first:** Never run Python on the host. `docker compose exec <service> <cmd>`. Rebuild before testing: `docker compose build <service> && docker compose up -d`.
- **Two containers:** `maestro` (`app/`, `tests/`) and `orpheus` (`orpheus-music/`). Both have mypy and pytest.
- **Mypy (both):** `docker compose exec maestro mypy app/ tests/` AND `docker compose exec orpheus mypy .`. Both pass before committing.
- **Tests:** Run individual files yourself; user runs full suite. Regression test for every bug fix: `test_<what_broke>_<fixed_behavior>`.
- **Show full output:** Never truncate, pipe through `head`/`tail`, or hide shell output.
- **After tests pass:** Update affected docs, then commit — don't wait to be asked.

## Code standards

- Black formatting. Type hints everywhere. `list[...]`/`dict[...]` style. No `# type: ignore` without reason.
- Async for all I/O. `logging.getLogger(__name__)` — never `print()`. `STORI_*` env vars via `app.config.settings`.
- Sparse logs with emoji prefixes (❌ error, ⚠️ warning, ✅ success). No noise.
- Docstrings on public modules/classes/functions. "Why" over "what." Update docs in the same commit as code changes.

## Testing

- Naming: `test_<behavior>_<scenario>`. Shared fixtures in `tests/conftest.py`. `@pytest.mark.anyio` for async.
- Coverage: `docker compose exec maestro sh -c "export COVERAGE_FILE=/tmp/.coverage && python -m coverage run -m pytest tests/ -v && python -m coverage report --fail-under=80 --show-missing"`

## Streaming & E2E

- Streaming curl: `block_until_ms: 300000` (5 min). Never `block_until_ms: 0` (kills visibility).
- E2E tests use `e2e_pocket_groove` from `prompts_world.py` with `Mode: compose`.
- Ephemeral scripts go to `/tmp/` — never committed.

## Orpheus service

- `music_service.py` — FastAPI (port 10002), flat module layout. Proxies to HF Space Gradio API for inference.
- **Instrument resolution:** `resolve_gm_program(role)` → GM program, `resolve_tmidix_name(role)` → TMIDIX string, `_resolve_melodic_index(role)` → channel (0=bass, 1=keys, 2=other).
- **MIDI pipeline:** `create_seed_midi()` → Gradio → `parse_midi_to_notes()` → `filter_channels_for_instruments()` → `generate_tool_calls()` → DAW.
- When adding GM aliases: extend `_GM_ALIASES` AND add parametrized cases in `test_gm_resolution.py`.

## Anti-patterns (never do these)

- Business logic in route handlers. Global mutable state outside designated stores.
- Hardcoded model IDs, secrets, URLs, or instrument dicts outside config/`_GM_ALIASES`.
- Tests on live APIs without skip guards. `sleep()` in tests. Asserting implementation details instead of behavior.
- `print()` for diagnostics. Backgrounding streaming curl. Committing ephemeral scripts.
- Adding pip dependencies without updating Dockerfile. Running Python on the host.

## Doc locations

| Topic | File |
|-------|------|
| Setup/deploy | `docs/guides/setup.md` |
| Frontend/MCP/JWT | `docs/guides/integrate.md` |
| API reference | `docs/reference/api.md` |
| Architecture | `docs/reference/architecture.md` |
| Testing | `docs/guides/testing.md` |
| Security | `docs/guides/security.md` |
| Protocol specs | `docs/protocol/` |

## Services

| Service | Container | Port |
|---------|-----------|------|
| Maestro | `maestro-stori-app` | 10001 |
| Orpheus | `maestro-stori-orpheus` | 10002 |
| Postgres | `maestro-stori-postgres` | 5432 |
| Qdrant | `maestro-stori-qdrant` | 6333/6334 |
| Nginx | `maestro-stori-nginx` | 80/443 |

## Quick reference

| Area | Code | Tests |
|------|------|-------|
| Config | `app/config.py` | `tests/test_config.py` |
| Intent | `app/core/intent*.py` | `tests/test_intent*.py` |
| Pipeline | `app/core/pipeline.py` | `tests/test_pipeline.py` |
| Maestro | `app/core/maestro_handlers.py` | `tests/test_maestro_handlers.py` |
| Agent Teams | `app/core/maestro_agent_teams/` | `tests/test_section_agent.py` |
| Orpheus | `orpheus-music/music_service.py` | `orpheus-music/test_*.py` |
| MCP | `app/mcp/` | `tests/test_mcp.py` |
