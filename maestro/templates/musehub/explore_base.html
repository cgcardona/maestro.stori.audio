<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/musehub/static/tokens.css">
  <link rel="stylesheet" href="/musehub/static/components.css">
  <link rel="stylesheet" href="/musehub/static/layout.css">
  <link rel="stylesheet" href="/musehub/static/icons.css">
  <link rel="stylesheet" href="/musehub/static/music.css">
  <title>{% block title %}{{ title }}{% endblock %} — Muse Hub</title>
</head>
<body>
  <header>
    <span class="logo"><a href="/musehub/ui/explore" style="color:inherit;text-decoration:none">&#127925; Muse Hub</a></span>
    <span class="breadcrumb">{{ breadcrumb }}</span>
    <span style="flex:1"></span>
    <a href="/musehub/ui/explore" class="btn btn-ghost btn-sm" style="font-size:12px">Explore</a>
    <a href="/musehub/ui/trending" class="btn btn-ghost btn-sm" style="font-size:12px">Trending</a>
    <button id="signout-btn" class="btn btn-secondary btn-sm" style="font-size:12px;display:none"
            onclick="clearToken();location.reload()">Sign out</button>
  </header>

  <div class="container-wide">

    <!-- Filter bar -->
    <div class="card" style="margin-bottom:var(--space-4)">
      <div style="display:flex;flex-wrap:wrap;gap:var(--space-3);align-items:flex-end">
        <div class="filter-group">
          <label class="form-label" for="genre-inp">Genre / Tags</label>
          <input id="genre-inp" class="form-input" type="text" placeholder="jazz, lo-fi, neo-soul…"
                 style="width:160px" oninput="applyFilters()"/>
        </div>
        <div class="filter-group">
          <label class="form-label" for="key-inp">Key</label>
          <input id="key-inp" class="form-input" type="text" placeholder="F# minor"
                 style="width:120px" oninput="applyFilters()"/>
        </div>
        <div class="filter-group">
          <label class="form-label" for="tempo-min">BPM min</label>
          <input id="tempo-min" class="form-input" type="number" min="20" max="300" placeholder="60"
                 style="width:80px" oninput="applyFilters()"/>
        </div>
        <div class="filter-group">
          <label class="form-label" for="tempo-max">BPM max</label>
          <input id="tempo-max" class="form-input" type="number" min="20" max="300" placeholder="180"
                 style="width:80px" oninput="applyFilters()"/>
        </div>
        <div class="filter-group">
          <label class="form-label" for="instr-inp">Instrument</label>
          <input id="instr-inp" class="form-input" type="text" placeholder="bass, piano…"
                 style="width:130px" oninput="applyFilters()"/>
        </div>
        <div class="filter-group">
          <label class="form-label" for="sort-sel">Sort by</label>
          <select id="sort-sel" class="form-select" onchange="applyFilters()" style="width:130px">
            <option value="created"  {% if default_sort == 'created'  %}selected{% endif %}>Newest</option>
            <option value="stars"    {% if default_sort == 'stars'    %}selected{% endif %}>Most Starred</option>
            <option value="activity" {% if default_sort == 'activity' %}selected{% endif %}>Most Active</option>
            <option value="commits"  {% if default_sort == 'commits'  %}selected{% endif %}>Most Commits</option>
          </select>
        </div>
        <button class="btn btn-ghost btn-sm" onclick="clearFilters()">Clear filters</button>
      </div>
    </div>

    <!-- Results section title -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-3)">
      <h2 id="section-title" style="margin:0">{{ title }}</h2>
      <span id="result-count" class="text-muted text-sm"></span>
    </div>

    <input type="hidden" id="cur-page" value="1"/>
    <div id="repo-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:var(--space-4)">
      <p class="loading">Loading&#8230;</p>
    </div>
    <div id="pager" style="margin-top:var(--space-6)"></div>
  </div>

  <!-- Persistent audio player -->
  <div class="audio-player" id="audio-player" style="display:none">
    <button class="player-btn" id="player-toggle" onclick="togglePlay()">&#9654;</button>
    <div class="player-info">
      <span class="player-title" id="player-title">Now Playing</span>
      <span class="player-repo" id="player-repo"></span>
    </div>
    <div class="player-progress">
      <span class="player-time" id="player-current">0:00</span>
      <input type="range" class="player-seek" id="player-seek" value="0" min="0" max="100" step="0.1"
             oninput="seekAudio(this.value)" />
      <span class="player-time" id="player-duration">0:00</span>
    </div>
    <audio id="player-audio" onended="onAudioEnded()" ontimeupdate="onTimeUpdate()"
           onloadedmetadata="onMetadata()"></audio>
    <button class="player-btn" onclick="closePlayer()" title="Close">&#10005;</button>
  </div>

  <script src="/musehub/static/musehub.js"></script>
  <script>
  window.addEventListener('DOMContentLoaded', function() {
    if (getToken()) {
      const btn = document.getElementById('signout-btn');
      if (btn) btn.style.display = '';
    }

    const DISCOVER_API = '/api/v1/musehub';
    const PAGE_SIZE = 24;

    // Deterministic fake waveform bars for visual variety (no actual audio data needed)
    function waveformBars(seed) {
      const bars = [];
      let x = seed;
      for (let i = 0; i < 32; i++) {
        x = (x * 1103515245 + 12345) & 0x7fffffff;
        const h = 20 + (x % 70);
        bars.push(`<div class="wave-col" style="height:${h}%"></div>`);
      }
      return bars.join('');
    }

    function repoCard(r) {
      const repoUrl  = '/musehub/ui/' + encodeURIComponent(r.owner || r.ownerUserId || '') + '/' + encodeURIComponent(r.slug || '');
      const tags     = (r.tags || []).slice(0, 4).map(t => `<span class="nav-meta-tag">${escHtml(t)}</span>`).join('');
      const key      = r.keySignature ? `<span class="nav-meta-pill">&#9837; ${escHtml(r.keySignature)}</span>` : '';
      const bpm      = r.tempoBpm    ? `<span class="nav-meta-pill">${r.tempoBpm} BPM</span>` : '';
      const seed     = (r.slug || '').split('').reduce((a, c) => a + c.charCodeAt(0), 0);

      // Find a preview audio URL if the repo has artifacts
      const previewUrl = r.latestAudioUrl || null;

      return `
        <div class="repo-card" onclick="location.href='${repoUrl}'">
          <div class="repo-card-header">
            <span class="repo-card-name">
              <a href="${repoUrl}" onclick="event.stopPropagation()">${escHtml(r.name || r.slug)}</a>
            </span>
            <span class="badge ${r.visibility === 'public' ? 'badge-clean' : 'badge-neutral'}" style="font-size:10px">${escHtml(r.visibility || 'public')}</span>
          </div>
          <div class="text-xs text-muted" style="margin-bottom:var(--space-1)">
            <a href="/musehub/ui/users/${escHtml(r.owner || r.ownerUserId || '')}" onclick="event.stopPropagation()">
              ${escHtml(r.owner || r.ownerUserId || '')}
            </a>
          </div>
          ${r.description ? `<div class="repo-card-desc">${escHtml(r.description)}</div>` : ''}
          <div class="repo-card-tags">
            ${tags}${key}${bpm}
          </div>
          <!-- Waveform preview bar -->
          <div class="waveform-bar" style="margin:var(--space-2) 0">
            ${waveformBars(seed)}
          </div>
          <div class="repo-card-meta">
            <span>&#9733; ${r.starCount || 0}</span>
            <span>&#128190; ${r.commitCount || 0} commits</span>
            ${r.lastCommitAt ? `<span>${fmtRelative(r.lastCommitAt)}</span>` : ''}
          </div>
          ${previewUrl ? `
          <button class="repo-card-play" title="Preview"
                  onclick="event.stopPropagation();queueAudio('${escHtml(previewUrl)}','${escHtml(r.name || r.slug)}','${escHtml(r.owner || r.ownerUserId || '')}')">
            &#9654;
          </button>` : ''}
        </div>`;
    }

    async function loadExplore(page) {
      const sort     = document.getElementById('sort-sel').value;
      const genre    = document.getElementById('genre-inp').value.trim();
      const key      = document.getElementById('key-inp').value.trim();
      const tempoMin = document.getElementById('tempo-min').value.trim();
      const tempoMax = document.getElementById('tempo-max').value.trim();
      const instr    = document.getElementById('instr-inp').value.trim();

      const params = new URLSearchParams({ page, page_size: PAGE_SIZE, sort });
      if (genre)    params.set('genre', genre);
      if (key)      params.set('key', key);
      if (tempoMin) params.set('tempo_min', tempoMin);
      if (tempoMax) params.set('tempo_max', tempoMax);
      if (instr)    params.set('instrumentation', instr);

      document.getElementById('repo-grid').innerHTML = '<p class="loading">Loading&#8230;</p>';

      try {
        const res  = await fetch(DISCOVER_API + '/discover/repos?' + params.toString());
        if (!res.ok) throw new Error(res.status + ': ' + await res.text());
        const data = await res.json();
        const repos = data.repos || [];
        const total = data.total || 0;
        const pages = Math.ceil(total / PAGE_SIZE) || 1;

        document.getElementById('result-count').textContent = total + ' repo' + (total !== 1 ? 's' : '');

        const grid = repos.length === 0
          ? `<div class="empty-state" style="grid-column:1/-1">
               <div class="empty-icon">&#127925;</div>
               <p class="empty-title">No repos found</p>
               <p class="empty-desc">Try adjusting your filters, or check back as more composers push their work.</p>
             </div>`
          : repos.map(repoCard).join('');

        document.getElementById('repo-grid').innerHTML = grid;
        document.getElementById('pager').innerHTML = pages <= 1 ? '' : `
          <div style="display:flex;align-items:center;justify-content:center;gap:var(--space-3)">
            ${page > 1 ? `<button class="btn btn-secondary btn-sm" onclick="go(${page-1})">&larr; Prev</button>` : ''}
            <span class="text-muted text-sm">Page ${page} of ${pages}</span>
            ${page < pages ? `<button class="btn btn-secondary btn-sm" onclick="go(${page+1})">Next &rarr;</button>` : ''}
          </div>`;
      } catch(e) {
        document.getElementById('repo-grid').innerHTML = '<p class="error">&#10005; ' + escHtml(e.message) + '</p>';
      }
    }

    function go(page) {
      document.getElementById('cur-page').value = page;
      loadExplore(page);
    }

    window.applyFilters = function() { go(1); };
    window.clearFilters = function() {
      ['genre-inp','key-inp','tempo-min','tempo-max','instr-inp'].forEach(id => {
        document.getElementById(id).value = '';
      });
      go(1);
    };
    window.go = go;

    go(1);
  });
  </script>
</body>
</html>
