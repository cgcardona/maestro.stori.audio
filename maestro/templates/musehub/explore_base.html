<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/musehub/static/tokens.css">
  <link rel="stylesheet" href="/musehub/static/components.css">
  <link rel="stylesheet" href="/musehub/static/layout.css">
  <link rel="stylesheet" href="/musehub/static/icons.css">
  <link rel="stylesheet" href="/musehub/static/music.css">
  <title>{% block title %}Muse Hub{% endblock %} — Muse Hub</title>
  <style>
    .filter-bar {
      display: flex; flex-wrap: wrap; gap: 8px; align-items: flex-end;
      background: #161b22; border: 1px solid #30363d; border-radius: 6px;
      padding: 12px; margin-bottom: 16px;
    }
    .filter-group { display: flex; flex-direction: column; gap: 4px; }
    .filter-label { font-size: 11px; color: #8b949e; text-transform: uppercase; letter-spacing: 0.5px; }
    .filter-group input {
      background: #0d1117; color: #c9d1d9; border: 1px solid #30363d;
      border-radius: 6px; padding: 6px 10px; font-size: 13px; width: 140px;
    }
    .filter-group input:focus { outline: none; border-color: #58a6ff; }
    .repo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
    }
    .repo-card {
      background: #161b22; border: 1px solid #30363d; border-radius: 6px;
      padding: 14px; display: flex; flex-direction: column; gap: 6px;
      transition: border-color 0.15s;
    }
    .repo-card:hover { border-color: #58a6ff; }
    .repo-card-title { font-size: 15px; font-weight: 600; }
    .repo-card-owner { font-size: 12px; color: #8b949e; }
    .repo-card-desc  { font-size: 13px; color: #c9d1d9; }
    .repo-card-tags  { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
    .repo-card-meta  {
      display: flex; gap: 12px; flex-wrap: wrap;
      font-size: 12px; color: #8b949e; margin-top: 4px;
    }
    .pager {
      display: flex; align-items: center; justify-content: center;
      gap: 12px; margin-top: 20px;
    }
  </style>
</head>
<body>
  <header>
    <span class="logo">&#127925; Muse Hub</span>
    <span class="breadcrumb">{% block breadcrumb %}{% endblock %}</span>
    <span style="flex:1"></span>
    <a href="/musehub/ui/explore" class="btn btn-secondary" style="font-size:12px">Explore</a>
    &nbsp;
    <a href="/musehub/ui/trending" class="btn btn-secondary" style="font-size:12px">Trending</a>
  </header>
  <div class="container" style="max-width:1200px">
    <div class="filter-bar">
      <div class="filter-group">
        <span class="filter-label">Genre</span>
        <input id="genre-inp" type="text" placeholder="jazz, lo-fi…" oninput="applyFilters()"/>
      </div>
      <div class="filter-group">
        <span class="filter-label">Key</span>
        <input id="key-inp" type="text" placeholder="F# minor" oninput="applyFilters()"/>
      </div>
      <div class="filter-group">
        <span class="filter-label">BPM min</span>
        <input id="tempo-min" type="number" min="20" max="300" placeholder="80" oninput="applyFilters()"/>
      </div>
      <div class="filter-group">
        <span class="filter-label">BPM max</span>
        <input id="tempo-max" type="number" min="20" max="300" placeholder="140" oninput="applyFilters()"/>
      </div>
      <div class="filter-group">
        <span class="filter-label">Instrument</span>
        <input id="instr-inp" type="text" placeholder="bass, drums…" oninput="applyFilters()"/>
      </div>
      <div class="filter-group">
        <span class="filter-label">Sort by</span>
        <select id="sort-sel" onchange="applyFilters()">
          <option value="created" {% if default_sort == 'created' %}selected{% endif %}>Newest</option>
          <option value="stars"   {% if default_sort == 'stars'   %}selected{% endif %}>Stars</option>
          <option value="activity"{% if default_sort == 'activity'%}selected{% endif %}>Activity</option>
          <option value="commits" {% if default_sort == 'commits' %}selected{% endif %}>Commits</option>
        </select>
      </div>
    </div>
    <input type="hidden" id="cur-page" value="1"/>
    <div id="repo-grid" class="repo-grid"><p class="loading">Loading&#8230;</p></div>
    <div id="pager"></div>
  </div>
  <script src="/musehub/static/musehub.js"></script>
  <script>
    const DISCOVER_API = '/api/v1/musehub/discover/repos';

    function escHtml(s) {
      if (!s) return '';
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function tagHtml(tag) {
      return '<span class="label">' + escHtml(tag) + '</span>';
    }

    function repoCard(r) {
      const tags = (r.tags || []).map(tagHtml).join('');
      const key  = r.keySignature ? escHtml(r.keySignature) : '';
      const bpm  = r.tempoBpm ? r.tempoBpm + ' BPM' : '';
      const meta = [key, bpm].filter(Boolean).join(' &bull; ');
      return `
        <div class="repo-card">
          <div class="repo-card-title">
            <a href="/musehub/ui/${escHtml(r.owner)}/${escHtml(r.slug)}">${escHtml(r.name)}</a>
          </div>
          <div class="repo-card-owner">${escHtml(r.ownerUserId)}</div>
          ${r.description ? '<div class="repo-card-desc">' + escHtml(r.description) + '</div>' : ''}
          <div class="repo-card-tags">${tags}</div>
          <div class="repo-card-meta">
            ${meta ? '<span>' + meta + '</span>' : ''}
            <span>&#9733; ${r.starCount}</span>
            <span>&#128190; ${r.commitCount} commits</span>
          </div>
        </div>`;
    }

    async function loadExplore(page, sort, genre, key, tempoMin, tempoMax, instrumentation) {
      const params = new URLSearchParams({ page: page, page_size: 24, sort: sort });
      if (genre)         params.set('genre', genre);
      if (key)           params.set('key', key);
      if (tempoMin)      params.set('tempo_min', tempoMin);
      if (tempoMax)      params.set('tempo_max', tempoMax);
      if (instrumentation) params.set('instrumentation', instrumentation);

      try {
        const res  = await fetch(DISCOVER_API + '?' + params.toString());
        if (!res.ok) throw new Error(res.status + ': ' + await res.text());
        const data = await res.json();
        const repos = data.repos || [];
        const total = data.total || 0;
        const pages = Math.ceil(total / 24) || 1;

        const grid = repos.length === 0
          ? '<p class="loading">No repos found matching these filters.</p>'
          : repos.map(repoCard).join('');

        const pager = pages > 1 ? `
          <div class="pager">
            ${page > 1 ? '<button class="btn btn-secondary" onclick="go(' + (page-1) + ')">&#8592; Prev</button>' : ''}
            <span style="color:#8b949e;font-size:13px">Page ${page} of ${pages} &bull; ${total} repos</span>
            ${page < pages ? '<button class="btn btn-secondary" onclick="go(' + (page+1) + ')">Next &#8594;</button>' : ''}
          </div>` : '<div class="pager" style="color:#8b949e;font-size:13px">' + total + ' repos</div>';

        document.getElementById('repo-grid').innerHTML = grid;
        document.getElementById('pager').innerHTML = pager;
      } catch(e) {
        document.getElementById('repo-grid').innerHTML =
          '<p class="error">&#10005; ' + escHtml(e.message) + '</p>';
      }
    }

    function currentState() {
      return {
        page: parseInt(document.getElementById('cur-page').value || '1'),
        sort: document.getElementById('sort-sel').value,
        genre: document.getElementById('genre-inp').value.trim(),
        key:   document.getElementById('key-inp').value.trim(),
        tempoMin: document.getElementById('tempo-min').value.trim(),
        tempoMax: document.getElementById('tempo-max').value.trim(),
        instr: document.getElementById('instr-inp').value.trim(),
      };
    }

    function go(page) {
      document.getElementById('cur-page').value = page;
      const s = currentState();
      loadExplore(page, s.sort, s.genre, s.key, s.tempoMin, s.tempoMax, s.instr);
    }

    function applyFilters() { go(1); }

    window.addEventListener('DOMContentLoaded', function() {
      const s = currentState();
      loadExplore(1, s.sort, s.genre, s.key, s.tempoMin, s.tempoMax, s.instr);
    });
  </script>
</body>
</html>
