{% extends "musehub/base.html" %}

{% block title %}Timeline{% endblock %}
{% block breadcrumb %}
  <a href="/musehub/ui/{{ owner }}/{{ repo_slug }}">{{ owner }}/{{ repo_slug }}</a> / timeline
{% endblock %}
{% block repo_nav %}{% include "musehub/partials/repo_nav.html" %}{% endblock %}

{% block extra_css %}
<style>
.timeline-toolbar {
  display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
  margin-bottom: 16px; padding: 12px 16px;
  background: #161b22; border: 1px solid #30363d; border-radius: 6px;
}
.layer-toggle {
  display: flex; align-items: center; gap: 6px; cursor: pointer;
  font-size: 13px; color: #c9d1d9; user-select: none;
}
.layer-toggle input[type=checkbox] { cursor: pointer; accent-color: #58a6ff; }
.zoom-select { display: flex; align-items: center; gap: 8px; margin-left: auto; }
#timeline-svg-container {
  overflow-x: auto; background: #0d1117;
  border: 1px solid #30363d; border-radius: 6px; padding: 0;
}
#timeline-svg { display: block; }
.scrubber-bar {
  height: 4px; background: #30363d; border-radius: 2px; margin: 12px 16px;
  cursor: pointer; position: relative;
}
.scrubber-thumb {
  width: 14px; height: 14px; background: #58a6ff; border-radius: 50%;
  position: absolute; top: -5px; transform: translateX(-50%);
  cursor: grab; box-shadow: 0 0 0 2px #0d1117;
}
.tooltip {
  position: fixed; background: #21262d; border: 1px solid #30363d;
  border-radius: 6px; padding: 8px 12px; font-size: 12px; color: #c9d1d9;
  pointer-events: none; z-index: 1000; max-width: 260px;
  display: none;
}
.audio-modal {
  position: fixed; inset: 0; background: rgba(0,0,0,.6);
  display: flex; align-items: center; justify-content: center; z-index: 2000;
}
.audio-modal-box {
  background: #161b22; border: 1px solid #30363d; border-radius: 8px;
  padding: 24px; min-width: 300px; max-width: 480px;
}
.audio-modal-box h3 { margin-bottom: 12px; color: #e6edf3; font-size: 15px; }
.audio-modal-box audio { width: 100%; margin-bottom: 12px; }
</style>
{% endblock %}

{% block body_extra %}
<div class="tooltip" id="tooltip"></div>
{% endblock %}

{% block page_data %}
const repoId = {{ repo_id | tojson }};
const base   = {{ base_url | tojson }};
const API_TL = '/api/v1/musehub/repos/' + repoId + '/timeline';
{% endblock %}

{% block page_script %}
{% raw %}
let tlData    = null;
let sessions  = [];
let mergedPRs = [];
let releases  = [];
let zoom      = 'all';
let layers    = { commits: true, emotion: true, sections: true, tracks: true, sessions: true, prs: true, releases: true };
let scrubPct  = 1.0;

const SVG_H      = 320;
const PAD_L      = 48;
const PAD_R      = 24;
const PAD_TOP    = 40;
const PAD_BOT    = 40;
const CHART_H    = SVG_H - PAD_TOP - PAD_BOT;
const COMMIT_Y   = PAD_TOP + CHART_H * 0.5;
const EMOTION_Y0 = PAD_TOP + CHART_H * 0.1;
const EMOTION_YH = CHART_H * 0.35;
const MARKER_Y   = PAD_TOP + CHART_H * 0.72;

/* Y positions for overlay event lanes — below section/track markers */
const SESSION_LINE_Y0 = PAD_TOP;
const SESSION_LINE_Y1 = SVG_H - PAD_BOT;
const PR_MARKER_Y     = PAD_TOP + CHART_H * 0.88;
const RELEASE_Y       = PAD_TOP + CHART_H * 0.88;

function msForZoom(z) {
  switch(z) {
    case 'day':   return 24 * 3600 * 1000;
    case 'week':  return 7  * 24 * 3600 * 1000;
    case 'month': return 30 * 24 * 3600 * 1000;
    default:      return Infinity;
  }
}

function visibleCommits() {
  if (!tlData || !tlData.commits || tlData.commits.length === 0) return [];
  const all = tlData.commits;
  const span = msForZoom(zoom);
  if (span === Infinity) return all;
  const newest = new Date(all[all.length - 1].timestamp).getTime();
  return all.filter(c => newest - new Date(c.timestamp).getTime() <= span);
}

function tsToX(ts, tMin, tMax, svgW) {
  if (tMax === tMin) return PAD_L + (svgW - PAD_L - PAD_R) / 2;
  return PAD_L + ((ts - tMin) / (tMax - tMin)) * (svgW - PAD_L - PAD_R);
}

/* Filter overlay events (sessions/PRs/releases) to the visible time window. */
function filterByWindow(events, dateField, tMin, tMax) {
  return events.filter(e => {
    const t = new Date(e[dateField]).getTime();
    return t >= tMin && t <= tMax;
  });
}

function renderTimeline() {
  const container = document.getElementById('timeline-svg-container');
  if (!tlData) { container.innerHTML = '<p class="loading" style="padding:16px">Loading&#8230;</p>'; return; }

  const vcs = visibleCommits();
  if (vcs.length === 0) {
    container.innerHTML = '<p class="loading" style="padding:16px">No commits in this zoom window.</p>';
    return;
  }

  const svgW = Math.max(container.clientWidth || 800, PAD_L + PAD_R + vcs.length * 28);
  const timestamps = vcs.map(c => new Date(c.timestamp).getTime());
  const tMin = Math.min(...timestamps);
  const tMax = Math.max(...timestamps);
  const visibleIds = new Set(vcs.map(c => c.commitId));

  let paths = '';
  let markers = '';
  let axisLabels = '';

  const labelCount = Math.min(6, vcs.length);
  for (let i = 0; i < labelCount; i++) {
    const idx = Math.round(i * (vcs.length - 1) / Math.max(1, labelCount - 1));
    const c = vcs[idx];
    const x = tsToX(new Date(c.timestamp).getTime(), tMin, tMax, svgW);
    const d = new Date(c.timestamp);
    const label = d.toLocaleDateString(undefined, { month:'short', day:'numeric' });
    axisLabels += `<text x="${x}" y="${SVG_H - 8}" text-anchor="middle"
      font-size="10" fill="#8b949e">${escHtml(label)}</text>`;
  }

  if (layers.emotion && tlData.emotion) {
    const visEmo = tlData.emotion.filter(e => visibleIds.has(e.commitId));
    const lineFor = (field, colour) => {
      if (visEmo.length < 2) return '';
      const pts = visEmo.map(e => {
        const x = tsToX(new Date(e.timestamp).getTime(), tMin, tMax, svgW);
        const y = EMOTION_Y0 + EMOTION_YH * (1 - e[field]);
        return x + ',' + y;
      }).join(' ');
      return `<polyline points="${pts}" fill="none" stroke="${colour}" stroke-width="1.5" opacity="0.8" />`;
    };
    paths += lineFor('valence', '#58a6ff');
    paths += lineFor('energy',  '#3fb950');
    paths += lineFor('tension', '#f78166');
    paths += `<text x="${PAD_L}" y="${EMOTION_Y0 - 6}" font-size="10" fill="#8b949e">Emotion</text>
      <circle cx="${PAD_L + 52}" cy="${EMOTION_Y0 - 8}" r="3" fill="#58a6ff"/>
      <text x="${PAD_L + 58}" y="${EMOTION_Y0 - 5}" font-size="9" fill="#58a6ff">valence</text>
      <circle cx="${PAD_L + 102}" cy="${EMOTION_Y0 - 8}" r="3" fill="#3fb950"/>
      <text x="${PAD_L + 108}" y="${EMOTION_Y0 - 5}" font-size="9" fill="#3fb950">energy</text>
      <circle cx="${PAD_L + 148}" cy="${EMOTION_Y0 - 8}" r="3" fill="#f78166"/>
      <text x="${PAD_L + 154}" y="${EMOTION_Y0 - 5}" font-size="9" fill="#f78166">tension</text>`;
  }

  if (layers.commits) {
    vcs.forEach(c => {
      const x = tsToX(new Date(c.timestamp).getTime(), tMin, tMax, svgW);
      const sha = c.commitId.substring(0, 8);
      const msg = escHtml((c.message || '').substring(0, 60));
      const author = escHtml(c.author || '');
      const ts = new Date(c.timestamp).toLocaleString();
      markers += `
        <g class="commit-marker" data-id="${c.commitId}"
           onclick="openAudioModal('${c.commitId}', '${sha}')"
           style="cursor:pointer"
           onmouseenter="showTip(event, '${sha}<br>${msg}<br>${author} &bull; ${ts}')"
           onmouseleave="hideTip()">
          <line x1="${x}" y1="${COMMIT_Y - 12}" x2="${x}" y2="${COMMIT_Y + 12}"
            stroke="#30363d" stroke-width="1" />
          <circle cx="${x}" cy="${COMMIT_Y}" r="6" fill="#58a6ff"
            stroke="#0d1117" stroke-width="2" />
        </g>`;
    });
    if (vcs.length > 1) {
      const x0 = tsToX(tMin, tMin, tMax, svgW);
      const x1 = tsToX(tMax, tMin, tMax, svgW);
      paths = `<line x1="${x0}" y1="${COMMIT_Y}" x2="${x1}" y2="${COMMIT_Y}"
        stroke="#30363d" stroke-width="1.5" />` + paths;
    }
  }

  if (layers.sections && tlData.sections) {
    const visSec = tlData.sections.filter(s => visibleIds.has(s.commitId));
    visSec.forEach(s => {
      const x = tsToX(new Date(s.timestamp).getTime(), tMin, tMax, svgW);
      const label = escHtml(s.sectionName);
      const action = s.action === 'removed' ? '−' : '+';
      const colour = s.action === 'removed' ? '#f78166' : '#3fb950';
      markers += `
        <g onmouseenter="showTip(event, '${action} ${label} section')" onmouseleave="hideTip()">
          <rect x="${x - 5}" y="${MARKER_Y - 10}" width="10" height="10"
            fill="${colour}" rx="2" opacity="0.9"/>
          <text x="${x}" y="${MARKER_Y + 16}" text-anchor="middle"
            font-size="9" fill="${colour}">${label}</text>
        </g>`;
    });
  }

  if (layers.tracks && tlData.tracks) {
    const visTrk = tlData.tracks.filter(t => visibleIds.has(t.commitId));
    visTrk.forEach((t, i) => {
      const x = tsToX(new Date(t.timestamp).getTime(), tMin, tMax, svgW);
      const label = escHtml(t.trackName);
      const action = t.action === 'removed' ? '−' : '+';
      const colour = t.action === 'removed' ? '#e3b341' : '#a371f7';
      const yOff = MARKER_Y + 32 + (i % 2) * 14;
      markers += `
        <g onmouseenter="showTip(event, '${action} ${label} track')" onmouseleave="hideTip()">
          <circle cx="${x}" cy="${yOff}" r="4" fill="${colour}" opacity="0.85"/>
          <text x="${x + 6}" y="${yOff + 4}" font-size="9" fill="${colour}">${label}</text>
        </g>`;
    });
  }

  /* Session markers — vertical dashed teal lines spanning the full chart height. */
  if (layers.sessions && sessions.length > 0) {
    const visSessions = filterByWindow(sessions, 'startedAt', tMin, tMax);
    visSessions.forEach(s => {
      const x = tsToX(new Date(s.startedAt).getTime(), tMin, tMax, svgW);
      const intent = escHtml((s.intent || 'session').substring(0, 50));
      const pList  = (s.participants || []).map(p => escHtml(p)).join(', ') || 'no participants';
      const ts     = new Date(s.startedAt).toLocaleString();
      markers += `
        <g onmouseenter="showTip(event, 'Session: ${intent}<br>${pList}<br>${ts}')"
           onmouseleave="hideTip()">
          <line x1="${x}" y1="${SESSION_LINE_Y0}" x2="${x}" y2="${SESSION_LINE_Y1}"
            stroke="#2dd4bf" stroke-width="1.5" stroke-dasharray="4 3" opacity="0.7"/>
          <circle cx="${x}" cy="${SESSION_LINE_Y0 + 6}" r="4" fill="#2dd4bf" opacity="0.9"/>
        </g>`;
    });
  }

  /* PR merge markers — vertical solid purple line with triangle cap.
     Positioned at mergedAt when available (added in #349); falls back to createdAt
     for any legacy PRs that pre-date the merged_at column. */
  if (layers.prs && mergedPRs.length > 0) {
    const visPRs = filterByWindow(mergedPRs, 'createdAt', tMin, tMax);
    visPRs.forEach(pr => {
      const mergeTs = pr.mergedAt ? new Date(pr.mergedAt).getTime() : new Date(pr.createdAt).getTime();
      const x     = tsToX(mergeTs, tMin, tMax, svgW);
      const title = escHtml((pr.title || 'PR').substring(0, 50));
      const ts    = pr.mergedAt ? new Date(pr.mergedAt).toLocaleString() : new Date(pr.createdAt).toLocaleString();
      /* Triangle marker pointing down at PR_MARKER_Y */
      const ty = PR_MARKER_Y;
      markers += `
        <g onmouseenter="showTip(event, 'PR merge: ${title}<br>${ts}')"
           onmouseleave="hideTip()">
          <line x1="${x}" y1="${PAD_TOP}" x2="${x}" y2="${ty}"
            stroke="#a371f7" stroke-width="1.5" opacity="0.7"/>
          <polygon points="${x},${ty + 8} ${x - 5},${ty - 2} ${x + 5},${ty - 2}"
            fill="#a371f7" opacity="0.9"/>
        </g>`;
    });
  }

  /* Release markers — gold diamond at RELEASE_Y. */
  if (layers.releases && releases.length > 0) {
    const visReleases = filterByWindow(releases, 'createdAt', tMin, tMax);
    visReleases.forEach(rel => {
      const x   = tsToX(new Date(rel.createdAt).getTime(), tMin, tMax, svgW);
      const tag = escHtml((rel.tag || '').substring(0, 20));
      const ts  = new Date(rel.createdAt).toLocaleString();
      const ry  = RELEASE_Y - 28;  /* position diamonds above PR triangles */
      /* Diamond: four points around centre */
      markers += `
        <g onmouseenter="showTip(event, 'Release: ${tag}<br>${ts}')"
           onmouseleave="hideTip()">
          <polygon points="${x},${ry - 7} ${x + 5},${ry} ${x},${ry + 7} ${x - 5},${ry}"
            fill="#e3b341" stroke="#0d1117" stroke-width="1" opacity="0.95"/>
          <text x="${x}" y="${ry + 18}" text-anchor="middle"
            font-size="9" fill="#e3b341">${tag}</text>
        </g>`;
    });
  }

  container.innerHTML = `
    <svg id="timeline-svg" width="${svgW}" height="${SVG_H}" xmlns="http://www.w3.org/2000/svg">
      <rect width="${svgW}" height="${SVG_H}" fill="#0d1117"/>
      ${paths}
      ${markers}
      ${axisLabels}
    </svg>`;

  const thumb = document.getElementById('scrubber-thumb');
  if (thumb) thumb.style.left = (scrubPct * 100) + '%';
}

const tip = document.getElementById('tooltip');
function showTip(evt, html) {
  tip.innerHTML = html;
  tip.style.display = 'block';
  tip.style.left = (evt.clientX + 12) + 'px';
  tip.style.top  = (evt.clientY - 8) + 'px';
}
function hideTip() { tip.style.display = 'none'; }

function openAudioModal(commitId, sha) {
  const existing = document.getElementById('audio-modal');
  if (existing) existing.remove();
  const modal = document.createElement('div');
  modal.id = 'audio-modal';
  modal.className = 'audio-modal';
  modal.innerHTML = `
    <div class="audio-modal-box">
      <h3>&#9654; Preview at commit ${sha}</h3>
      <p style="font-size:12px;color:#8b949e;margin-bottom:12px">Audio artifacts from this commit state.</p>
      <audio controls>
        <source src="/api/v1/musehub/repos/${repoId}/commits/${commitId}/audio" type="audio/mpeg">
        No audio available for this commit.
      </audio>
      <div style="text-align:right;margin-top:8px">
        <a href="${base}/commits/${commitId}" class="btn btn-secondary" style="font-size:12px">View commit</a>
        &nbsp;
        <button class="btn btn-secondary" onclick="document.getElementById('audio-modal').remove()" style="font-size:12px">Close</button>
      </div>
    </div>`;
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
  document.body.appendChild(modal);
}

function initScrubber() {
  const bar = document.getElementById('scrubber-bar');
  if (!bar) return;
  let dragging = false;
  function updateFromEvent(e) {
    const rect = bar.getBoundingClientRect();
    const pct  = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
    scrubPct = pct;
    const thumb = document.getElementById('scrubber-thumb');
    if (thumb) thumb.style.left = (pct * 100) + '%';
  }
  bar.addEventListener('mousedown', e => { dragging = true; updateFromEvent(e); });
  document.addEventListener('mousemove', e => { if (dragging) updateFromEvent(e); });
  document.addEventListener('mouseup', () => { dragging = false; });
}

function toggleLayer(name, checked) {
  layers[name] = checked;
  renderTimeline();
}

function setZoom(z) {
  zoom = z;
  document.querySelectorAll('.zoom-btn').forEach(b => {
    b.style.background = b.dataset.zoom === z ? '#1f6feb' : '#21262d';
  });
  renderTimeline();
}

/* Fetch overlay data for sessions, merged PRs, and releases in parallel. */
async function loadOverlays() {
  const [sessData, prData, relData] = await Promise.allSettled([
    apiFetch('/repos/' + repoId + '/sessions?limit=200'),
    apiFetch('/repos/' + repoId + '/pull-requests?state=merged'),
    apiFetch('/repos/' + repoId + '/releases'),
  ]);

  if (sessData.status === 'fulfilled' && sessData.value && sessData.value.sessions) {
    sessions = sessData.value.sessions;
  }
  if (prData.status === 'fulfilled' && prData.value && prData.value.pullRequests) {
    mergedPRs = prData.value.pullRequests;
  }
  if (relData.status === 'fulfilled' && relData.value && relData.value.releases) {
    releases = relData.value.releases;
  }
}

async function load() {
  initRepoNav(repoId);
  try {
    const [data] = await Promise.all([
      apiFetch('/repos/' + repoId + '/timeline?limit=200'),
      loadOverlays(),
    ]);
    tlData = data;

    const total = data.totalCommits || 0;
    document.getElementById('content').innerHTML = `
      <div style="margin-bottom:12px;display:flex;align-items:center;gap:12px">
        <a href="${base}">&larr; Back to repo</a>
        <span style="color:#8b949e;font-size:13px">${total} commit${total !== 1 ? 's' : ''}</span>
      </div>

      <div class="timeline-toolbar">
        <label class="layer-toggle">
          <input type="checkbox" checked onchange="toggleLayer('commits', this.checked)"> Commits
        </label>
        <label class="layer-toggle">
          <input type="checkbox" checked onchange="toggleLayer('emotion', this.checked)"> Emotion
        </label>
        <label class="layer-toggle">
          <input type="checkbox" checked onchange="toggleLayer('sections', this.checked)"> Sections
        </label>
        <label class="layer-toggle">
          <input type="checkbox" checked onchange="toggleLayer('tracks', this.checked)"> Tracks
        </label>
        <label class="layer-toggle" title="Recording sessions (teal dashed lines)">
          <input type="checkbox" checked onchange="toggleLayer('sessions', this.checked)"
            style="accent-color:#2dd4bf"> Sessions
        </label>
        <label class="layer-toggle" title="Merged pull requests (purple triangles)">
          <input type="checkbox" checked onchange="toggleLayer('prs', this.checked)"
            style="accent-color:#a371f7"> PRs
        </label>
        <label class="layer-toggle" title="Releases (gold diamonds)">
          <input type="checkbox" checked onchange="toggleLayer('releases', this.checked)"
            style="accent-color:#e3b341"> Releases
        </label>
        <div class="zoom-select">
          <span style="font-size:12px;color:#8b949e">Zoom:</span>
          <button class="btn zoom-btn" data-zoom="day" onclick="setZoom('day')" style="font-size:11px;padding:3px 10px;background:#21262d">Day</button>
          <button class="btn zoom-btn" data-zoom="week" onclick="setZoom('week')" style="font-size:11px;padding:3px 10px;background:#21262d">Week</button>
          <button class="btn zoom-btn" data-zoom="month" onclick="setZoom('month')" style="font-size:11px;padding:3px 10px;background:#21262d">Month</button>
          <button class="btn zoom-btn" data-zoom="all" onclick="setZoom('all')" style="font-size:11px;padding:3px 10px;background:#1f6feb">All</button>
        </div>
      </div>

      <div id="timeline-svg-container"></div>

      <div class="scrubber-bar" id="scrubber-bar">
        <div class="scrubber-thumb" id="scrubber-thumb" style="left:100%"></div>
      </div>

      <div style="display:flex;gap:24px;flex-wrap:wrap;margin-top:12px;font-size:12px;color:#8b949e">
        <span>&#9679; <span style="color:#58a6ff">blue</span> = commit (click to preview)</span>
        <span>&#9632; <span style="color:#3fb950">green</span> = section added</span>
        <span>&#9632; <span style="color:#f78166">red</span> = section removed</span>
        <span>&#9679; <span style="color:#a371f7">purple</span> = track added</span>
        <span>&#9679; <span style="color:#e3b341">yellow</span> = track removed</span>
        <span>&#9135; <span style="color:#2dd4bf">teal dashed</span> = session start</span>
        <span><span style="color:#a371f7">&#9660; purple</span> = PR merge</span>
        <span>&#9670; <span style="color:#e3b341">gold</span> = release</span>
      </div>`;

    initScrubber();
    renderTimeline();
  } catch(e) {
    if (e.message !== 'auth')
      document.getElementById('content').innerHTML = '<p class="error">&#10005; ' + escHtml(e.message) + '</p>';
  }
}

load();
{% endraw %}
{% endblock %}
