{% extends "musehub/base.html" %}

{% block title %}{{ owner }}/{{ repo_slug }}{% endblock %}
{% block breadcrumb %}<a href="/musehub/ui/{{ owner }}/{{ repo_slug }}">{{ owner }}/{{ repo_slug }}</a>{% endblock %}

{% block page_data %}
const repoId = {{ repo_id | tojson }};
const base = {{ base_url | tojson }};
{% endblock %}

{% block page_script %}
{% raw %}
function escHtml(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

async function load(branch) {
  try {
    const [repoData, branchData, commitData, sessionData] = await Promise.all([
      apiFetch('/repos/' + repoId),
      apiFetch('/repos/' + repoId + '/branches'),
      apiFetch('/repos/' + repoId + '/commits' + (branch ? '?branch=' + encodeURIComponent(branch) + '&limit=20' : '?limit=20')),
      apiFetch('/repos/' + repoId + '/sessions?limit=1').catch(() => ({total: 0})),
    ]);

    const branches = branchData.branches || [];
    const commits  = commitData.commits  || [];

    const branchSel = branches.map(b =>
      '<option value="' + b.name + '"' + (b.name === branch ? ' selected' : '') + '>' + b.name + '</option>'
    ).join('');

    const commitRows = commits.length === 0
      ? '<p class="loading">No commits yet.</p>'
      : commits.map(c => `
        <div class="commit-row">
          <a class="commit-sha" href="${base}/commits/${c.commitId}">${shortSha(c.commitId)}</a>
          <span class="commit-msg"><a href="${base}/commits/${c.commitId}">${escHtml(c.message)}</a></span>
          <span class="commit-meta">${escHtml(c.author)} &bull; ${fmtDate(c.timestamp)}</span>
        </div>`).join('');

    document.getElementById('content').innerHTML = `
      <div class="card">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
          <h1 style="margin:0">${escHtml(repoData.name)}</h1>
          <span class="badge badge-${repoData.visibility}">${repoData.visibility}</span>
        </div>
        <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap">
          <a href="${base}/pulls" class="btn btn-secondary">Pull Requests</a>
          <a href="${base}/issues" class="btn btn-secondary">Issues</a>
          <a href="${base}/releases" class="btn btn-secondary">Releases</a>
          <a href="${base}/credits" class="btn btn-secondary">&#127926; Credits</a>
          <a href="${base}/sessions" class="btn btn-secondary">
            Sessions (${sessionData.total || 0})
          </a>
          <a href="${base}/search" class="btn btn-secondary">&#128269; Search</a>
        </div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
          <select id="branch-sel" onchange="load(this.value)">
            <option value="">All branches</option>
            ${branchSel}
          </select>
          <span class="meta-value" style="font-size:13px;color:#8b949e">
            ${commitData.total} commit${commitData.total !== 1 ? 's' : ''}
          </span>
        </div>
        ${commitRows}
      </div>`;
  } catch(e) {
    if (e.message !== 'auth')
      document.getElementById('content').innerHTML = '<p class="error">&#10005; ' + escHtml(e.message) + '</p>';
  }
}

load('');
{% endraw %}
{% endblock %}
