{% extends "musehub/base.html" %}
{% block title %}{{ owner }}/{{ repo_slug }}{% endblock %}
{% block breadcrumb %}<a href="/musehub/ui/{{ owner }}">{{ owner }}</a> / <a href="{{ base_url }}">{{ repo_slug }}</a>{% endblock %}

{% block repo_nav %}
{% include "musehub/partials/repo_nav.html" %}
{% endblock %}

{# Use the wide container so the two-column layout has room to breathe #}
{% block container_extra_class %}-wide{% endblock %}

{% block page_data %}
const repoId = {{ repo_id | tojson }};
const base   = {{ base_url | tojson }};

/* Render the two-column layout shell immediately — async loaders fill in each
   section independently so the page feels fast and progressive. */
document.getElementById('content').innerHTML = `
  <div class="repo-layout">

    <!-- ── Main column ── -->
    <main class="repo-main">
      <div id="commit-area"><p class="loading">Loading commits\u2026</p></div>
    </main>

    <!-- ── Right sidebar ── -->
    <aside class="repo-sidebar">

      <!-- Star / Watch / Fork -->
      <div class="repo-action-strip" id="action-strip">
        <button class="repo-action-btn" onclick="toggleStar()" id="action-star-btn"
                title="Star this repo">
          &#9733; Star
          <span class="repo-action-count" id="action-star-count">0</span>
        </button>
        <button class="repo-action-btn" onclick="toggleWatch()" id="action-watch-btn"
                title="Watch this repo">
          &#128065; Watch
          <span class="repo-action-count" id="action-watch-count">0</span>
        </button>
        <button class="repo-action-btn" onclick="forkRepo()" id="action-fork-btn"
                title="Fork this repo">
          &#9902; Fork
          <span class="repo-action-count" id="action-fork-count">0</span>
        </button>
      </div>

      <!-- About -->
      <div class="sidebar-section" id="about-section">
        <h3>About</h3>
        <p class="about-description text-muted">Loading\u2026</p>
      </div>

      <!-- Contributors -->
      <div class="sidebar-section" id="contributors-section" style="display:none"></div>

      <!-- Instrument / track breakdown bar -->
      <div class="sidebar-section" id="instruments-section" style="display:none"></div>

      <!-- Emotion Arc mini -->
      <div class="sidebar-section" id="emotion-arc" style="display:none"></div>

      <!-- Analytics: view count + sparkline + open issues/PRs -->
      <div class="sidebar-section" id="analytics-section" style="display:none"></div>

      <!-- Similar repos -->
      <div class="sidebar-section" id="similar-section" style="display:none"></div>

    </aside>
  </div>
`;
{% endblock %}

{% block page_script %}
{% raw %}

/* ═══════════════════════════════════════════════════════
 * Instrument colour palette (music-domain language bar)
 * ═══════════════════════════════════════════════════════ */
const INSTRUMENT_COLORS = {
  bass:        '#f778ba',
  keys:        '#a97bff',
  piano:       '#a97bff',
  rhodes:      '#a97bff',
  drums:       '#e8d44d',
  percussion:  '#e8d44d',
  strings:     '#58a6ff',
  violin:      '#58a6ff',
  cello:       '#4facfe',
  horns:       '#f0883e',
  brass:       '#f0883e',
  trumpet:     '#f0883e',
  guitar:      '#3fb950',
  saxophone:   '#bc8cff',
  sax:         '#bc8cff',
  vocals:      '#ff7b72',
  voice:       '#ff7b72',
  synth:       '#79c0ff',
  pad:         '#79c0ff',
};

function instrumentColor(name) {
  const n = (name || '').toLowerCase();
  for (const [key, col] of Object.entries(INSTRUMENT_COLORS)) {
    if (n.includes(key)) return col;
  }
  /* deterministic colour from hash for unlisted roles */
  const hue = [...n].reduce((h, ch) => (h * 31 + ch.charCodeAt(0)) % 360, 0);
  return `hsl(${hue}, 60%, 55%)`;
}

/* ═══════════════════════════════════════════════════════
 * Author avatar helpers
 * ═══════════════════════════════════════════════════════ */
function authorInitials(name) {
  return (name || '?').slice(0, 2).toUpperCase();
}

function authorColor(name) {
  const hue = [...(name || '')].reduce((h, ch) => (h * 31 + ch.charCodeAt(0)) % 360, 0);
  return `hsl(${hue}, 50%, 38%)`;
}

/* ═══════════════════════════════════════════════════════
 * Sidebar: About
 * ═══════════════════════════════════════════════════════ */
async function loadAbout() {
  try {
    const repo = await apiFetch('/repos/' + repoId);
    const el = document.getElementById('about-section');
    if (!el) return;

    const desc = repo.description
      ? `<p class="about-description">${escHtml(repo.description)}</p>`
      : '<p class="about-description text-muted" style="font-style:italic">No description yet.</p>';

    const keyPill = repo.keySignature
      ? `<span class="nav-meta-pill">&#9837; ${escHtml(repo.keySignature)}</span>` : '';
    const bpmPill = repo.tempoBpm
      ? `<span class="nav-meta-pill">&#9834; ${repo.tempoBpm} BPM</span>` : '';
    const tagHtml = (repo.tags || [])
      .map(t => `<span class="nav-meta-tag">${escHtml(t)}</span>`).join('');
    const pills = (keyPill || bpmPill || tagHtml)
      ? `<div style="display:flex;flex-wrap:wrap;gap:var(--space-1);margin-bottom:var(--space-3)">${keyPill}${bpmPill}${tagHtml}</div>`
      : '';

    const lastCommit = repo.lastCommitAt
      ? `<div class="about-stat-row">&#128260; Last commit <strong>${fmtRelative(repo.lastCommitAt)}</strong></div>`
      : '';

    el.innerHTML = `
      <h3>About
        <a href="${base}/insights" class="text-xs text-muted" style="font-weight:400;margin-left:auto">
          Insights &rarr;
        </a>
      </h3>
      ${desc}
      ${pills}
      ${lastCommit}
      <div class="about-stat-row">&#128197; Created ${fmtRelative(repo.createdAt)}</div>
    `;

    /* Update the action strip star / fork counts */
    const sc = document.getElementById('action-star-count');
    if (sc) sc.textContent = repo.starCount || 0;
    const fc = document.getElementById('action-fork-count');
    if (fc) fc.textContent = repo.forkCount || 0;

  } catch(e) { /* non-critical */ }
}

/* ═══════════════════════════════════════════════════════
 * Sidebar: Watch count
 * ═══════════════════════════════════════════════════════ */
async function loadWatchCount() {
  try {
    const data = await apiFetch('/social/repos/' + repoId + '/watches');
    const wc = document.getElementById('action-watch-count');
    if (wc) wc.textContent = data.watch_count || 0;
    const btn = document.getElementById('action-watch-btn');
    if (btn && data.watching) btn.classList.add('active');
  } catch(e) { /* non-critical */ }
}

/* ═══════════════════════════════════════════════════════
 * Sidebar: Contributors
 * ═══════════════════════════════════════════════════════ */
async function loadContributors() {
  try {
    const data  = await apiFetch('/repos/' + repoId + '/credits');
    const credits = data.credits || data;
    if (!Array.isArray(credits) || !credits.length) return;

    const el = document.getElementById('contributors-section');
    if (!el) return;

    const MAX_SHOWN = 14;
    const avatars = credits.slice(0, MAX_SHOWN).map(c => {
      const name = c.name || c.userId || c.contributor || '?';
      return `<a href="/musehub/ui/${encodeURIComponent(name)}"
                 class="contributor-avatar"
                 title="${escHtml(name)}"
                 style="background:${authorColor(name)}">${escHtml(authorInitials(name))}</a>`;
    }).join('');

    const more = credits.length > MAX_SHOWN
      ? `<div class="text-xs text-muted" style="margin-top:var(--space-2)">
           +${credits.length - MAX_SHOWN} more &middot;
           <a href="${base}/credits">View all</a>
         </div>`
      : '';

    el.innerHTML = `
      <h3>Contributors
        <span class="text-muted" style="font-weight:400">${credits.length}</span>
      </h3>
      <div class="contributor-grid">${avatars}</div>
      ${more}
    `;
    el.style.display = '';
  } catch(e) { /* non-critical */ }
}

/* ═══════════════════════════════════════════════════════
 * Sidebar: Instrument breakdown bar
 * ═══════════════════════════════════════════════════════ */
async function loadInstrumentBar() {
  try {
    const data    = await apiFetch('/repos/' + repoId + '/commits?limit=1');
    const commits = data.commits || [];
    if (!commits.length) return;

    const objData = await apiFetch(
      '/repos/' + repoId + '/objects?ref=' + encodeURIComponent(commits[0].commitId)
    );
    const objects = objData.objects || [];
    if (!objects.length) return;

    /* Count tracks by role */
    const counts = {};
    objects.forEach(o => {
      const role = o.role || o.track || 'other';
      counts[role] = (counts[role] || 0) + 1;
    });

    const total   = objects.length;
    const entries = Object.entries(counts).sort((a, b) => b[1] - a[1]);

    const barSegments = entries.map(([role, count]) => {
      const pct   = (count / total * 100).toFixed(1);
      const color = instrumentColor(role);
      return `<div class="instrument-segment" title="${escHtml(role)} ${pct}%"
                   style="width:${pct}%;background:${color}"></div>`;
    }).join('');

    const legend = entries.map(([role, count]) => {
      const pct   = (count / total * 100).toFixed(0);
      const color = instrumentColor(role);
      return `<div class="instrument-legend-item">
        <span class="instrument-dot" style="background:${color}"></span>
        <span>${escHtml(role)}</span>
        <span class="text-muted">${pct}%</span>
      </div>`;
    }).join('');

    const el = document.getElementById('instruments-section');
    if (!el) return;

    el.innerHTML = `
      <h3>Tracks
        <a href="${base}/commits/${commits[0].commitId}" class="text-xs text-muted" style="font-weight:400">
          latest commit
        </a>
      </h3>
      <div class="instrument-bar">${barSegments}</div>
      <div class="instrument-legend">${legend}</div>
    `;
    el.style.display = '';
  } catch(e) { /* non-critical */ }
}

/* ═══════════════════════════════════════════════════════
 * Sidebar: Emotion arc mini
 * ═══════════════════════════════════════════════════════ */
async function loadEmotionArc() {
  try {
    const data     = await apiFetch('/repos/' + repoId + '/timeline?limit=100');
    const emotions = data.emotion || [];
    if (emotions.length < 2) return;

    const arcEl = document.getElementById('emotion-arc');
    if (!arcEl) return;

    const W = 260, H = 52, pad = 6;

    function buildLine(vals, color) {
      if (vals.length < 2) return '';
      const xStep  = (W - pad * 2) / (vals.length - 1);
      const points = vals
        .map((v, i) => `${pad + i * xStep},${H - pad - v * (H - pad * 2)}`)
        .join(' ');
      return `<polyline points="${points}" fill="none" stroke="${color}" stroke-width="1.5" opacity="0.8"/>`;
    }

    arcEl.innerHTML = `
      <h3>Emotion Arc
        <a href="${base}/timeline" class="text-xs text-muted" style="font-weight:400;margin-left:auto">
          Full &rarr;
        </a>
      </h3>
      <svg viewBox="0 0 ${W} ${H}" style="width:100%;height:${H}px;display:block;margin-bottom:var(--space-2)">
        ${buildLine(emotions.map(e => e.valence || 0.5), 'var(--color-success)')}
        ${buildLine(emotions.map(e => e.energy  || 0.5), 'var(--color-danger)')}
        ${buildLine(emotions.map(e => e.tension || 0.5), 'var(--color-purple)')}
      </svg>
      <div style="display:flex;gap:var(--space-3)">
        <span class="text-xs text-muted"><span style="color:var(--color-success)">—</span> Valence</span>
        <span class="text-xs text-muted"><span style="color:var(--color-danger)">—</span> Energy</span>
        <span class="text-xs text-muted"><span style="color:var(--color-purple)">—</span> Tension</span>
      </div>
    `;
    arcEl.style.display = '';
  } catch(e) { /* non-critical */ }
}

/* ═══════════════════════════════════════════════════════
 * Sidebar: Similar repos
 * ═══════════════════════════════════════════════════════ */
async function loadSimilar() {
  try {
    const data  = await apiFetch('/search/repos/similar?repo_id=' + repoId + '&limit=5');
    const repos = (data.results || []).filter(r => r.repoId !== repoId);
    if (!repos.length) return;

    const el = document.getElementById('similar-section');
    if (!el) return;

    el.innerHTML = `
      <h3>Similar repos</h3>
      ${repos.map(r => `
        <div style="display:flex;align-items:center;gap:var(--space-2);padding:var(--space-2) 0;
                    border-bottom:1px solid var(--border-subtle)">
          <div style="min-width:0;flex:1">
            <a href="/musehub/ui/${escHtml(r.owner)}/${escHtml(r.slug)}" class="text-sm text-primary">
              ${escHtml(r.owner)}/${escHtml(r.slug)}
            </a>
            ${r.keySignature || r.tempoBpm ? `
            <div class="text-xs text-muted" style="margin-top:2px">
              ${r.keySignature ? '&#9837; ' + escHtml(r.keySignature) : ''}
              ${r.keySignature && r.tempoBpm ? '&middot;' : ''}
              ${r.tempoBpm ? r.tempoBpm + ' BPM' : ''}
            </div>` : ''}
          </div>
        </div>`).join('')}
    `;
    el.style.display = '';
  } catch(e) { /* non-critical */ }
}

/* ═══════════════════════════════════════════════════════
 * Action strip handlers
 * ═══════════════════════════════════════════════════════ */
async function toggleWatch() {
  try {
    const btn = document.getElementById('action-watch-btn');
    const watching = btn && btn.classList.contains('active');
    if (watching) {
      await apiFetch('/social/repos/' + repoId + '/watches', { method: 'DELETE' });
      if (btn) btn.classList.remove('active');
    } else {
      const data = await apiFetch('/social/repos/' + repoId + '/watches', { method: 'POST' });
      if (btn) btn.classList.add('active');
      const wc = document.getElementById('action-watch-count');
      if (wc && data.watch_count != null) wc.textContent = data.watch_count;
    }
  } catch(e) { if (e.message !== 'auth') alert('Could not update watch: ' + e.message); }
}

async function forkRepo() {
  if (!getToken()) { showTokenForm('Sign in to fork repos.'); return; }
  if (!confirm('Fork this repo to your account?')) return;
  try {
    const data = await apiFetch('/social/repos/' + repoId + '/forks', { method: 'POST' });
    if (data.fork_repo_id) {
      window.location.href = '/musehub/ui/' + encodeURIComponent(data.forked_by) + '/' + data.fork_repo_id;
    }
  } catch(e) { if (e.message !== 'auth') alert('Fork failed: ' + e.message); }
}

/* ═══════════════════════════════════════════════════════
 * Main column: commit list
 * ═══════════════════════════════════════════════════════ */
async function loadCommits(branch) {
  initRepoNav(repoId);
  try {
    const qs = branch
      ? '?branch=' + encodeURIComponent(branch) + '&limit=20'
      : '?limit=20';

    const [branchData, commitData, sessionData] = await Promise.all([
      apiFetch('/repos/' + repoId + '/branches'),
      apiFetch('/repos/' + repoId + '/commits' + qs),
      apiFetch('/repos/' + repoId + '/sessions?limit=1').catch(() => ({ total: 0 })),
    ]);

    const branches = branchData.branches || [];
    const commits  = commitData.commits  || [];

    /* Branch selector */
    const branchSel = branches.map(b =>
      `<option value="${escHtml(b.name)}"${b.name === branch ? ' selected' : ''}>${escHtml(b.name)}</option>`
    ).join('');

    /* Latest commit banner (imitates GitHub's "latest commit" row above the file tree) */
    let bannerHtml = '';
    if (commits.length > 0) {
      const lc     = commits[0];
      const parsed = parseCommitMessage(lc.message);
      bannerHtml = `
        <div class="latest-commit-banner">
          <span class="commit-avatar" style="background:${authorColor(lc.author)}">${escHtml(authorInitials(lc.author))}</span>
          <strong class="text-primary" style="flex-shrink:0">${escHtml(lc.author)}</strong>
          <span class="truncate" style="flex:1;min-width:0;color:var(--text-secondary)">
            ${escHtml(parsed.subject || lc.message)}
          </span>
          <a class="text-mono text-xs text-muted" href="${base}/commits/${lc.commitId}"
             style="flex-shrink:0;margin-left:var(--space-2)">${shortSha(lc.commitId)}</a>
          <span class="text-xs text-muted" style="flex-shrink:0">${fmtRelative(lc.timestamp)}</span>
        </div>`;
    }

    /* Commit rows */
    const commitRows = commits.length === 0
      ? `<div class="empty-state">
           <div class="empty-icon">&#127925;</div>
           <p class="empty-title">No commits yet</p>
           <p class="empty-desc">Push your first session with <code>muse push</code> to get started.</p>
         </div>`
      : commits.map(c => {
          const parsed     = parseCommitMessage(c.message);
          const typeBadge  = commitTypeBadge(parsed.type);
          const scopeBadge = commitScopeBadge(parsed.scope);
          return `
          <div class="commit-row">
            <a class="commit-sha" href="${base}/commits/${c.commitId}">${shortSha(c.commitId)}</a>
            <span class="commit-msg">
              <a href="${base}/commits/${c.commitId}">
                ${typeBadge}${scopeBadge}${escHtml(parsed.subject || c.message)}
              </a>
            </span>
            <span class="commit-meta">
              <span class="commit-avatar" style="background:${authorColor(c.author)};width:16px;height:16px;font-size:8px">${escHtml(authorInitials(c.author))}</span>
              ${escHtml(c.author)} &middot; ${fmtRelative(c.timestamp)}
            </span>
          </div>`;
        }).join('');

    /* Toolbar */
    const liveSession = sessionData.total > 0
      ? `<span class="badge badge-active" style="margin-left:var(--space-2)">&#128308; Live</span>` : '';

    const toolbar = `
      <div style="display:flex;align-items:center;gap:var(--space-3);margin-bottom:0;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:var(--space-2)">
          <select onchange="loadCommits(this.value)" class="form-select" style="width:auto;font-size:13px">
            <option value="">All branches</option>
            ${branchSel}
          </select>
          <span class="text-muted text-sm">
            ${commitData.total} commit${commitData.total !== 1 ? 's' : ''}
          </span>
          ${liveSession}
        </div>
        <div style="margin-left:auto;display:flex;gap:var(--space-2)">
          <a href="${base}/graph"    class="btn btn-secondary btn-sm">&#9912; Graph</a>
          <a href="${base}/timeline" class="btn btn-secondary btn-sm">&#8987; Timeline</a>
          <a href="${base}/insights" class="btn btn-secondary btn-sm">&#128200; Insights</a>
        </div>
      </div>`;

    /* Card: flush banner on top, list below */
    const cardStyle = commits.length > 0
      ? 'border-radius:0 0 var(--radius-base) var(--radius-base);border-top:none;padding-top:var(--space-2)'
      : '';

    document.getElementById('commit-area').innerHTML = `
      ${toolbar}
      <div style="margin-top:var(--space-3)">
        ${bannerHtml}
        <div class="card" style="${cardStyle}">
          <div class="commit-list">${commitRows}</div>
          ${commitData.total > 20 ? `
          <div style="padding-top:var(--space-4);text-align:center;border-top:1px solid var(--border-subtle)">
            <a href="${base}/search" class="btn btn-secondary btn-sm">
              View all ${commitData.total} commits &rarr;
            </a>
          </div>` : ''}
        </div>
      </div>
    `;

  } catch(e) {
    if (e.message !== 'auth')
      document.getElementById('commit-area').innerHTML =
        `<p class="error">&#10005; ${escHtml(e.message)}</p>`;
  }
}

/* ═══════════════════════════════════════════════════════
 * Sidebar: Analytics — view count sparkline + open issues/PRs
 * ═══════════════════════════════════════════════════════ */
async function loadAnalytics() {
  try {
    const el = document.getElementById('analytics-section');
    if (!el) return;

    const [summary, viewDays, issuesData, prsData] = await Promise.all([
      apiFetch('/social/repos/' + repoId + '/analytics'),
      apiFetch('/social/repos/' + repoId + '/analytics/views?days=7').catch(() => []),
      apiFetch('/repos/' + repoId + '/issues?state=open').catch(() => ({ issues: [] })),
      apiFetch('/repos/' + repoId + '/pull-requests?state=open').catch(() => ({ pull_requests: [] })),
    ]);

    const viewCount  = summary.view_count  || 0;
    const openIssues = (issuesData.issues  || []).length;
    const openPRs    = (prsData.pull_requests || []).length;

    /* Build 7-day sparkline SVG */
    const days = Array.isArray(viewDays) ? viewDays : [];
    const W = 220, H = 36, pad = 4;
    let sparklineSvg = '';
    if (days.length >= 2) {
      const counts  = days.map(d => d.count || 0);
      const maxVal  = Math.max(...counts, 1);
      const xStep   = (W - pad * 2) / (counts.length - 1);
      const pts     = counts.map((v, i) => {
        const x = pad + i * xStep;
        const y = H - pad - (v / maxVal) * (H - pad * 2);
        return { x, y };
      });
      const polyPts = pts.map(p => `${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(' ');
      const dots    = pts.map(p =>
        `<circle cx="${p.x.toFixed(1)}" cy="${p.y.toFixed(1)}" r="2.5" fill="var(--color-accent)"/>`
      ).join('');
      sparklineSvg = `
        <svg viewBox="0 0 ${W} ${H}" style="width:100%;height:${H}px;display:block;margin:var(--space-2) 0"
             aria-label="7-day view sparkline">
          <polyline points="${polyPts}" fill="none" stroke="var(--color-accent)"
                    stroke-width="1.5" opacity="0.7"/>
          ${dots}
        </svg>`;
    }

    el.innerHTML = `
      <h3>Activity</h3>
      <div class="about-stat-row">&#128065; <strong>${viewCount.toLocaleString()}</strong> views this month</div>
      ${sparklineSvg}
      <div style="display:flex;gap:var(--space-3);margin-top:var(--space-2)">
        <a href="${base}/issues?state=open" class="text-sm"
           style="display:flex;align-items:center;gap:var(--space-1);color:var(--text-secondary)">
          &#128027; <strong style="color:var(--text-primary)">${openIssues}</strong>&nbsp;open issue${openIssues !== 1 ? 's' : ''}
        </a>
        <a href="${base}/pulls?state=open" class="text-sm"
           style="display:flex;align-items:center;gap:var(--space-1);color:var(--text-secondary)">
          &#x1F500; <strong style="color:var(--text-primary)">${openPRs}</strong>&nbsp;open PR${openPRs !== 1 ? 's' : ''}
        </a>
      </div>
    `;
    el.style.display = '';
  } catch(e) { /* non-critical */ }
}

/* ═══════════════════════════════════════════════════════
 * Bootstrap — fire all loaders in parallel
 * ═══════════════════════════════════════════════════════ */
function load() {
  loadCommits('');
  loadAbout();
  loadWatchCount();
  loadContributors();
  loadInstrumentBar();
  loadEmotionArc();
  loadAnalytics();
  loadSimilar();
}

load();
{% endraw %}
{% endblock %}
