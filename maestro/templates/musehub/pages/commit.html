{% extends "musehub/base.html" %}

{% block title %}{{ commit_id[:8] }} Â· {{ owner }}/{{ repo_slug }}{% endblock %}
{% block breadcrumb %}
  <a href="/musehub/ui/{{ owner }}">{{ owner }}</a> /
  <a href="{{ base_url }}">{{ repo_slug }}</a> /
  <a href="{{ base_url }}">commits</a> /
  {{ commit_id[:8] }}
{% endblock %}

{% block repo_nav %}
{% include "musehub/partials/repo_nav.html" %}
{% endblock %}

{% block page_data %}
const repoId   = {{ repo_id | tojson }};
const commitId = {{ commit_id | tojson }};
const base     = {{ base_url | tojson }};
const apiBase  = '/api/v1/musehub/repos/' + repoId;
{% endblock %}

{% block page_script %}
{% raw %}
const AUDIO_EXTS    = new Set(['mp3','ogg','wav','flac','m4a']);
const IMAGE_EXTS    = new Set(['webp','png','jpg','jpeg','gif']);
const MIDI_EXTS     = new Set(['mid','midi']);
const SCORE_EXTS    = new Set(['abc','musicxml','xml','mxl']);
const METADATA_EXTS = new Set(['json','yaml','yml','toml']);

// â”€â”€ Dimension badge helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DIM_ICONS = {
  harmonic:   'ğŸµ',
  rhythmic:   'ğŸ¥',
  melodic:    'ğŸ¼',
  structural: 'ğŸ—ï¸',
  dynamic:    'ğŸ“¢',
};

function dimBadge(dim) {
  const icon  = DIM_ICONS[dim.dimension] || 'â—†';
  const pct   = Math.round(dim.score * 100);
  const label = dim.label;
  return `<span class="badge badge-dim-${dim.color}" title="${escHtml(dim.dimension)}: ${pct}% change">
    ${icon} ${escHtml(dim.dimension)} <span class="dim-pct">${label}</span>
  </span>`;
}

// â”€â”€ Copy-to-clipboard helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function copyToClipboard(text, btn) {
  navigator.clipboard.writeText(text).then(() => {
    const orig = btn.textContent;
    btn.textContent = 'âœ“';
    setTimeout(() => { btn.textContent = orig; }, 1500);
  }).catch(() => {});
}

// â”€â”€ Artifact helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function artifactHtml(obj, repoName) {
  const ext  = obj.path.split('.').pop().toLowerCase();
  const url  = apiBase + '/objects/' + obj.objectId + '/content';
  const name = obj.path.split('/').pop();

  if (IMAGE_EXTS.has(ext)) {
    return `<div class="artifact-card">
      <img data-content-url="${url}" alt="${escHtml(obj.path)}" loading="lazy" />
      <span class="path">${escHtml(name)}</span>
    </div>`;
  }

  if (AUDIO_EXTS.has(ext)) {
    return `<div class="artifact-card">
      <audio controls preload="none" style="width:100%;margin-bottom:var(--space-1)">
        <source src="${url}" />
      </audio>
      <button class="btn btn-primary btn-sm" style="width:100%;justify-content:center"
              onclick="queueAudio('${url}', '${escHtml(name)}', '${escHtml(repoName)}')">
        â–¶ Queue in Player
      </button>
      <button class="btn btn-secondary btn-sm" style="width:100%;justify-content:center;margin-top:var(--space-1)"
              onclick="downloadArtifact('${url}','${escHtml(name)}')">
        â¬‡ Download
      </button>
      <span class="path icon-mp3">${escHtml(name)}</span>
    </div>`;
  }

  if (MIDI_EXTS.has(ext)) {
    return `<div class="artifact-card">
      <div class="midi-preview" id="midi-${escHtml(obj.objectId)}" data-url="${url}">
        <div class="midi-roll-placeholder">ğŸ¹ MIDI â€” ${escHtml(name)}</div>
      </div>
      <button class="btn btn-secondary btn-sm" style="width:100%;justify-content:center"
              onclick="downloadArtifact('${url}','${escHtml(name)}')">
        â¬‡ Download MIDI
      </button>
      <a class="btn btn-ghost btn-sm" style="width:100%;justify-content:center;margin-top:var(--space-1)"
         href="${base}/objects/${escHtml(obj.objectId)}/piano-roll" target="_blank">
        ğŸ¹ View in Piano Roll
      </a>
      <span class="path icon-mid">${escHtml(name)}</span>
    </div>`;
  }

  if (SCORE_EXTS.has(ext)) {
    return `<div class="artifact-card">
      <div class="score-preview" id="score-${escHtml(obj.objectId)}" data-url="${url}" data-ext="${ext}">
        <p class="text-muted text-sm" style="padding:var(--space-2)">ğŸ¶ ${escHtml(ext.toUpperCase())} Score â€” loadingâ€¦</p>
      </div>
      <button class="btn btn-secondary btn-sm" style="width:100%;justify-content:center"
              onclick="downloadArtifact('${url}','${escHtml(name)}')">
        â¬‡ Download Score
      </button>
      <span class="path">${escHtml(name)}</span>
    </div>`;
  }

  if (METADATA_EXTS.has(ext)) {
    return `<div class="artifact-card artifact-card--meta">
      <div class="meta-file-icon">{ }</div>
      <span class="path">${escHtml(name)}</span>
      <a class="btn btn-secondary btn-sm" style="width:100%;justify-content:center;margin-top:var(--space-2)"
         href="${url}" target="_blank">
        ğŸ‘ View JSON
      </a>
    </div>`;
  }

  return `<div class="artifact-card">
    <button class="btn btn-secondary btn-sm" style="width:100%;justify-content:center"
            onclick="downloadArtifact('${url}','${escHtml(name)}')">
      â¬‡ Download
    </button>
    <span class="path">${escHtml(name)}</span>
  </div>`;
}

// â”€â”€ Organised artifact sections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildArtifactSections(objects, repoName) {
  const images   = objects.filter(o => IMAGE_EXTS.has(o.path.split('.').pop().toLowerCase()));
  const audio    = objects.filter(o => AUDIO_EXTS.has(o.path.split('.').pop().toLowerCase()));
  const midi     = objects.filter(o => MIDI_EXTS.has(o.path.split('.').pop().toLowerCase()));
  const scores   = objects.filter(o => SCORE_EXTS.has(o.path.split('.').pop().toLowerCase()));
  const metadata = objects.filter(o => METADATA_EXTS.has(o.path.split('.').pop().toLowerCase()));
  const other    = objects.filter(o => {
    const ext = o.path.split('.').pop().toLowerCase();
    return !IMAGE_EXTS.has(ext) && !AUDIO_EXTS.has(ext) && !MIDI_EXTS.has(ext)
        && !SCORE_EXTS.has(ext) && !METADATA_EXTS.has(ext);
  });

  const section = (title, icon, items) => {
    if (!items.length) return '';
    return `<div class="artifact-section">
      <h3 class="artifact-section-title">${icon} ${title} <span class="artifact-count">(${items.length})</span></h3>
      <div class="artifact-grid">${items.map(o => artifactHtml(o, repoName)).join('')}</div>
    </div>`;
  };

  const parts = [
    section('Piano Rolls', 'ğŸ¹', images),
    section('Audio', 'ğŸµ', audio),
    section('MIDI', 'ğŸ»', midi),
    section('Scores', 'ğŸ¼', scores),
    section('Metadata', 'ğŸ“„', metadata),
    section('Other', 'ğŸ“', other),
  ].filter(Boolean);

  if (!parts.length) {
    return `<div class="empty-state" style="padding:var(--space-6)">
      <div class="empty-icon">ğŸ’¾</div>
      <p class="empty-title">No artifacts</p>
      <p class="empty-desc">Push audio files and MIDI via <code>muse push</code> to see them here.</p>
    </div>`;
  }
  return parts.join('');
}

async function hydrateImages() {
  document.querySelectorAll('img[data-content-url]').forEach(async img => {
    const url = img.dataset.contentUrl;
    try {
      const blobUrl = await _fetchBlobUrl(url);
      img.src = blobUrl;
    } catch (_) {
      img.alt = 'Preview unavailable';
    }
  });
}

function parseInstruments(message) {
  const tracks = [];
  const trackRe = /\b(bass|keys|drums?|strings?|horn|trumpet|sax(?:ophone)?|guitar|piano|synth|pad|lead|percussion|vox|vocals?)\b/gi;
  let m;
  while ((m = trackRe.exec(message)) !== null) {
    const t = m[1].toLowerCase();
    if (!tracks.includes(t)) tracks.push(t);
  }
  return tracks;
}

// â”€â”€ Preserve line breaks in commit message body â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCommitBody(message) {
  const lines = message.split('\n');
  if (lines.length <= 1) return '';
  const body = lines.slice(1).join('\n').trim();
  if (!body) return '';
  const escaped = body.split('\n').map(l => `<span class="commit-body-line">${escHtml(l) || '&nbsp;'}</span>`).join('');
  return `<div class="commit-body">${escaped}</div>`;
}

// â”€â”€ Before/after audio comparison â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildBeforeAfterAudio(currentAudio, parentAudio, repoId) {
  if (!currentAudio.length && !parentAudio.length) return '';
  const playerCard = (title, files, id_suffix) => {
    if (!files.length) return '';
    const f = files[0];
    const url = '/api/v1/musehub/repos/' + repoId + '/objects/' + f.objectId + '/content';
    const name = f.path.split('/').pop();
    return `<div class="ab-player" id="ab-${id_suffix}">
      <div class="ab-label">${title}</div>
      <audio controls preload="none" style="width:100%">
        <source src="${url}" />
      </audio>
      <span class="path text-sm">${escHtml(name)}</span>
    </div>`;
  };
  return `<div class="card">
    <h2 style="margin-bottom:var(--space-3)">ğŸ”Š Before / After</h2>
    <p class="text-sm text-muted" style="margin-bottom:var(--space-3)">
      Compare the primary audio render of this commit against its parent.
    </p>
    <div class="ab-container">
      ${playerCard('After (this commit)', currentAudio, 'after')}
      ${playerCard('Before (parent)', parentAudio, 'before')}
    </div>
  </div>`;
}

// â”€â”€ Tag badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tagBadges(tags) {
  if (!tags || !tags.length) return '';
  return tags.map(t => `<span class="badge badge-tag" title="Tag: ${escHtml(t)}">ğŸ· ${escHtml(t)}</span>`).join('');
}

// â”€â”€ Child commit links â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildChildLinks(allCommits, thisId, base) {
  const children = allCommits.filter(c => (c.parentIds || []).includes(thisId));
  if (!children.length) return '<span class="text-muted text-sm">none (HEAD or branch tip)</span>';
  return children.map(c =>
    `<a href="${base}/commits/${c.commitId}" class="text-mono text-sm" title="View child commit">${c.commitId.substring(0,8)}</a>`
  ).join(' ');
}

async function load() {
  initRepoNav(repoId);
  try {
    const [commitsData, objectsData, diffData] = await Promise.all([
      apiFetch('/repos/' + repoId + '/commits?limit=200'),
      apiFetch('/repos/' + repoId + '/objects'),
      apiFetch('/repos/' + repoId + '/commits/' + commitId + '/diff-summary').catch(() => null),
    ]);

    const commit = (commitsData.commits || []).find(c => c.commitId === commitId);
    const allCommits = commitsData.commits || [];
    const objects = objectsData.objects || [];
    const repoName = repoId;

    if (!commit) {
      document.getElementById('content').innerHTML =
        '<div class="card"><p class="error">Commit ' + escHtml(commitId) + ' not found in recent history.</p></div>';
      return;
    }

    const parsed  = parseCommitMessage(commit.message);
    const meta    = parseCommitMeta(commit.message);
    const instruments = parseInstruments(commit.message);

    // â”€â”€ Badges: type, scope, dimensions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const typeBadge  = commitTypeBadge(parsed.type);
    const scopeBadge = commitScopeBadge(parsed.scope);
    const dimBadges  = diffData
      ? diffData.dimensions.filter(d => d.score >= 0.15).map(dimBadge).join('')
      : '';

    // â”€â”€ Parent + child links â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const parentLinks = (commit.parentIds || []).length > 0
      ? commit.parentIds.map(p =>
          `<a href="${base}/commits/${p}" class="text-mono text-sm" title="View parent commit">${p.substring(0,8)}</a>`
        ).join(' ')
      : '<span class="text-muted text-sm">none (root commit)</span>';

    const childLinks = buildChildLinks(allCommits, commit.commitId, base);

    // â”€â”€ Instrument tags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const instTags = instruments.length > 0
      ? instruments.map(i => `<span class="nav-meta-tag">ğŸ¸ ${escHtml(i)}</span>`).join('')
      : '';

    // â”€â”€ Tags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const tags = commit.tags || [];
    const tagSection = tagBadges(tags);

    // â”€â”€ Parent objects for before/after comparison â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const parentId = (commit.parentIds || [])[0] || null;
    let parentObjects = [];
    if (parentId) {
      try {
        const parentData = await apiFetch('/repos/' + repoId + '/objects?commit_id=' + parentId);
        parentObjects = parentData.objects || [];
      } catch(_) { /* non-fatal */ }
    }
    const currentAudio = objects.filter(o => AUDIO_EXTS.has(o.path.split('.').pop().toLowerCase()));
    const parentAudio  = parentObjects.filter(o => AUDIO_EXTS.has(o.path.split('.').pop().toLowerCase()));

    // â”€â”€ Stem Browser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const audioFiles = currentAudio;
    const stemBrowser = audioFiles.length > 1
      ? `<div class="card">
          <h2 style="margin-bottom:var(--space-3)">ğŸ™ Stem Browser</h2>
          <p class="text-sm text-muted" style="margin-bottom:var(--space-3)">Solo individual instrument stems.</p>
          <div class="stem-browser" id="stem-browser">
            ${audioFiles.map((obj, i) => {
              const name = obj.path.split('/').pop().replace(/\.[^.]+$/, '');
              const url  = '/api/v1/musehub/repos/' + repoId + '/objects/' + obj.objectId + '/content';
              return `<div class="stem-row" id="stem-row-${i}">
                <button class="player-btn" onclick="queueAudio('${url}','${escHtml(name)}','')" title="Play stem">â–¶</button>
                <span class="stem-label">${escHtml(name)}</span>
                <div class="waveform-bar" style="flex:1;height:32px;cursor:pointer" onclick="queueAudio('${url}','${escHtml(name)}','')">
                  ${Array.from({length: 48}, (_, j) => {
                    const seed = (name.charCodeAt(j % name.length) + j) * 1103515245;
                    const h = 20 + (Math.abs(seed) % 70);
                    return '<div class="wave-col" style="height:' + h + '%"></div>';
                  }).join('')}
                </div>
              </div>`;
            }).join('')}
          </div>
        </div>`
      : '';

    // â”€â”€ Full artifact browser organized by type â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const artifactSection = buildArtifactSections(objects, repoName);

    // â”€â”€ Musical metadata derived from meta + commit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const musicalMeta = [
      meta.key   ? `<div class="meta-item"><span class="meta-label">Key</span><span class="meta-value text-sm">â™­ ${escHtml(meta.key)}</span></div>` : '',
      (meta.tempo || meta.bpm) ? `<div class="meta-item"><span class="meta-label">Tempo</span><span class="meta-value text-sm">â± ${escHtml(meta.tempo || meta.bpm)} BPM</span></div>` : '',
      meta.section ? `<div class="meta-item"><span class="meta-label">Section</span><span class="meta-value badge badge-dim-structural">${escHtml(meta.section)}</span></div>` : '',
      meta.meter  ? `<div class="meta-item"><span class="meta-label">Meter</span><span class="meta-value text-sm">${escHtml(meta.meter)}</span></div>` : '',
    ].filter(Boolean).join('');

    document.getElementById('content').innerHTML = `
      <div class="commit-liner-notes">

        <!-- Commit identity row -->
        <div class="commit-header-row">
          <div class="commit-header-left">
            ${typeBadge}${scopeBadge}
            ${instTags}
            ${tagSection}
          </div>
          <div class="commit-header-right">
            <a href="${base}/commits/${commitId}/diff" class="btn btn-secondary btn-sm">
              âŠ• Musical Diff
            </a>
            <a href="${base}/context/${commitId}" class="btn btn-secondary btn-sm">
              ğŸ§  AI Context
            </a>
            <button class="btn btn-primary btn-sm" onclick="openCompose()">
              ğŸµ Compose Variation
            </button>
          </div>
        </div>

        <!-- Dimension diff badges -->
        ${dimBadges ? `<div class="card dim-badges-card">
          <div class="dim-badges-label">Musical Changes</div>
          <div class="dim-badges-row">${dimBadges}</div>
        </div>` : ''}

        <!-- Commit message as liner notes headline -->
        <div class="card commit-message-card">
          <h1 class="commit-subject">${escHtml(parsed.subject || commit.message)}</h1>
          ${parsed.type || parsed.scope ? `
          <div style="margin-top:var(--space-2);font-size:var(--font-size-sm);color:var(--text-muted)">
            ${parsed.type ? `<strong>${escHtml(parsed.type)}</strong>` : ''}
            ${parsed.scope ? ` in <strong>${escHtml(parsed.scope)}</strong>` : ''}
          </div>` : ''}
          ${renderCommitBody(commit.message)}
        </div>

        <!-- Commit metadata grid -->
        <div class="card">
          <div class="meta-row" style="grid-template-columns:repeat(auto-fill,minmax(160px,1fr))">
            <div class="meta-item">
              <span class="meta-label">Author</span>
              <span class="meta-value">
                <a href="/musehub/ui/users/${escHtml(commit.author)}" class="text-sm">${escHtml(commit.author)}</a>
              </span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Date</span>
              <span class="meta-value text-sm">${fmtDate(commit.timestamp)}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Branch</span>
              <span class="meta-value text-mono text-sm">${escHtml(commit.branch || 'â€”')}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">SHA</span>
              <span class="meta-value" style="display:flex;align-items:center;gap:var(--space-1)">
                <span class="text-mono text-sm sha-full" title="${escHtml(commitId)}">${escHtml(commitId)}</span>
                <button class="btn btn-ghost btn-xs copy-btn" onclick="copyToClipboard('${escHtml(commitId)}', this)" title="Copy full SHA">â§‰</button>
              </span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Parents</span>
              <span class="meta-value">${parentLinks}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Children</span>
              <span class="meta-value">${childLinks}</span>
            </div>
            ${musicalMeta}
          </div>
        </div>

        <!-- Before / After audio comparison -->
        ${buildBeforeAfterAudio(currentAudio, parentAudio, repoId)}

        <!-- Stem Browser -->
        ${stemBrowser}

        <!-- Artifacts organized by type -->
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-3)">
            <h2 style="margin:0">Artifacts (${objects.length})</h2>
            ${audioFiles.length > 0 ? `
            <button class="btn btn-primary btn-sm"
                    onclick="queueAudio('/api/v1/musehub/repos/${repoId}/objects/${audioFiles[0].objectId}/content',
                    '${escHtml(audioFiles[0].path.split('/').pop())}', '${escHtml(repoId)}')">
              â–¶ Play Latest
            </button>` : ''}
          </div>
          ${artifactSection}
        </div>

        <!-- AI summary panel (populated by loadAiSummary) -->
        <div class="card" id="ai-summary-panel" style="display:none;border-color:var(--color-accent)">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-3)">
            <h2 style="margin:0">ğŸ§  What changed musically?</h2>
            <button class="btn btn-secondary btn-sm" onclick="openCompose()">
              ğŸµ Compose Variation
            </button>
          </div>
          <div id="ai-summary-body"><p class="loading text-sm">Analyzingâ€¦</p></div>
        </div>

        <!-- Comment threads -->
        <div class="card" id="comments-section">
          <h2 style="margin:0 0 var(--space-3) 0">ğŸ’¬ Discussion</h2>
          <div id="comments-list"><p class="loading text-sm">Loading commentsâ€¦</p></div>
          <div id="new-comment-form" style="display:none;margin-top:var(--space-4)">
            <div class="comment-row" style="align-items:flex-start">
              <span class="comment-avatar" id="new-comment-avatar" style="background:var(--bg-overlay);color:var(--text-muted)">?</span>
              <div style="flex:1">
                <textarea id="new-comment-body" class="form-input comment-textarea" rows="3"
                          placeholder="Leave a commentâ€¦" style="resize:vertical"></textarea>
                <div class="comment-form-actions" style="margin-top:var(--space-2)">
                  <button id="comment-submit-btn" class="btn btn-primary btn-sm"
                          onclick="submitComment(null)">Comment</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Navigation -->
        <div style="display:flex;gap:var(--space-3);margin-top:var(--space-2);flex-wrap:wrap">
          ${commit.parentIds && commit.parentIds.length > 0
            ? `<a href="${base}/commits/${commit.parentIds[0]}" class="btn btn-secondary btn-sm">â† Parent Commit</a>`
            : ''}
          ${(allCommits.filter(c => (c.parentIds || []).includes(commitId)))[0]
            ? `<a href="${base}/commits/${allCommits.filter(c => (c.parentIds || []).includes(commitId))[0].commitId}" class="btn btn-secondary btn-sm">Child Commit â†’</a>`
            : ''}
          <a href="${base}" class="btn btn-ghost btn-sm">â† Back to commits</a>
        </div>
      </div>`;

    renderScorePreviews();
    // Hydrate image artifact cards with authed blob URLs to avoid 401
    hydrateImages();

  } catch(e) {
    if (e.message !== 'auth')
      document.getElementById('content').innerHTML = '<p class="error">âœ• ' + escHtml(e.message) + '</p>';
  }
}

function renderScorePreviews() {
  document.querySelectorAll('.score-preview[data-ext="abc"]').forEach(async el => {
    try {
      const url = el.dataset.url;
      const text = await fetch(url, { headers: authHeaders() }).then(r => r.text());
      if (window.ABCJS) {
        el.innerHTML = '';
        window.ABCJS.renderAbc(el, text, { responsive: 'resize', staffwidth: el.offsetWidth || 400 });
      } else {
        el.innerHTML = '<pre style="font-size:11px;overflow-x:auto">' + escHtml(text.substring(0, 400)) + '</pre>';
      }
    } catch(e) { /* non-fatal */ }
  });
}

// â”€â”€ AI commit summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAiSummary() {
  const panel = document.getElementById('ai-summary-panel');
  const body  = document.getElementById('ai-summary-body');
  if (!panel || !body) return;
  try {
    const ctx = await apiFetch('/repos/' + repoId + '/context/' + commitId);
    const missing  = (ctx.missingElements || []);
    const suggests = ctx.suggestions || {};
    const suggKeys = Object.keys(suggests);
    let html = '';
    if (missing.length > 0) {
      html += '<p class="text-sm text-muted" style="margin-bottom:var(--space-2)">Missing elements:</p>';
      html += '<ul style="padding-left:var(--space-4);font-size:var(--font-size-sm);color:var(--color-warning)">';
      html += missing.map(m => '<li>' + escHtml(m) + '</li>').join('');
      html += '</ul>';
    }
    if (suggKeys.length > 0) {
      html += '<p class="text-sm text-muted" style="margin-top:var(--space-3);margin-bottom:var(--space-2)">Suggestions:</p>';
      html += suggKeys.map(k =>
        '<div style="margin-bottom:var(--space-2);font-size:var(--font-size-sm)">'
        + '<strong>' + escHtml(k) + '</strong>: ' + escHtml(suggests[k])
        + '</div>'
      ).join('');
    }
    if (!html) html = '<p class="text-sm text-muted">All musical dimensions look complete.</p>';
    body.innerHTML = html;
    panel.style.display = '';
  } catch(e) { /* non-critical: AI summary fails silently */ }
}

// â”€â”€ Compose Variation modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openCompose() {
  const modal = document.getElementById('compose-modal');
  if (modal) {
    modal.style.display = 'flex';
    document.getElementById('compose-output').style.display = 'none';
    document.getElementById('compose-stream').textContent = '';
  }
}

function closeCompose() {
  const modal = document.getElementById('compose-modal');
  if (modal) modal.style.display = 'none';
}

async function sendCompose() {
  const prompt = document.getElementById('compose-prompt').value.trim();
  if (!prompt) return;
  const btn    = document.getElementById('compose-send-btn');
  const output = document.getElementById('compose-output');
  const stream = document.getElementById('compose-stream');
  btn.disabled = true;
  btn.textContent = 'â³ Generatingâ€¦';
  output.style.display = '';
  stream.textContent = '';

  try {
    const res = await fetch('/api/v1/maestro/stream', {
      method: 'POST',
      headers: { ...authHeaders(), 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: prompt,
        mode: 'compose',
        repo_id: repoId,
        commit_id: commitId,
      }),
    });
    if (!res.ok) {
      stream.textContent = 'âŒ ' + res.status + ': ' + await res.text();
      return;
    }
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';
    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop() || '';
      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const data = line.slice(6).trim();
          if (data === '[DONE]') break;
          try {
            const obj = JSON.parse(data);
            if (obj.content) stream.textContent += obj.content;
            else if (obj.text)    stream.textContent += obj.text;
            else if (typeof obj === 'string') stream.textContent += obj;
          } catch { stream.textContent += data; }
          stream.scrollTop = stream.scrollHeight;
        }
      }
    }
  } catch(e) {
    stream.textContent += '\n\nâŒ ' + e.message;
  } finally {
    btn.disabled = false;
    btn.textContent = 'â™ª Re-generate';
  }
}

// â”€â”€ Comment threads â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/** Extract username from the stored JWT without a library (reads the payload claim). */
function currentUsername() {
  const tok = getToken();
  if (!tok) return null;
  try {
    const payload = JSON.parse(atob(tok.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
    return payload.sub || null;
  } catch { return null; }
}

/** Deterministic HSL avatar colour from a username string. */
function avatarColor(username) {
  let hash = 0;
  for (let i = 0; i < username.length; i++) hash = username.charCodeAt(i) + ((hash << 5) - hash);
  return `hsl(${Math.abs(hash) % 360},55%,45%)`;
}

function avatarHtml(username) {
  const initial = escHtml((username || '?').charAt(0).toUpperCase());
  const color   = avatarColor(username || '');
  return `<span class="comment-avatar" style="background:${color}">${initial}</span>`;
}

/**
 * Render a flat list of CommentResponse objects into a threaded tree.
 * Top-level (parent_id=null) first; replies indented beneath their parent.
 */
function renderComments(comments, me) {
  const topLevel = comments.filter(c => !c.parent_id);
  const replies  = comments.filter(c =>  c.parent_id);

  if (topLevel.length === 0 && !me) {
    return '<p class="text-sm text-muted" style="margin:0">No comments yet.</p>';
  }
  if (topLevel.length === 0) {
    return '<p class="text-sm text-muted" style="margin:0">Be the first to comment.</p>';
  }

  return topLevel.map(c => commentHtml(c, replies, me)).join('');
}

function commentHtml(c, allReplies, me) {
  const isOwn      = me && c.author === me;
  const threadReplies = allReplies.filter(r => r.parent_id === c.comment_id);

  return `
<div class="comment-thread" id="comment-${escHtml(c.comment_id)}">
  <div class="comment-row">
    ${avatarHtml(c.author)}
    <div class="comment-body-col">
      <div class="comment-meta">
        <a href="/musehub/ui/users/${encodeURIComponent(c.author)}" class="comment-author">${escHtml(c.author)}</a>
        <span class="comment-ts" title="${escHtml(c.created_at)}">${fmtRelative(c.created_at)}</span>
      </div>
      <div class="comment-text">${escHtml(c.body)}</div>
      <div class="comment-actions">
        ${me ? `<button class="btn btn-ghost btn-xs" onclick="showReplyForm('${escHtml(c.comment_id)}')">â†© Reply</button>` : ''}
        ${isOwn ? `<button class="btn btn-ghost btn-xs comment-delete-btn" onclick="deleteComment('${escHtml(c.comment_id)}')">ğŸ—‘</button>` : ''}
      </div>
      <div class="reply-form-slot" id="reply-slot-${escHtml(c.comment_id)}"></div>
      ${threadReplies.length > 0 ? `<div class="comment-replies">${threadReplies.map(r => replyHtml(r, me)).join('')}</div>` : ''}
    </div>
  </div>
</div>`;
}

function replyHtml(c, me) {
  const isOwn = me && c.author === me;
  return `
<div class="comment-row comment-reply-row" id="comment-${escHtml(c.comment_id)}">
  ${avatarHtml(c.author)}
  <div class="comment-body-col">
    <div class="comment-meta">
      <a href="/musehub/ui/users/${encodeURIComponent(c.author)}" class="comment-author">${escHtml(c.author)}</a>
      <span class="comment-ts" title="${escHtml(c.created_at)}">${fmtRelative(c.created_at)}</span>
    </div>
    <div class="comment-text">${escHtml(c.body)}</div>
    ${isOwn ? `<div class="comment-actions"><button class="btn btn-ghost btn-xs comment-delete-btn" onclick="deleteComment('${escHtml(c.comment_id)}')">ğŸ—‘</button></div>` : ''}
  </div>
</div>`;
}

async function loadComments() {
  const el = document.getElementById('comments-section');
  if (!el) return;
  try {
    const comments = await apiFetch(`/repos/${repoId}/comments?target_type=commit&target_id=${encodeURIComponent(commitId)}`);
    const me = currentUsername();
    document.getElementById('comments-list').innerHTML = renderComments(comments, me);
    if (me) {
      const form   = document.getElementById('new-comment-form');
      const avatar = document.getElementById('new-comment-avatar');
      form.style.display = '';
      if (avatar) {
        avatar.textContent = me.charAt(0).toUpperCase();
        avatar.style.background = avatarColor(me);
        avatar.style.color = '#fff';
      }
    }
  } catch(e) {
    if (e.message !== 'auth')
      document.getElementById('comments-list').innerHTML = `<p class="error text-sm">âœ• ${escHtml(e.message)}</p>`;
  }
}

async function submitComment(parentId) {
  const textareaId = parentId ? `reply-body-${parentId}` : 'new-comment-body';
  const textarea   = document.getElementById(textareaId);
  if (!textarea) return;
  const body = textarea.value.trim();
  if (!body) return;

  const btn = parentId
    ? document.querySelector(`#reply-slot-${parentId} .comment-submit-btn`)
    : document.getElementById('comment-submit-btn');
  if (btn) { btn.disabled = true; btn.textContent = 'Postingâ€¦'; }

  try {
    await apiFetch(`/repos/${repoId}/comments`, {
      method: 'POST',
      body: JSON.stringify({ target_type: 'commit', target_id: commitId, body, parent_id: parentId || null }),
    });
    textarea.value = '';
    if (parentId) {
      document.getElementById(`reply-slot-${parentId}`).innerHTML = '';
    }
    await loadComments();
  } catch(e) {
    if (e.message !== 'auth') alert('Failed to post comment: ' + e.message);
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = 'Comment'; }
  }
}

async function deleteComment(commentId) {
  if (!confirm('Delete this comment?')) return;
  try {
    await apiFetch(`/repos/${repoId}/comments/${commentId}`, { method: 'DELETE' });
    await loadComments();
  } catch(e) {
    if (e.message !== 'auth') alert('Failed to delete: ' + e.message);
  }
}

function showReplyForm(parentId) {
  const slot = document.getElementById(`reply-slot-${parentId}`);
  if (!slot) return;
  if (slot.innerHTML.trim()) { slot.innerHTML = ''; return; }
  slot.innerHTML = `
<div class="reply-form">
  <textarea id="reply-body-${escHtml(parentId)}" class="form-input comment-textarea" rows="2"
            placeholder="Write a replyâ€¦" style="resize:vertical"></textarea>
  <div class="comment-form-actions">
    <button class="btn btn-primary btn-sm comment-submit-btn" onclick="submitComment('${escHtml(parentId)}')">Comment</button>
    <button class="btn btn-ghost btn-sm" onclick="document.getElementById('reply-slot-${escHtml(parentId)}').innerHTML=''">Cancel</button>
  </div>
</div>`;
  const ta = document.getElementById(`reply-body-${parentId}`);
  if (ta) ta.focus();
}

load();
loadAiSummary();
loadComments();
{% endraw %}
{% endblock %}

{% block body_extra %}
<!-- Compose Variation Modal -->
<div id="compose-modal" class="modal" style="display:none" onclick="if(event.target===this)closeCompose()">
  <div class="modal-panel" style="max-width:640px;width:100%">
    <div class="modal-header">
      <h2 style="margin:0">ğŸ§  Compose Variation</h2>
      <button class="btn btn-ghost btn-sm" onclick="closeCompose()">âœ•</button>
    </div>
    <div style="padding:var(--space-4)">
      <p class="text-sm text-muted" style="margin-bottom:var(--space-3)">
        Describe what you want Maestro to compose, using this commit as musical context.
        The AI will reason about the current key, tempo, and tracks.
      </p>
      <div class="form-group">
        <label class="form-label" for="compose-prompt">Prompt</label>
        <textarea id="compose-prompt" class="form-input" rows="4"
                  placeholder="Add a walking bass line in F minor. Keep it under 90 BPMâ€¦"
                  style="resize:vertical;width:100%;font-family:var(--font-sans)"></textarea>
      </div>
      <div style="display:flex;gap:var(--space-2);margin-top:var(--space-3)">
        <button class="btn btn-primary" id="compose-send-btn" onclick="sendCompose()">
          ğŸµ Generate
        </button>
        <button class="btn btn-secondary" onclick="closeCompose()">Cancel</button>
      </div>
      <div id="compose-output" style="margin-top:var(--space-4);display:none">
        <div class="section-title">Agent Response</div>
        <pre id="compose-stream" style="background:var(--bg-base);border:1px solid var(--border-subtle);border-radius:var(--radius-base);padding:var(--space-3);font-size:12px;max-height:300px;overflow-y:auto;white-space:pre-wrap"></pre>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/abcjs@6.4.4/dist/abcjs-basic-min.js"></script>
<style>
.commit-liner-notes { max-width: 860px; margin: 0 auto; }
.commit-header-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: var(--space-2);
  margin-bottom: var(--space-3);
  padding: var(--space-2) 0;
}
.commit-header-left { display: flex; gap: var(--space-2); flex-wrap: wrap; align-items: center; }
.commit-header-right { display: flex; gap: var(--space-2); flex-wrap: wrap; }
.commit-message-card { border-left: 3px solid var(--color-accent); }
.commit-subject {
  font-size: var(--font-size-xl);
  font-weight: var(--font-weight-semibold);
  color: var(--text-primary);
  margin: 0;
  line-height: var(--line-height-tight);
}
.commit-body {
  margin-top: var(--space-3);
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.commit-body-line {
  display: block;
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
  white-space: pre-wrap;
  line-height: 1.6;
}
/* â”€â”€ Dimension badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.dim-badges-card { padding: var(--space-3); }
.dim-badges-label {
  font-size: var(--font-size-xs);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-muted);
  margin-bottom: var(--space-2);
}
.dim-badges-row { display: flex; gap: var(--space-2); flex-wrap: wrap; }
.badge-dim-dim-none    { background: var(--bg-overlay); color: var(--text-muted); }
.badge-dim-dim-low     { background: #1a3a2a; color: #4ade80; border: 1px solid #166534; }
.badge-dim-dim-medium  { background: #3a2e0a; color: #facc15; border: 1px solid #854d0e; }
.badge-dim-dim-high    { background: #3a1515; color: #f87171; border: 1px solid #991b1b; }
.badge[class*="badge-dim-"] {
  display: inline-flex;
  align-items: center;
  gap: var(--space-1);
  padding: 2px 8px;
  border-radius: var(--radius-full);
  font-size: var(--font-size-xs);
  font-weight: var(--font-weight-medium);
}
.dim-pct {
  font-weight: var(--font-weight-normal);
  opacity: 0.8;
  font-size: 10px;
}
/* â”€â”€ SHA copy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sha-full {
  max-width: 120px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  display: inline-block;
  vertical-align: middle;
}
.copy-btn {
  padding: 1px 5px;
  font-size: 11px;
  line-height: 1.2;
  border-radius: var(--radius-sm);
  cursor: pointer;
  flex-shrink: 0;
}
/* â”€â”€ Tags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.badge-tag {
  background: #1e2a3a;
  color: #60a5fa;
  border: 1px solid #1d4ed8;
  padding: 2px 8px;
  border-radius: var(--radius-full);
  font-size: var(--font-size-xs);
}
/* â”€â”€ Before/After audio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ab-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--space-4);
}
@media (max-width: 600px) { .ab-container { grid-template-columns: 1fr; } }
.ab-player {
  padding: var(--space-3);
  background: var(--bg-overlay);
  border-radius: var(--radius-base);
  border: 1px solid var(--border-subtle);
  display: flex;
  flex-direction: column;
  gap: var(--space-1);
}
.ab-label {
  font-size: var(--font-size-xs);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-muted);
  margin-bottom: var(--space-1);
}
/* â”€â”€ Artifacts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.artifact-section { margin-bottom: var(--space-4); }
.artifact-section:last-child { margin-bottom: 0; }
.artifact-section-title {
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  color: var(--text-secondary);
  margin: 0 0 var(--space-2) 0;
  padding-bottom: var(--space-1);
  border-bottom: 1px solid var(--border-subtle);
}
.artifact-count {
  font-weight: var(--font-weight-normal);
  color: var(--text-muted);
}
.artifact-card--meta {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
}
.meta-file-icon {
  font-size: 2rem;
  color: var(--text-muted);
  font-family: var(--font-mono);
  margin-bottom: var(--space-1);
}
/* â”€â”€ MIDI + Score previews â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.midi-preview {
  background: var(--bg-overlay);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-sm);
  padding: var(--space-3);
  min-height: 60px;
}
.midi-roll-placeholder {
  color: var(--text-muted);
  font-size: var(--font-size-sm);
}
/* â”€â”€ Stem browser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stem-browser { display: flex; flex-direction: column; gap: var(--space-2); }
.stem-row {
  display: flex;
  align-items: center;
  gap: var(--space-3);
  padding: var(--space-2);
  border-radius: var(--radius-sm);
  background: var(--bg-overlay);
}
.stem-label {
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
  min-width: 100px;
  flex-shrink: 0;
  font-family: var(--font-mono);
}
/* â”€â”€ Comment threads â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.comment-thread { margin-bottom: var(--space-4); }
.comment-thread:last-child { margin-bottom: 0; }
.comment-row {
  display: flex;
  gap: var(--space-3);
  align-items: flex-start;
}
.comment-reply-row { margin-top: var(--space-3); }
.comment-avatar {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  font-size: 13px;
  font-weight: var(--font-weight-semibold);
  color: #fff;
  flex-shrink: 0;
}
.comment-body-col { flex: 1; min-width: 0; }
.comment-meta {
  display: flex;
  align-items: baseline;
  gap: var(--space-2);
  margin-bottom: var(--space-1);
}
.comment-author {
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  color: var(--text-primary);
}
.comment-ts {
  font-size: var(--font-size-xs);
  color: var(--text-muted);
}
.comment-text {
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
  white-space: pre-wrap;
  word-break: break-word;
  line-height: 1.55;
}
.comment-actions {
  display: flex;
  gap: var(--space-1);
  margin-top: var(--space-1);
}
.comment-delete-btn { color: var(--color-danger, #f87171); }
.comment-replies {
  margin-top: var(--space-3);
  padding-left: var(--space-4);
  border-left: 2px solid var(--border-subtle);
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
}
.reply-form { margin-top: var(--space-2); }
.comment-textarea {
  width: 100%;
  font-family: var(--font-sans);
  font-size: var(--font-size-sm);
}
.comment-form-actions {
  display: flex;
  gap: var(--space-2);
  margin-top: var(--space-1);
}
</style>
{% endblock %}
