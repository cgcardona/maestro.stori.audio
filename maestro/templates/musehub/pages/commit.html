{% extends "musehub/base.html" %}

{% block title %}{{ commit_id[:8] }} Â· {{ owner }}/{{ repo_slug }}{% endblock %}
{% block breadcrumb %}
  <a href="/musehub/ui/{{ owner }}">{{ owner }}</a> /
  <a href="{{ base_url }}">{{ repo_slug }}</a> /
  <a href="{{ base_url }}">commits</a> /
  {{ commit_id[:8] }}
{% endblock %}

{% block repo_nav %}
{% include "musehub/partials/repo_nav.html" %}
{% endblock %}

{% block page_data %}
const repoId   = {{ repo_id | tojson }};
const commitId = {{ commit_id | tojson }};
const base     = {{ base_url | tojson }};
const apiBase  = '/api/v1/musehub/repos/' + repoId;
const listenUrl = {{ listen_url | tojson }};
const embedUrl  = {{ embed_url | tojson }};
const shortId   = {{ short_id | tojson }};
{% endblock %}

{% block page_script %}
{% raw %}
// â”€â”€ Inline audio player state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _playerWs      = null;  // WaveSurfer instance
let _playerAudioEl = null;  // fallback <audio> element
let _playerTracks  = [];    // [{name, url}]
let _playerIdx     = 0;
let _playerPlaying = false;

/** Build and mount the inline WaveSurfer hero player.
 *
 * Uses WaveSurfer.js when available; falls back to a plain <audio> element so
 * the player renders even if the CDN asset fails to load.  Audio is fetched
 * via the authenticated content URL so private-repo stems are protected.
 */
function buildInlinePlayer(tracks) {
  _playerTracks = tracks;
  _playerIdx    = 0;
  const el = document.getElementById('inline-player-root');
  if (!el || !tracks.length) {
    if (el) el.innerHTML = '<p class="text-muted text-sm" style="text-align:center;padding:var(--space-4)">No audio renders attached to this commit.</p>';
    return;
  }

  const trackOpts = tracks.map((t, i) =>
    `<option value="${i}">${escHtml(t.name)}</option>`).join('');

  el.innerHTML = `
    <div class="iap-title">${escHtml(tracks[0].name)}</div>
    <div id="iap-waveform" class="iap-waveform-wrap">
      <div class="iap-waveform-placeholder">ğŸµ Loading waveformâ€¦</div>
    </div>
    <div class="iap-controls">
      <button id="iap-play-btn" class="iap-play-btn" title="Play / Pause" onclick="iapTogglePlay()">â–¶</button>
      <div style="flex:1;min-width:0">
        <div id="iap-progress-bar" class="iap-progress-bar" onclick="iapSeek(event)">
          <div id="iap-progress-fill" class="iap-progress-fill"></div>
        </div>
        <div class="iap-time-row">
          <span id="iap-current-time">0:00</span>
          <span id="iap-duration">â€”</span>
        </div>
      </div>
      <div class="iap-volume-wrap">
        ğŸ”Š
        <input id="iap-volume" type="range" min="0" max="1" step="0.05" value="0.8"
               class="iap-volume-slider" oninput="iapSetVolume(this.value)" />
      </div>
    </div>
    ${tracks.length > 1 ? `
    <div class="iap-track-selector">
      <label class="iap-track-label">Track</label>
      <select id="iap-track-sel" class="iap-track-select" onchange="iapSwitchTrack(this.value)">
        ${trackOpts}
      </select>
    </div>` : ''}`;

  iapLoad(0);
}

function iapFmtTime(s) {
  if (!isFinite(s)) return 'â€”';
  const m = Math.floor(s / 60);
  const sec = String(Math.floor(s % 60)).padStart(2, '0');
  return `${m}:${sec}`;
}

function iapLoad(idx) {
  _playerIdx    = idx;
  _playerPlaying = false;
  const t       = _playerTracks[idx];
  const wrapEl  = document.getElementById('iap-waveform');
  const playBtn = document.getElementById('iap-play-btn');
  const title   = document.querySelector('#inline-player-root .iap-title');
  if (title) title.textContent = t.name;
  if (playBtn) playBtn.textContent = 'â–¶';

  // Destroy existing WaveSurfer
  if (_playerWs) { try { _playerWs.destroy(); } catch(_) {} _playerWs = null; }
  if (_playerAudioEl) { _playerAudioEl.pause(); _playerAudioEl = null; }

  if (wrapEl) wrapEl.innerHTML = '<div class="iap-waveform-placeholder">ğŸµ Loadingâ€¦</div>';

  if (window.WaveSurfer) {
    if (wrapEl) wrapEl.innerHTML = '<div id="iap-ws-container" style="height:72px;width:100%"></div>';
    _playerWs = WaveSurfer.create({
      container:    '#iap-ws-container',
      waveColor:    '#30363d',
      progressColor:'#1f6feb',
      height:       72,
      normalize:    true,
      backend:      'MediaElement',
      fetchParams:  { headers: authHeaders() },
    });
    _playerWs.load(t.url);
    _playerWs.on('ready', () => {
      const dur = document.getElementById('iap-duration');
      if (dur) dur.textContent = iapFmtTime(_playerWs.getDuration());
    });
    _playerWs.on('audioprocess', () => {
      const cur  = document.getElementById('iap-current-time');
      const fill = document.getElementById('iap-progress-fill');
      const pct  = (_playerWs.getCurrentTime() / (_playerWs.getDuration() || 1)) * 100;
      if (cur)  cur.textContent = iapFmtTime(_playerWs.getCurrentTime());
      if (fill) fill.style.width = pct + '%';
    });
    _playerWs.on('finish', () => {
      _playerPlaying = false;
      const btn = document.getElementById('iap-play-btn');
      if (btn) btn.textContent = 'â–¶';
    });
    _playerWs.on('error', () => {
      if (wrapEl) wrapEl.innerHTML = '<div class="iap-waveform-placeholder" style="color:var(--color-danger)">âš  Could not load audio.</div>';
    });
    const vol = document.getElementById('iap-volume');
    if (vol) _playerWs.setVolume(parseFloat(vol.value));
  } else {
    // Fallback: plain <audio>
    if (wrapEl) wrapEl.innerHTML = `
      <audio id="iap-audio-fallback" controls preload="none" style="width:100%;margin:var(--space-2) 0">
        <source src="${t.url}" />
      </audio>`;
    _playerAudioEl = document.getElementById('iap-audio-fallback');
  }
}

function iapTogglePlay() {
  const btn = document.getElementById('iap-play-btn');
  if (_playerWs) {
    _playerWs.playPause();
    _playerPlaying = !_playerPlaying;
    if (btn) btn.textContent = _playerPlaying ? 'â¸' : 'â–¶';
  } else if (_playerAudioEl) {
    if (_playerAudioEl.paused) { _playerAudioEl.play(); if (btn) btn.textContent = 'â¸'; }
    else { _playerAudioEl.pause(); if (btn) btn.textContent = 'â–¶'; }
  }
}

function iapSeek(event) {
  const bar  = document.getElementById('iap-progress-bar');
  if (!bar || !_playerWs) return;
  const rect = bar.getBoundingClientRect();
  const pct  = (event.clientX - rect.left) / rect.width;
  _playerWs.seekTo(Math.max(0, Math.min(1, pct)));
}

function iapSetVolume(v) {
  if (_playerWs) _playerWs.setVolume(parseFloat(v));
  else if (_playerAudioEl) _playerAudioEl.volume = parseFloat(v);
}

function iapSwitchTrack(idx) {
  iapLoad(parseInt(idx, 10));
}

const AUDIO_EXTS    = new Set(['mp3','ogg','wav','flac','m4a']);
const IMAGE_EXTS    = new Set(['webp','png','jpg','jpeg','gif']);
const MIDI_EXTS     = new Set(['mid','midi']);
const SCORE_EXTS    = new Set(['abc','musicxml','xml','mxl']);
const METADATA_EXTS = new Set(['json','yaml','yml','toml']);

// â”€â”€ Dimension badge helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DIM_ICONS = {
  harmonic:   'ğŸµ',
  rhythmic:   'ğŸ¥',
  melodic:    'ğŸ¼',
  structural: 'ğŸ—ï¸',
  dynamic:    'ğŸ“¢',
};

function dimBadge(dim) {
  const icon  = DIM_ICONS[dim.dimension] || 'â—†';
  const pct   = Math.round(dim.score * 100);
  const label = dim.label;
  return `<span class="badge badge-dim-${dim.color}" title="${escHtml(dim.dimension)}: ${pct}% change">
    ${icon} ${escHtml(dim.dimension)} <span class="dim-pct">${label}</span>
  </span>`;
}

// â”€â”€ Copy-to-clipboard helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function copyToClipboard(text, btn) {
  navigator.clipboard.writeText(text).then(() => {
    const orig = btn.textContent;
    btn.textContent = 'âœ“';
    setTimeout(() => { btn.textContent = orig; }, 1500);
  }).catch(() => {});
}

// â”€â”€ Artifact helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function artifactHtml(obj, repoName) {
  const ext  = obj.path.split('.').pop().toLowerCase();
  const url  = apiBase + '/objects/' + obj.objectId + '/content';
  const name = obj.path.split('/').pop();

  if (IMAGE_EXTS.has(ext)) {
    return `<div class="artifact-card">
      <img data-content-url="${url}" alt="${escHtml(obj.path)}" loading="lazy" />
      <span class="path">${escHtml(name)}</span>
    </div>`;
  }

  if (AUDIO_EXTS.has(ext)) {
    return `<div class="artifact-card">
      <audio controls preload="none" style="width:100%;margin-bottom:var(--space-1)">
        <source src="${url}" />
      </audio>
      <button class="btn btn-primary btn-sm" style="width:100%;justify-content:center"
              onclick="queueAudio('${url}', '${escHtml(name)}', '${escHtml(repoName)}')">
        â–¶ Queue in Player
      </button>
      <button class="btn btn-secondary btn-sm" style="width:100%;justify-content:center;margin-top:var(--space-1)"
              onclick="downloadArtifact('${url}','${escHtml(name)}')">
        â¬‡ Download
      </button>
      <span class="path icon-mp3">${escHtml(name)}</span>
    </div>`;
  }

  if (MIDI_EXTS.has(ext)) {
    return `<div class="artifact-card">
      <div class="midi-preview" id="midi-${escHtml(obj.objectId)}" data-url="${url}">
        <div class="midi-roll-placeholder">ğŸ¹ MIDI â€” ${escHtml(name)}</div>
      </div>
      <button class="btn btn-secondary btn-sm" style="width:100%;justify-content:center"
              onclick="downloadArtifact('${url}','${escHtml(name)}')">
        â¬‡ Download MIDI
      </button>
      <a class="btn btn-ghost btn-sm" style="width:100%;justify-content:center;margin-top:var(--space-1)"
         href="${base}/objects/${escHtml(obj.objectId)}/piano-roll" target="_blank">
        ğŸ¹ View in Piano Roll
      </a>
      <span class="path icon-mid">${escHtml(name)}</span>
    </div>`;
  }

  if (SCORE_EXTS.has(ext)) {
    return `<div class="artifact-card">
      <div class="score-preview" id="score-${escHtml(obj.objectId)}" data-url="${url}" data-ext="${ext}">
        <p class="text-muted text-sm" style="padding:var(--space-2)">ğŸ¶ ${escHtml(ext.toUpperCase())} Score â€” loadingâ€¦</p>
      </div>
      <button class="btn btn-secondary btn-sm" style="width:100%;justify-content:center"
              onclick="downloadArtifact('${url}','${escHtml(name)}')">
        â¬‡ Download Score
      </button>
      <span class="path">${escHtml(name)}</span>
    </div>`;
  }

  if (METADATA_EXTS.has(ext)) {
    return `<div class="artifact-card artifact-card--meta">
      <div class="meta-file-icon">{ }</div>
      <span class="path">${escHtml(name)}</span>
      <a class="btn btn-secondary btn-sm" style="width:100%;justify-content:center;margin-top:var(--space-2)"
         href="${url}" target="_blank">
        ğŸ‘ View JSON
      </a>
    </div>`;
  }

  return `<div class="artifact-card">
    <button class="btn btn-secondary btn-sm" style="width:100%;justify-content:center"
            onclick="downloadArtifact('${url}','${escHtml(name)}')">
      â¬‡ Download
    </button>
    <span class="path">${escHtml(name)}</span>
  </div>`;
}

// â”€â”€ Organised artifact sections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildArtifactSections(objects, repoName) {
  const images   = objects.filter(o => IMAGE_EXTS.has(o.path.split('.').pop().toLowerCase()));
  const audio    = objects.filter(o => AUDIO_EXTS.has(o.path.split('.').pop().toLowerCase()));
  const midi     = objects.filter(o => MIDI_EXTS.has(o.path.split('.').pop().toLowerCase()));
  const scores   = objects.filter(o => SCORE_EXTS.has(o.path.split('.').pop().toLowerCase()));
  const metadata = objects.filter(o => METADATA_EXTS.has(o.path.split('.').pop().toLowerCase()));
  const other    = objects.filter(o => {
    const ext = o.path.split('.').pop().toLowerCase();
    return !IMAGE_EXTS.has(ext) && !AUDIO_EXTS.has(ext) && !MIDI_EXTS.has(ext)
        && !SCORE_EXTS.has(ext) && !METADATA_EXTS.has(ext);
  });

  const section = (title, icon, items) => {
    if (!items.length) return '';
    return `<div class="artifact-section">
      <h3 class="artifact-section-title">${icon} ${title} <span class="artifact-count">(${items.length})</span></h3>
      <div class="artifact-grid">${items.map(o => artifactHtml(o, repoName)).join('')}</div>
    </div>`;
  };

  const parts = [
    section('Piano Rolls', 'ğŸ¹', images),
    section('Audio', 'ğŸµ', audio),
    section('MIDI', 'ğŸ»', midi),
    section('Scores', 'ğŸ¼', scores),
    section('Metadata', 'ğŸ“„', metadata),
    section('Other', 'ğŸ“', other),
  ].filter(Boolean);

  if (!parts.length) {
    return `<div class="empty-state" style="padding:var(--space-6)">
      <div class="empty-icon">ğŸ’¾</div>
      <p class="empty-title">No artifacts</p>
      <p class="empty-desc">Push audio files and MIDI via <code>muse push</code> to see them here.</p>
    </div>`;
  }
  return parts.join('');
}

async function hydrateImages() {
  document.querySelectorAll('img[data-content-url]').forEach(async img => {
    const url = img.dataset.contentUrl;
    try {
      const blobUrl = await _fetchBlobUrl(url);
      img.src = blobUrl;
    } catch (_) {
      img.alt = 'Preview unavailable';
    }
  });
}

function parseInstruments(message) {
  const tracks = [];
  const trackRe = /\b(bass|keys|drums?|strings?|horn|trumpet|sax(?:ophone)?|guitar|piano|synth|pad|lead|percussion|vox|vocals?)\b/gi;
  let m;
  while ((m = trackRe.exec(message)) !== null) {
    const t = m[1].toLowerCase();
    if (!tracks.includes(t)) tracks.push(t);
  }
  return tracks;
}

// â”€â”€ Preserve line breaks in commit message body â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCommitBody(message) {
  const lines = message.split('\n');
  if (lines.length <= 1) return '';
  const body = lines.slice(1).join('\n').trim();
  if (!body) return '';
  const escaped = body.split('\n').map(l => `<span class="commit-body-line">${escHtml(l) || '&nbsp;'}</span>`).join('');
  return `<div class="commit-body">${escaped}</div>`;
}

// â”€â”€ Before/after audio comparison â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildBeforeAfterAudio(currentAudio, parentAudio, repoId) {
  if (!currentAudio.length && !parentAudio.length) return '';
  const playerCard = (title, files, id_suffix) => {
    if (!files.length) return '';
    const f = files[0];
    const url = '/api/v1/musehub/repos/' + repoId + '/objects/' + f.objectId + '/content';
    const name = f.path.split('/').pop();
    return `<div class="ab-player" id="ab-${id_suffix}">
      <div class="ab-label">${title}</div>
      <audio controls preload="none" style="width:100%">
        <source src="${url}" />
      </audio>
      <span class="path text-sm">${escHtml(name)}</span>
    </div>`;
  };
  return `<div class="card">
    <h2 style="margin-bottom:var(--space-3)">ğŸ”Š Before / After</h2>
    <p class="text-sm text-muted" style="margin-bottom:var(--space-3)">
      Compare the primary audio render of this commit against its parent.
    </p>
    <div class="ab-container">
      ${playerCard('After (this commit)', currentAudio, 'after')}
      ${playerCard('Before (parent)', parentAudio, 'before')}
    </div>
  </div>`;
}

// â”€â”€ Tag badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tagBadges(tags) {
  if (!tags || !tags.length) return '';
  return tags.map(t => `<span class="badge badge-tag" title="Tag: ${escHtml(t)}">ğŸ· ${escHtml(t)}</span>`).join('');
}

// â”€â”€ Child commit links â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildChildLinks(allCommits, thisId, base) {
  const children = allCommits.filter(c => (c.parentIds || []).includes(thisId));
  if (!children.length) return '<span class="text-muted text-sm">none (HEAD or branch tip)</span>';
  return children.map(c =>
    `<a href="${base}/commits/${c.commitId}" class="text-mono text-sm" title="View child commit">${c.commitId.substring(0,8)}</a>`
  ).join(' ');
}

// â”€â”€ Muse tags / analysis metadata panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/** Render a tag pill with namespace-specific colours.
 *
 * Tags with ``emotion:``, ``stage:``, ``ref:``, ``key:``, ``tempo:``, and
 * ``time:`` prefixes get distinct colours; unknown namespaces fall back to a
 * neutral style.
 *
 * ``ref:`` pills are special: when the value is a URL (starts with http:// or
 * https://) the pill links directly to that external resource rather than to
 * the namespace search page â€” these represent musical inspiration references.
 */
function tagPill(tag) {
  const colonIdx = tag.indexOf(':');
  const ns  = colonIdx >= 0 ? tag.slice(0, colonIdx).toLowerCase() : '';
  const val = colonIdx >= 0 ? tag.slice(colonIdx + 1) : tag;
  const colourClass = {
    emotion: 'pill-emotion',
    stage:   'pill-stage',
    ref:     'pill-ref',
    key:     'pill-key',
    tempo:   'pill-tempo',
    time:    'pill-time',
    meter:   'pill-time',
  }[ns] || 'pill-generic';

  // ref: tags link directly to the URL when the value is an external link
  const isRefUrl = ns === 'ref' && /^https?:\/\//.test(val);
  const href = isRefUrl
    ? val
    : (ns ? `${base}/tags?namespace=${encodeURIComponent(ns)}` : null);
  const target = isRefUrl ? ' target="_blank" rel="noopener noreferrer"' : '';
  const inner = ns
    ? `<span class="pill-ns">${escHtml(ns)}</span><span class="pill-sep">:</span>${escHtml(val)}`
    : escHtml(tag);
  return href
    ? `<a class="muse-pill ${colourClass}"${target} href="${escHtml(href)}">${inner}</a>`
    : `<span class="muse-pill ${colourClass}">${inner}</span>`;
}

/** Build a 2-sentence prose description of this commit from available data.
 *
 * Synthesises a human-readable summary from the structural diff (file counts,
 * dimensions) and analysis results (key, tempo, emotion) so users get an
 * at-a-glance narrative without needing to parse raw metadata.
 *
 * @param {object|null} key      Key analysis result or null
 * @param {object|null} tempo    Tempo analysis result or null
 * @param {object|null} meter    Meter analysis result or null
 * @param {object|null} emotion  Emotion analysis result or null
 * @param {object|null} diffData Diff-summary result or null
 * @param {number}      numObjects Number of artifact objects
 * @returns {string} Two-sentence prose summary HTML or empty string
 */
function buildProseSummary(key, tempo, meter, emotion, diffData, numObjects) {
  const parts1 = [];
  if (key)   parts1.push(`in ${escHtml(key.tonic)} ${escHtml(key.mode)}`);
  if (tempo) parts1.push(`at ${escHtml(String(tempo.bpm))} BPM`);
  if (meter) parts1.push(`in ${escHtml(meter.timeSignature)}`);

  let sentence1 = numObjects > 0
    ? `This commit contains ${numObjects} artifact${numObjects !== 1 ? 's' : ''}${parts1.length ? ' ' + parts1.join(', ') : ''}.`
    : parts1.length
      ? `This commit records musical content ${parts1.join(', ')}.`
      : '';

  const dims = diffData && diffData.dimensions
    ? diffData.dimensions.filter(d => d.score >= 0.15).map(d => escHtml(d.dimension))
    : [];
  const emotionStr = emotion ? escHtml(emotion.primaryEmotion) : '';

  let sentence2 = '';
  if (dims.length && emotionStr) {
    sentence2 = `The primary musical changes are ${dims.join(' and ')}, carrying a ${emotionStr} character.`;
  } else if (dims.length) {
    sentence2 = `The primary musical changes are ${dims.join(' and ')}.`;
  } else if (emotionStr) {
    sentence2 = `The musical character is ${emotionStr}.`;
  }

  if (!sentence1 && !sentence2) return '';
  return `<p class="commit-prose-summary text-sm">${[sentence1, sentence2].filter(Boolean).join(' ')}</p>`;
}

/** Load the muse tags + analysis metadata panel.
 *
 * Accepts the commit's own ``tags`` array (from the DB) so they can be
 * rendered alongside analysis-derived pills with proper namespace colours.
 * All analysis fetches are fire-and-forget; individual failures are non-fatal.
 *
 * @param {string[]} commitTags Commit's own tags from the DB (may be empty)
 * @param {object|null} diffData Pre-fetched diff-summary (may be null)
 * @param {number} numObjects Number of artifacts attached to this commit
 */
async function loadMuseTagsPanel(commitTags, diffData, numObjects) {
  const el = document.getElementById('muse-tags-panel');
  if (!el) return;

  // Fire all analysis fetches concurrently; individual failures are non-fatal.
  const [keyRes, tempoRes, meterRes, emotionRes] = await Promise.allSettled([
    apiFetch('/repos/' + repoId + '/analysis/' + encodeURIComponent(commitId) + '/key'),
    apiFetch('/repos/' + repoId + '/analysis/' + encodeURIComponent(commitId) + '/tempo'),
    apiFetch('/repos/' + repoId + '/analysis/' + encodeURIComponent(commitId) + '/meter'),
    apiFetch('/repos/' + repoId + '/analysis/' + encodeURIComponent(commitId) + '/emotion'),
  ]);

  const key     = keyRes.status     === 'fulfilled' ? keyRes.value     : null;
  const tempo   = tempoRes.status   === 'fulfilled' ? tempoRes.value   : null;
  const meter   = meterRes.status   === 'fulfilled' ? meterRes.value   : null;
  const emotion = emotionRes.status === 'fulfilled' ? emotionRes.value : null;

  // Build tag pills from each analysis result (synthetic, from audio analysis)
  const analysisPills = [];
  if (key)     analysisPills.push(tagPill('key:' + key.tonic + ' ' + key.mode));
  if (tempo)   analysisPills.push(tagPill('tempo:' + tempo.bpm + 'bpm'));
  if (meter)   analysisPills.push(tagPill('time:' + meter.timeSignature));
  if (emotion) analysisPills.push(tagPill('emotion:' + emotion.primaryEmotion));
  if (emotion && emotion.valence != null) {
    const v = parseFloat(emotion.valence);
    const stage = v > 0.6 ? 'positive' : v < 0.4 ? 'tense' : 'neutral';
    analysisPills.push(tagPill('stage:' + stage));
  }

  // Render the commit's own DB tags with proper namespace pill colours.
  // ref:* tags whose value is a URL become direct external links.
  const dbPills = (commitTags || []).map(t => tagPill(t));

  // Combine: DB tags first (authoritative), then analysis-derived tags
  const allPills = [...dbPills, ...analysisPills];

  // Build prose metadata cells (structured data grid)
  const cells = [];
  if (key) cells.push(`
    <div class="meta-item">
      <span class="meta-label">Key</span>
      <span class="meta-value text-sm">
        â™­ ${escHtml(key.tonic)} ${escHtml(key.mode)}
        <span class="text-muted">${(key.keyConfidence * 100).toFixed(0)}%</span>
      </span>
    </div>`);
  if (tempo) cells.push(`
    <div class="meta-item">
      <span class="meta-label">Tempo</span>
      <span class="meta-value text-sm">â± ${escHtml(String(tempo.bpm))} BPM
        ${tempo.timeFeel ? `<span class="text-muted">${escHtml(tempo.timeFeel)}</span>` : ''}
      </span>
    </div>`);
  if (meter) cells.push(`
    <div class="meta-item">
      <span class="meta-label">Time sig.</span>
      <span class="meta-value text-sm">${escHtml(meter.timeSignature)}</span>
    </div>`);
  if (emotion) cells.push(`
    <div class="meta-item">
      <span class="meta-label">Emotion</span>
      <span class="meta-value text-sm">
        ${escHtml(emotion.primaryEmotion)}
        <span class="text-muted">${(emotion.confidence * 100).toFixed(0)}%</span>
      </span>
    </div>`);

  const proseSummary = buildProseSummary(key, tempo, meter, emotion, diffData, numObjects);

  if (!cells.length && !allPills.length && !proseSummary) {
    el.innerHTML = '<p class="text-muted text-sm">No analysis data available for this commit.</p>';
    return;
  }

  el.innerHTML = `
    ${proseSummary}
    ${cells.length ? `<div class="meta-row muse-tags-meta-row" style="grid-template-columns:repeat(auto-fill,minmax(140px,1fr));margin-bottom:var(--space-3)">${cells.join('')}</div>` : ''}
    ${allPills.length ? `<div class="muse-pills-row">${allPills.join('')}</div>` : ''}`;
}

// â”€â”€ Cross-references panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadCrossReferences() {
  const el = document.getElementById('xrefs-body');
  if (!el) return;

  const shortHash = commitId.substring(0, 8);

  // Fetch PRs, issues, and sessions in parallel; each failure is non-fatal.
  const [prsRes, issuesRes, sessionsRes] = await Promise.allSettled([
    apiFetch('/repos/' + repoId + '/pull-requests?limit=100'),
    apiFetch('/repos/' + repoId + '/issues?limit=100'),
    apiFetch('/repos/' + repoId + '/sessions?limit=50'),
  ]);

  const prs      = (prsRes.status      === 'fulfilled' ? prsRes.value.pullRequests      : null) || [];
  const issues   = (issuesRes.status   === 'fulfilled' ? issuesRes.value.issues          : null) || [];
  const sessions = (sessionsRes.status === 'fulfilled' ? sessionsRes.value.sessions      : null) || [];

  // PRs that mention this commit in description or title
  const refPrs = prs.filter(pr =>
    (pr.description || '').includes(commitId.substring(0, 7)) ||
    (pr.description || '').includes(shortHash) ||
    (pr.fromBranch || '').includes(shortHash)
  );

  // Issues that mention this commit hash
  const refIssues = issues.filter(i =>
    (i.body || '').includes(commitId.substring(0, 7)) ||
    (i.body || '').includes(shortHash) ||
    (i.title || '').includes(shortHash)
  );

  // Sessions that contain this commit ID
  const refSessions = sessions.filter(s =>
    (s.commitIds || []).includes(commitId) ||
    (s.description || '').includes(shortHash)
  );

  if (!refPrs.length && !refIssues.length && !refSessions.length) {
    el.innerHTML = '<p class="text-muted text-sm" style="margin:0">No cross-references found for this commit.</p>';
    return;
  }

  let html = '';

  if (refPrs.length) {
    html += `<div class="xref-group">
      <div class="xref-group-label">Pull Requests (${refPrs.length})</div>
      <div class="xref-list">
        ${refPrs.map(pr => `
          <div class="xref-item">
            <span class="xref-icon ${pr.state === 'open' ? 'xref-open' : 'xref-closed'}">âŠ•</span>
            <a href="${base}/pulls/${encodeURIComponent(pr.prId)}" class="xref-link">
              ${escHtml(pr.title)}
            </a>
            <span class="xref-meta">#${escHtml(String(pr.prId))} Â· ${escHtml(pr.fromBranch || '')} â†’ ${escHtml(pr.toBranch || '')}</span>
          </div>`).join('')}
      </div>
    </div>`;
  }

  if (refIssues.length) {
    html += `<div class="xref-group">
      <div class="xref-group-label">Issues (${refIssues.length})</div>
      <div class="xref-list">
        ${refIssues.map(i => `
          <div class="xref-item">
            <span class="xref-icon ${i.state === 'open' ? 'xref-open' : 'xref-closed'}">â—</span>
            <a href="${base}/issues/${encodeURIComponent(i.number)}" class="xref-link">
              ${escHtml(i.title)}
            </a>
            <span class="xref-meta">#${escHtml(String(i.number))}</span>
          </div>`).join('')}
      </div>
    </div>`;
  }

  if (refSessions.length) {
    html += `<div class="xref-group">
      <div class="xref-group-label">Sessions (${refSessions.length})</div>
      <div class="xref-list">
        ${refSessions.map(s => `
          <div class="xref-item">
            <span class="xref-icon xref-session">ğŸ™</span>
            <a href="${base}/sessions/${encodeURIComponent(s.sessionId)}" class="xref-link">
              ${escHtml(s.title || s.sessionId.substring(0, 8))}
            </a>
            <span class="xref-meta">${fmtDate(s.startedAt || s.createdAt || '')}</span>
          </div>`).join('')}
      </div>
    </div>`;
  }

  el.innerHTML = html;
}

async function load() {
  initRepoNav(repoId);
  try {
    const [commitsData, objectsData, diffData] = await Promise.all([
      apiFetch('/repos/' + repoId + '/commits?limit=200'),
      apiFetch('/repos/' + repoId + '/objects'),
      apiFetch('/repos/' + repoId + '/commits/' + commitId + '/diff-summary').catch(() => null),
    ]);

    const commit = (commitsData.commits || []).find(c => c.commitId === commitId);
    const allCommits = commitsData.commits || [];
    const objects = objectsData.objects || [];
    const repoName = repoId;

    if (!commit) {
      document.getElementById('content').innerHTML =
        '<div class="card"><p class="error">Commit ' + escHtml(commitId) + ' not found in recent history.</p></div>';
      return;
    }

    const parsed  = parseCommitMessage(commit.message);
    const meta    = parseCommitMeta(commit.message);
    const instruments = parseInstruments(commit.message);

    // â”€â”€ Badges: type, scope, dimensions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const typeBadge  = commitTypeBadge(parsed.type);
    const scopeBadge = commitScopeBadge(parsed.scope);
    const dimBadges  = diffData
      ? diffData.dimensions.filter(d => d.score >= 0.15).map(dimBadge).join('')
      : '';

    // â”€â”€ Parent + child links â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const parentLinks = (commit.parentIds || []).length > 0
      ? commit.parentIds.map(p =>
          `<a href="${base}/commits/${p}" class="text-mono text-sm" title="View parent commit">${p.substring(0,8)}</a>`
        ).join(' ')
      : '<span class="text-muted text-sm">none (root commit)</span>';

    const childLinks = buildChildLinks(allCommits, commit.commitId, base);

    // â”€â”€ Instrument tags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const instTags = instruments.length > 0
      ? instruments.map(i => `<span class="nav-meta-tag">ğŸ¸ ${escHtml(i)}</span>`).join('')
      : '';

    // â”€â”€ Tags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const tags = commit.tags || [];
    const tagSection = tagBadges(tags);

    // â”€â”€ Parent objects for before/after comparison â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const parentId = (commit.parentIds || [])[0] || null;
    let parentObjects = [];
    if (parentId) {
      try {
        const parentData = await apiFetch('/repos/' + repoId + '/objects?commit_id=' + parentId);
        parentObjects = parentData.objects || [];
      } catch(_) { /* non-fatal */ }
    }
    const currentAudio = objects.filter(o => AUDIO_EXTS.has(o.path.split('.').pop().toLowerCase()));
    const parentAudio  = parentObjects.filter(o => AUDIO_EXTS.has(o.path.split('.').pop().toLowerCase()));

    // â”€â”€ Stem Browser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const audioFiles = currentAudio;
    const stemBrowser = audioFiles.length > 1
      ? `<div class="card">
          <h2 style="margin-bottom:var(--space-3)">ğŸ™ Stem Browser</h2>
          <p class="text-sm text-muted" style="margin-bottom:var(--space-3)">Solo individual instrument stems.</p>
          <div class="stem-browser" id="stem-browser">
            ${audioFiles.map((obj, i) => {
              const name = obj.path.split('/').pop().replace(/\.[^.]+$/, '');
              const url  = '/api/v1/musehub/repos/' + repoId + '/objects/' + obj.objectId + '/content';
              return `<div class="stem-row" id="stem-row-${i}">
                <button class="player-btn" onclick="queueAudio('${url}','${escHtml(name)}','')" title="Play stem">â–¶</button>
                <span class="stem-label">${escHtml(name)}</span>
                <div class="waveform-bar" style="flex:1;height:32px;cursor:pointer" onclick="queueAudio('${url}','${escHtml(name)}','')">
                  ${Array.from({length: 48}, (_, j) => {
                    const seed = (name.charCodeAt(j % name.length) + j) * 1103515245;
                    const h = 20 + (Math.abs(seed) % 70);
                    return '<div class="wave-col" style="height:' + h + '%"></div>';
                  }).join('')}
                </div>
              </div>`;
            }).join('')}
          </div>
        </div>`
      : '';

    // â”€â”€ Full artifact browser organized by type â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const artifactSection = buildArtifactSections(objects, repoName);

    // â”€â”€ Musical metadata derived from meta + commit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const musicalMeta = [
      meta.key   ? `<div class="meta-item"><span class="meta-label">Key</span><span class="meta-value text-sm">â™­ ${escHtml(meta.key)}</span></div>` : '',
      (meta.tempo || meta.bpm) ? `<div class="meta-item"><span class="meta-label">Tempo</span><span class="meta-value text-sm">â± ${escHtml(meta.tempo || meta.bpm)} BPM</span></div>` : '',
      meta.section ? `<div class="meta-item"><span class="meta-label">Section</span><span class="meta-value badge badge-dim-structural">${escHtml(meta.section)}</span></div>` : '',
      meta.meter  ? `<div class="meta-item"><span class="meta-label">Meter</span><span class="meta-value text-sm">${escHtml(meta.meter)}</span></div>` : '',
    ].filter(Boolean).join('');

    document.getElementById('content').innerHTML = `
      <div class="commit-liner-notes">

        <!-- Commit identity row -->
        <div class="commit-header-row">
          <div class="commit-header-left">
            ${typeBadge}${scopeBadge}
            ${instTags}
            ${tagSection}
          </div>
          <div class="commit-header-right">
            <a href="${base}/commits/${commitId}/diff" class="btn btn-secondary btn-sm">
              âŠ• Musical Diff
            </a>
            <a href="${base}/context/${commitId}" class="btn btn-secondary btn-sm">
              ğŸ§  AI Context
            </a>
            <button class="btn btn-primary btn-sm" onclick="openCompose()">
              ğŸµ Compose Variation
            </button>
          </div>
        </div>

        <!-- Dimension diff badges -->
        ${dimBadges ? `<div class="card dim-badges-card">
          <div class="dim-badges-label">Musical Changes</div>
          <div class="dim-badges-row">${dimBadges}</div>
        </div>` : ''}

        <!-- Commit message as liner notes headline -->
        <div class="card commit-message-card">
          <h1 class="commit-subject">${escHtml(parsed.subject || commit.message)}</h1>
          ${parsed.type || parsed.scope ? `
          <div style="margin-top:var(--space-2);font-size:var(--font-size-sm);color:var(--text-muted)">
            ${parsed.type ? `<strong>${escHtml(parsed.type)}</strong>` : ''}
            ${parsed.scope ? ` in <strong>${escHtml(parsed.scope)}</strong>` : ''}
          </div>` : ''}
          ${renderCommitBody(commit.message)}
        </div>

        <!-- Inline audio hero player (WaveSurfer.js) -->
        <div class="card iap-card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-3)">
            <h2 style="margin:0">ğŸ§ Listen</h2>
            <a href="${listenUrl}" class="btn btn-secondary btn-sm" target="_blank">
              Open Full Listen Page â†—
            </a>
          </div>
          <div id="inline-player-root">
            <p class="text-muted text-sm">Loading audioâ€¦</p>
          </div>
        </div>

        <!-- Muse tags / analysis metadata panel -->
        <div class="card">
          <h2 style="margin:0 0 var(--space-3) 0">ğŸ· Muse Tags &amp; Metadata</h2>
          <div id="muse-tags-panel"><p class="loading text-sm">Loading analysisâ€¦</p></div>
        </div>

        <!-- Commit metadata grid -->
        <div class="card">
          <div class="meta-row" style="grid-template-columns:repeat(auto-fill,minmax(160px,1fr))">
            <div class="meta-item">
              <span class="meta-label">Author</span>
              <span class="meta-value">
                <a href="/musehub/ui/users/${escHtml(commit.author)}" class="text-sm">${escHtml(commit.author)}</a>
              </span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Date</span>
              <span class="meta-value text-sm">${fmtDate(commit.timestamp)}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Branch</span>
              <span class="meta-value text-mono text-sm">${escHtml(commit.branch || 'â€”')}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">SHA</span>
              <span class="meta-value" style="display:flex;align-items:center;gap:var(--space-1)">
                <span class="text-mono text-sm sha-full" title="${escHtml(commitId)}">${escHtml(commitId)}</span>
                <button class="btn btn-ghost btn-xs copy-btn" onclick="copyToClipboard('${escHtml(commitId)}', this)" title="Copy full SHA">â§‰</button>
              </span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Parents</span>
              <span class="meta-value">${parentLinks}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Children</span>
              <span class="meta-value">${childLinks}</span>
            </div>
            ${musicalMeta}
          </div>
        </div>

        <!-- Before / After audio comparison -->
        ${buildBeforeAfterAudio(currentAudio, parentAudio, repoId)}

        <!-- Stem Browser -->
        ${stemBrowser}

        <!-- Artifacts organized by type -->
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-3)">
            <h2 style="margin:0">Artifacts (${objects.length})</h2>
            ${audioFiles.length > 0 ? `
            <button class="btn btn-primary btn-sm"
                    onclick="queueAudio('/api/v1/musehub/repos/${repoId}/objects/${audioFiles[0].objectId}/content',
                    '${escHtml(audioFiles[0].path.split('/').pop())}', '${escHtml(repoId)}')">
              â–¶ Play Latest
            </button>` : ''}
          </div>
          ${artifactSection}
        </div>

        <!-- Reaction bar -->
        <div class="card" style="padding:var(--space-3) var(--space-4)">
          <div id="commit-reactions"><p class="text-muted text-sm">Loading reactionsâ€¦</p></div>
        </div>

        <!-- AI summary panel (populated by loadAiSummary) -->
        <div class="card" id="ai-summary-panel" style="display:none;border-color:var(--color-accent)">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-3)">
            <h2 style="margin:0">ğŸ§  What changed musically?</h2>
            <button class="btn btn-secondary btn-sm" onclick="openCompose()">
              ğŸµ Compose Variation
            </button>
          </div>
          <div id="ai-summary-body"><p class="loading text-sm">Analyzingâ€¦</p></div>
        </div>

        <!-- Comment threads -->
        <div class="card" id="comments-section">
          <h2 style="margin:0 0 var(--space-3) 0">ğŸ’¬ Discussion</h2>
          <div id="comments-list"><p class="loading text-sm">Loading commentsâ€¦</p></div>
          <div id="new-comment-form" style="display:none;margin-top:var(--space-4)">
            <div class="comment-row" style="align-items:flex-start">
              <span class="comment-avatar" id="new-comment-avatar" style="background:var(--bg-overlay);color:var(--text-muted)">?</span>
              <div style="flex:1">
                <textarea id="new-comment-body" class="form-input comment-textarea" rows="3"
                          placeholder="Leave a commentâ€¦" style="resize:vertical"></textarea>
                <div class="comment-form-actions" style="margin-top:var(--space-2)">
                  <button id="comment-submit-btn" class="btn btn-primary btn-sm"
                          onclick="submitComment(null)">Comment</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Cross-references: PRs, issues, sessions mentioning this commit -->
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-3)">
            <h2 style="margin:0">ğŸ”— Mentioned In</h2>
          </div>
          <div id="xrefs-body"><p class="loading text-sm">Loading cross-referencesâ€¦</p></div>
        </div>

        <!-- Navigation -->
        <div style="display:flex;gap:var(--space-3);margin-top:var(--space-2);flex-wrap:wrap">
          ${commit.parentIds && commit.parentIds.length > 0
            ? `<a href="${base}/commits/${commit.parentIds[0]}" class="btn btn-secondary btn-sm">â† Parent Commit</a>`
            : ''}
          ${(allCommits.filter(c => (c.parentIds || []).includes(commitId)))[0]
            ? `<a href="${base}/commits/${allCommits.filter(c => (c.parentIds || []).includes(commitId))[0].commitId}" class="btn btn-secondary btn-sm">Child Commit â†’</a>`
            : ''}
          <a href="${base}" class="btn btn-ghost btn-sm">â† Back to commits</a>
        </div>
      </div>`;

    renderScorePreviews();
    // Hydrate image artifact cards with authed blob URLs to avoid 401
    hydrateImages();
    loadReactions('commit', commitId, 'commit-reactions');

    // Inline player: mount with all audio objects from this commit
    const playerTracks = currentAudio.map(obj => ({
      name: obj.path.split('/').pop().replace(/\.[^.]+$/, ''),
      url:  '/api/v1/musehub/repos/' + repoId + '/objects/' + obj.objectId + '/content',
    }));
    buildInlinePlayer(playerTracks);

    // Async panels â€” load after main content is painted.
    // Pass commit.tags (DB annotations) and diff data so the panel can render
    // namespaced pills and build the prose summary without re-fetching.
    loadMuseTagsPanel(commit.tags || [], diffData, objects.length);
    loadCrossReferences();

  } catch(e) {
    if (e.message !== 'auth')
      document.getElementById('content').innerHTML = '<p class="error">âœ• ' + escHtml(e.message) + '</p>';
  }
}

function renderScorePreviews() {
  document.querySelectorAll('.score-preview[data-ext="abc"]').forEach(async el => {
    try {
      const url = el.dataset.url;
      const text = await fetch(url, { headers: authHeaders() }).then(r => r.text());
      if (window.ABCJS) {
        el.innerHTML = '';
        window.ABCJS.renderAbc(el, text, { responsive: 'resize', staffwidth: el.offsetWidth || 400 });
      } else {
        el.innerHTML = '<pre style="font-size:11px;overflow-x:auto">' + escHtml(text.substring(0, 400)) + '</pre>';
      }
    } catch(e) { /* non-fatal */ }
  });
}

// â”€â”€ AI commit summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAiSummary() {
  const panel = document.getElementById('ai-summary-panel');
  const body  = document.getElementById('ai-summary-body');
  if (!panel || !body) return;
  try {
    const ctx = await apiFetch('/repos/' + repoId + '/context/' + commitId);
    const missing  = (ctx.missingElements || []);
    const suggests = ctx.suggestions || {};
    const suggKeys = Object.keys(suggests);
    let html = '';
    if (missing.length > 0) {
      html += '<p class="text-sm text-muted" style="margin-bottom:var(--space-2)">Missing elements:</p>';
      html += '<ul style="padding-left:var(--space-4);font-size:var(--font-size-sm);color:var(--color-warning)">';
      html += missing.map(m => '<li>' + escHtml(m) + '</li>').join('');
      html += '</ul>';
    }
    if (suggKeys.length > 0) {
      html += '<p class="text-sm text-muted" style="margin-top:var(--space-3);margin-bottom:var(--space-2)">Suggestions:</p>';
      html += suggKeys.map(k =>
        '<div style="margin-bottom:var(--space-2);font-size:var(--font-size-sm)">'
        + '<strong>' + escHtml(k) + '</strong>: ' + escHtml(suggests[k])
        + '</div>'
      ).join('');
    }
    if (!html) html = '<p class="text-sm text-muted">All musical dimensions look complete.</p>';
    body.innerHTML = html;
    panel.style.display = '';
  } catch(e) { /* non-critical: AI summary fails silently */ }
}

// â”€â”€ Compose Variation modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openCompose() {
  const modal = document.getElementById('compose-modal');
  if (modal) {
    modal.style.display = 'flex';
    document.getElementById('compose-output').style.display = 'none';
    document.getElementById('compose-stream').textContent = '';
  }
}

function closeCompose() {
  const modal = document.getElementById('compose-modal');
  if (modal) modal.style.display = 'none';
}

async function sendCompose() {
  const prompt = document.getElementById('compose-prompt').value.trim();
  if (!prompt) return;
  const btn    = document.getElementById('compose-send-btn');
  const output = document.getElementById('compose-output');
  const stream = document.getElementById('compose-stream');
  btn.disabled = true;
  btn.textContent = 'â³ Generatingâ€¦';
  output.style.display = '';
  stream.textContent = '';

  try {
    const res = await fetch('/api/v1/maestro/stream', {
      method: 'POST',
      headers: { ...authHeaders(), 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: prompt,
        mode: 'compose',
        repo_id: repoId,
        commit_id: commitId,
      }),
    });
    if (!res.ok) {
      stream.textContent = 'âŒ ' + res.status + ': ' + await res.text();
      return;
    }
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';
    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop() || '';
      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const data = line.slice(6).trim();
          if (data === '[DONE]') break;
          try {
            const obj = JSON.parse(data);
            if (obj.content) stream.textContent += obj.content;
            else if (obj.text)    stream.textContent += obj.text;
            else if (typeof obj === 'string') stream.textContent += obj;
          } catch { stream.textContent += data; }
          stream.scrollTop = stream.scrollHeight;
        }
      }
    }
  } catch(e) {
    stream.textContent += '\n\nâŒ ' + e.message;
  } finally {
    btn.disabled = false;
    btn.textContent = 'â™ª Re-generate';
  }
}

// â”€â”€ Comment threads â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/** Extract username from the stored JWT without a library (reads the payload claim). */
function currentUsername() {
  const tok = getToken();
  if (!tok) return null;
  try {
    const payload = JSON.parse(atob(tok.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
    return payload.sub || null;
  } catch { return null; }
}

/** Deterministic HSL avatar colour from a username string. */
function avatarColor(username) {
  let hash = 0;
  for (let i = 0; i < username.length; i++) hash = username.charCodeAt(i) + ((hash << 5) - hash);
  return `hsl(${Math.abs(hash) % 360},55%,45%)`;
}

function avatarHtml(username) {
  const initial = escHtml((username || '?').charAt(0).toUpperCase());
  const color   = avatarColor(username || '');
  return `<span class="comment-avatar" style="background:${color}">${initial}</span>`;
}

/**
 * Render a flat list of CommentResponse objects into a threaded tree.
 * Top-level (parent_id=null) first; replies indented beneath their parent.
 */
function renderComments(comments, me) {
  const topLevel = comments.filter(c => !c.parent_id);
  const replies  = comments.filter(c =>  c.parent_id);

  if (topLevel.length === 0 && !me) {
    return '<p class="text-sm text-muted" style="margin:0">No comments yet.</p>';
  }
  if (topLevel.length === 0) {
    return '<p class="text-sm text-muted" style="margin:0">Be the first to comment.</p>';
  }

  return topLevel.map(c => commentHtml(c, replies, me)).join('');
}

function commentHtml(c, allReplies, me) {
  const isOwn      = me && c.author === me;
  const threadReplies = allReplies.filter(r => r.parent_id === c.comment_id);

  return `
<div class="comment-thread" id="comment-${escHtml(c.comment_id)}">
  <div class="comment-row">
    ${avatarHtml(c.author)}
    <div class="comment-body-col">
      <div class="comment-meta">
        <a href="/musehub/ui/users/${encodeURIComponent(c.author)}" class="comment-author">${escHtml(c.author)}</a>
        <span class="comment-ts" title="${escHtml(c.created_at)}">${fmtRelative(c.created_at)}</span>
      </div>
      <div class="comment-text">${escHtml(c.body)}</div>
      <div class="comment-actions">
        ${me ? `<button class="btn btn-ghost btn-xs" onclick="showReplyForm('${escHtml(c.comment_id)}')">â†© Reply</button>` : ''}
        ${isOwn ? `<button class="btn btn-ghost btn-xs comment-delete-btn" onclick="deleteComment('${escHtml(c.comment_id)}')">ğŸ—‘</button>` : ''}
      </div>
      <div class="reply-form-slot" id="reply-slot-${escHtml(c.comment_id)}"></div>
      ${threadReplies.length > 0 ? `<div class="comment-replies">${threadReplies.map(r => replyHtml(r, me)).join('')}</div>` : ''}
    </div>
  </div>
</div>`;
}

function replyHtml(c, me) {
  const isOwn = me && c.author === me;
  return `
<div class="comment-row comment-reply-row" id="comment-${escHtml(c.comment_id)}">
  ${avatarHtml(c.author)}
  <div class="comment-body-col">
    <div class="comment-meta">
      <a href="/musehub/ui/users/${encodeURIComponent(c.author)}" class="comment-author">${escHtml(c.author)}</a>
      <span class="comment-ts" title="${escHtml(c.created_at)}">${fmtRelative(c.created_at)}</span>
    </div>
    <div class="comment-text">${escHtml(c.body)}</div>
    ${isOwn ? `<div class="comment-actions"><button class="btn btn-ghost btn-xs comment-delete-btn" onclick="deleteComment('${escHtml(c.comment_id)}')">ğŸ—‘</button></div>` : ''}
  </div>
</div>`;
}

async function loadComments() {
  const el = document.getElementById('comments-section');
  if (!el) return;
  try {
    const comments = await apiFetch(`/repos/${repoId}/comments?target_type=commit&target_id=${encodeURIComponent(commitId)}`);
    const me = currentUsername();
    document.getElementById('comments-list').innerHTML = renderComments(comments, me);
    if (me) {
      const form   = document.getElementById('new-comment-form');
      const avatar = document.getElementById('new-comment-avatar');
      form.style.display = '';
      if (avatar) {
        avatar.textContent = me.charAt(0).toUpperCase();
        avatar.style.background = avatarColor(me);
        avatar.style.color = '#fff';
      }
    }
  } catch(e) {
    if (e.message !== 'auth')
      document.getElementById('comments-list').innerHTML = `<p class="error text-sm">âœ• ${escHtml(e.message)}</p>`;
  }
}

async function submitComment(parentId) {
  const textareaId = parentId ? `reply-body-${parentId}` : 'new-comment-body';
  const textarea   = document.getElementById(textareaId);
  if (!textarea) return;
  const body = textarea.value.trim();
  if (!body) return;

  const btn = parentId
    ? document.querySelector(`#reply-slot-${parentId} .comment-submit-btn`)
    : document.getElementById('comment-submit-btn');
  if (btn) { btn.disabled = true; btn.textContent = 'Postingâ€¦'; }

  try {
    await apiFetch(`/repos/${repoId}/comments`, {
      method: 'POST',
      body: JSON.stringify({ target_type: 'commit', target_id: commitId, body, parent_id: parentId || null }),
    });
    textarea.value = '';
    if (parentId) {
      document.getElementById(`reply-slot-${parentId}`).innerHTML = '';
    }
    await loadComments();
  } catch(e) {
    if (e.message !== 'auth') alert('Failed to post comment: ' + e.message);
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = 'Comment'; }
  }
}

async function deleteComment(commentId) {
  if (!confirm('Delete this comment?')) return;
  try {
    await apiFetch(`/repos/${repoId}/comments/${commentId}`, { method: 'DELETE' });
    await loadComments();
  } catch(e) {
    if (e.message !== 'auth') alert('Failed to delete: ' + e.message);
  }
}

function showReplyForm(parentId) {
  const slot = document.getElementById(`reply-slot-${parentId}`);
  if (!slot) return;
  if (slot.innerHTML.trim()) { slot.innerHTML = ''; return; }
  slot.innerHTML = `
<div class="reply-form">
  <textarea id="reply-body-${escHtml(parentId)}" class="form-input comment-textarea" rows="2"
            placeholder="Write a replyâ€¦" style="resize:vertical"></textarea>
  <div class="comment-form-actions">
    <button class="btn btn-primary btn-sm comment-submit-btn" onclick="submitComment('${escHtml(parentId)}')">Comment</button>
    <button class="btn btn-ghost btn-sm" onclick="document.getElementById('reply-slot-${escHtml(parentId)}').innerHTML=''">Cancel</button>
  </div>
</div>`;
  const ta = document.getElementById(`reply-body-${parentId}`);
  if (ta) ta.focus();
}

load();
loadAiSummary();
loadComments();
{% endraw %}
{% endblock %}

{% block body_extra %}
<script src="/musehub/static/vendor/wavesurfer.min.js"></script>
<!-- Compose Variation Modal -->
<div id="compose-modal" class="modal" style="display:none" onclick="if(event.target===this)closeCompose()">
  <div class="modal-panel" style="max-width:640px;width:100%">
    <div class="modal-header">
      <h2 style="margin:0">ğŸ§  Compose Variation</h2>
      <button class="btn btn-ghost btn-sm" onclick="closeCompose()">âœ•</button>
    </div>
    <div style="padding:var(--space-4)">
      <p class="text-sm text-muted" style="margin-bottom:var(--space-3)">
        Describe what you want Maestro to compose, using this commit as musical context.
        The AI will reason about the current key, tempo, and tracks.
      </p>
      <div class="form-group">
        <label class="form-label" for="compose-prompt">Prompt</label>
        <textarea id="compose-prompt" class="form-input" rows="4"
                  placeholder="Add a walking bass line in F minor. Keep it under 90 BPMâ€¦"
                  style="resize:vertical;width:100%;font-family:var(--font-sans)"></textarea>
      </div>
      <div style="display:flex;gap:var(--space-2);margin-top:var(--space-3)">
        <button class="btn btn-primary" id="compose-send-btn" onclick="sendCompose()">
          ğŸµ Generate
        </button>
        <button class="btn btn-secondary" onclick="closeCompose()">Cancel</button>
      </div>
      <div id="compose-output" style="margin-top:var(--space-4);display:none">
        <div class="section-title">Agent Response</div>
        <pre id="compose-stream" style="background:var(--bg-base);border:1px solid var(--border-subtle);border-radius:var(--radius-base);padding:var(--space-3);font-size:12px;max-height:300px;overflow-y:auto;white-space:pre-wrap"></pre>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/abcjs@6.4.4/dist/abcjs-basic-min.js"></script>
<style>
.commit-liner-notes { max-width: 860px; margin: 0 auto; }
/* â”€â”€ Inline Audio Player â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.iap-card { border-color: #1f6feb; background: linear-gradient(135deg,#0d1117 0%,#161b22 100%); }
.iap-title {
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-semibold);
  color: var(--text-primary);
  margin-bottom: var(--space-3);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.iap-waveform-wrap {
  min-height: 72px;
  border-radius: var(--radius-sm);
  background: #0d1117;
  border: 1px solid var(--border-subtle);
  margin-bottom: var(--space-3);
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}
.iap-waveform-placeholder {
  color: var(--text-muted);
  font-size: var(--font-size-sm);
  padding: var(--space-3);
}
.iap-controls {
  display: flex;
  align-items: center;
  gap: var(--space-3);
}
.iap-play-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #1f6feb;
  border: none;
  color: #fff;
  font-size: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: background 0.15s, transform 0.1s;
}
.iap-play-btn:hover { background: #388bfd; transform: scale(1.05); }
.iap-progress-bar {
  height: 6px;
  background: #21262d;
  border-radius: 3px;
  cursor: pointer;
  position: relative;
  margin-bottom: 4px;
}
.iap-progress-fill {
  height: 100%;
  background: #1f6feb;
  border-radius: 3px;
  width: 0%;
  pointer-events: none;
  transition: width 0.1s linear;
}
.iap-time-row {
  display: flex;
  justify-content: space-between;
  font-size: 11px;
  color: var(--text-muted);
  font-variant-numeric: tabular-nums;
}
.iap-volume-wrap {
  display: flex;
  align-items: center;
  gap: var(--space-1);
  flex-shrink: 0;
  font-size: var(--font-size-sm);
  color: var(--text-muted);
}
.iap-volume-slider {
  width: 72px;
  accent-color: #1f6feb;
  cursor: pointer;
}
.iap-track-selector {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  margin-top: var(--space-3);
}
.iap-track-label {
  font-size: var(--font-size-xs);
  color: var(--text-muted);
  white-space: nowrap;
}
.iap-track-select {
  flex: 1;
  font-size: var(--font-size-sm);
  background: var(--bg-overlay);
  border: 1px solid var(--border-default);
  color: var(--text-primary);
  border-radius: var(--radius-sm);
  padding: 4px 8px;
}
/* â”€â”€ Muse tags / metadata pills â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.commit-prose-summary {
  color: var(--text-secondary);
  line-height: 1.6;
  margin: 0 0 var(--space-3) 0;
  padding-bottom: var(--space-3);
  border-bottom: 1px solid var(--border-subtle);
}
.muse-tags-meta-row { margin-bottom: var(--space-3); }
.muse-pills-row {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-2);
}
.muse-pill {
  display: inline-flex;
  align-items: center;
  gap: 2px;
  padding: 3px 10px;
  border-radius: var(--radius-full);
  font-size: var(--font-size-xs);
  font-weight: var(--font-weight-medium);
  text-decoration: none;
  white-space: nowrap;
  border: 1px solid transparent;
  transition: filter 0.1s;
}
.muse-pill:hover { filter: brightness(1.15); }
.pill-ns { opacity: 0.7; font-weight: var(--font-weight-normal); }
.pill-sep { opacity: 0.4; margin: 0 1px; }
.pill-emotion { background: #2d1b45; color: #c084fc; border-color: #7c3aed44; }
.pill-stage   { background: #1a2e3a; color: #67e8f9; border-color: #0e7490; }
.pill-ref     { background: #1e2a1e; color: #86efac; border-color: #166534; }
.pill-key     { background: #3a2e0a; color: #fde047; border-color: #854d0e; }
.pill-tempo   { background: #3a1515; color: #fca5a5; border-color: #991b1b; }
.pill-time    { background: #1e1a3a; color: #a5b4fc; border-color: #3730a3; }
.pill-generic { background: var(--bg-overlay); color: var(--text-secondary); border-color: var(--border-subtle); }
/* â”€â”€ Cross-references â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.xref-group { margin-bottom: var(--space-4); }
.xref-group:last-child { margin-bottom: 0; }
.xref-group-label {
  font-size: var(--font-size-xs);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-muted);
  margin-bottom: var(--space-2);
}
.xref-list { display: flex; flex-direction: column; gap: var(--space-2); }
.xref-item {
  display: flex;
  align-items: baseline;
  gap: var(--space-2);
  font-size: var(--font-size-sm);
}
.xref-icon { flex-shrink: 0; font-size: 12px; }
.xref-open    { color: #3fb950; }
.xref-closed  { color: #8b949e; }
.xref-session { color: #f0883e; }
.xref-link {
  color: var(--text-primary);
  text-decoration: none;
  flex: 1;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.xref-link:hover { text-decoration: underline; }
.xref-meta {
  flex-shrink: 0;
  color: var(--text-muted);
  font-size: var(--font-size-xs);
}
.commit-header-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: var(--space-2);
  margin-bottom: var(--space-3);
  padding: var(--space-2) 0;
}
.commit-header-left { display: flex; gap: var(--space-2); flex-wrap: wrap; align-items: center; }
.commit-header-right { display: flex; gap: var(--space-2); flex-wrap: wrap; }
.commit-message-card { border-left: 3px solid var(--color-accent); }
.commit-subject {
  font-size: var(--font-size-xl);
  font-weight: var(--font-weight-semibold);
  color: var(--text-primary);
  margin: 0;
  line-height: var(--line-height-tight);
}
.commit-body {
  margin-top: var(--space-3);
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.commit-body-line {
  display: block;
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
  white-space: pre-wrap;
  line-height: 1.6;
}
/* â”€â”€ Dimension badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.dim-badges-card { padding: var(--space-3); }
.dim-badges-label {
  font-size: var(--font-size-xs);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-muted);
  margin-bottom: var(--space-2);
}
.dim-badges-row { display: flex; gap: var(--space-2); flex-wrap: wrap; }
.badge-dim-dim-none    { background: var(--bg-overlay); color: var(--text-muted); }
.badge-dim-dim-low     { background: #1a3a2a; color: #4ade80; border: 1px solid #166534; }
.badge-dim-dim-medium  { background: #3a2e0a; color: #facc15; border: 1px solid #854d0e; }
.badge-dim-dim-high    { background: #3a1515; color: #f87171; border: 1px solid #991b1b; }
.badge[class*="badge-dim-"] {
  display: inline-flex;
  align-items: center;
  gap: var(--space-1);
  padding: 2px 8px;
  border-radius: var(--radius-full);
  font-size: var(--font-size-xs);
  font-weight: var(--font-weight-medium);
}
.dim-pct {
  font-weight: var(--font-weight-normal);
  opacity: 0.8;
  font-size: 10px;
}
/* â”€â”€ SHA copy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sha-full {
  max-width: 120px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  display: inline-block;
  vertical-align: middle;
}
.copy-btn {
  padding: 1px 5px;
  font-size: 11px;
  line-height: 1.2;
  border-radius: var(--radius-sm);
  cursor: pointer;
  flex-shrink: 0;
}
/* â”€â”€ Tags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.badge-tag {
  background: #1e2a3a;
  color: #60a5fa;
  border: 1px solid #1d4ed8;
  padding: 2px 8px;
  border-radius: var(--radius-full);
  font-size: var(--font-size-xs);
}
/* â”€â”€ Before/After audio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ab-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--space-4);
}
@media (max-width: 600px) { .ab-container { grid-template-columns: 1fr; } }
.ab-player {
  padding: var(--space-3);
  background: var(--bg-overlay);
  border-radius: var(--radius-base);
  border: 1px solid var(--border-subtle);
  display: flex;
  flex-direction: column;
  gap: var(--space-1);
}
.ab-label {
  font-size: var(--font-size-xs);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-muted);
  margin-bottom: var(--space-1);
}
/* â”€â”€ Artifacts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.artifact-section { margin-bottom: var(--space-4); }
.artifact-section:last-child { margin-bottom: 0; }
.artifact-section-title {
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  color: var(--text-secondary);
  margin: 0 0 var(--space-2) 0;
  padding-bottom: var(--space-1);
  border-bottom: 1px solid var(--border-subtle);
}
.artifact-count {
  font-weight: var(--font-weight-normal);
  color: var(--text-muted);
}
.artifact-card--meta {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
}
.meta-file-icon {
  font-size: 2rem;
  color: var(--text-muted);
  font-family: var(--font-mono);
  margin-bottom: var(--space-1);
}
/* â”€â”€ MIDI + Score previews â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.midi-preview {
  background: var(--bg-overlay);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-sm);
  padding: var(--space-3);
  min-height: 60px;
}
.midi-roll-placeholder {
  color: var(--text-muted);
  font-size: var(--font-size-sm);
}
/* â”€â”€ Stem browser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stem-browser { display: flex; flex-direction: column; gap: var(--space-2); }
.stem-row {
  display: flex;
  align-items: center;
  gap: var(--space-3);
  padding: var(--space-2);
  border-radius: var(--radius-sm);
  background: var(--bg-overlay);
}
.stem-label {
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
  min-width: 100px;
  flex-shrink: 0;
  font-family: var(--font-mono);
}
/* â”€â”€ Comment threads â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.comment-thread { margin-bottom: var(--space-4); }
.comment-thread:last-child { margin-bottom: 0; }
.comment-row {
  display: flex;
  gap: var(--space-3);
  align-items: flex-start;
}
.comment-reply-row { margin-top: var(--space-3); }
.comment-avatar {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  font-size: 13px;
  font-weight: var(--font-weight-semibold);
  color: #fff;
  flex-shrink: 0;
}
.comment-body-col { flex: 1; min-width: 0; }
.comment-meta {
  display: flex;
  align-items: baseline;
  gap: var(--space-2);
  margin-bottom: var(--space-1);
}
.comment-author {
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  color: var(--text-primary);
}
.comment-ts {
  font-size: var(--font-size-xs);
  color: var(--text-muted);
}
.comment-text {
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
  white-space: pre-wrap;
  word-break: break-word;
  line-height: 1.55;
}
.comment-actions {
  display: flex;
  gap: var(--space-1);
  margin-top: var(--space-1);
}
.comment-delete-btn { color: var(--color-danger, #f87171); }
.comment-replies {
  margin-top: var(--space-3);
  padding-left: var(--space-4);
  border-left: 2px solid var(--border-subtle);
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
}
.reply-form { margin-top: var(--space-2); }
.comment-textarea {
  width: 100%;
  font-family: var(--font-sans);
  font-size: var(--font-size-sm);
}
.comment-form-actions {
  display: flex;
  gap: var(--space-2);
  margin-top: var(--space-1);
}
</style>
{% endblock %}
