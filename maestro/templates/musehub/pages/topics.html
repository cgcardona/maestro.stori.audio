{% extends "musehub/base.html" %}

{% block title %}
  {% if mode == "topic" %}#{{ tag }} â€” Topics{% else %}Topics{% endif %}
{% endblock %}

{% block breadcrumb %}
  {% for item in breadcrumb_items %}
    {% if item.url %}
      <a href="{{ item.url }}">{{ item.label }}</a> /
    {% else %}
      {{ item.label }}
    {% endif %}
  {% endfor %}
{% endblock %}

{% block extra_css %}
<style>
.topic-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 20px;
  border: 1px solid var(--border-color, #30363d);
  background: var(--bg-overlay, #161b22);
  text-decoration: none;
  color: var(--text-secondary, #c9d1d9);
  font-size: 13px;
  transition: border-color 0.15s;
}
.topic-chip:hover { border-color: var(--accent-color, #58a6ff); }
.topic-chip-count {
  background: var(--surface-color, #21262d);
  padding: 1px 6px;
  border-radius: 10px;
  font-size: 11px;
  color: var(--text-muted, #8b949e);
}
.curated-chip {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 14px;
  background: var(--surface-color, #21262d);
  border: 1px solid var(--border-color, #30363d);
  font-size: 12px;
  color: var(--text-secondary, #c9d1d9);
  text-decoration: none;
  transition: background 0.15s;
}
.curated-chip:hover { background: var(--bg-overlay-hover, #2d333b); }
.curated-group-label {
  font-size: 14px;
  color: var(--text-muted, #8b949e);
  margin: 0 0 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.repo-card {
  display: flex;
  flex-direction: column;
  gap: 6px;
  padding: 14px;
}
.featured-card {
  padding: 16px;
  border: 1px solid var(--border-color, #30363d);
  background: linear-gradient(135deg, var(--bg-overlay, #161b22) 0%, var(--bg-primary, #0d1117) 100%);
}
.tag-badge {
  display: inline-block;
  padding: 2px 8px;
  margin: 2px 2px 0 0;
  border-radius: 12px;
  font-size: 11px;
  background: #1f6feb22;
  color: var(--accent-color, #58a6ff);
  border: 1px solid #1f6feb55;
  text-decoration: none;
}
</style>
{% endblock %}

{% block content %}
{% if mode == "index" %}
  {# â”€â”€ INDEX MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  <div style="display:grid;grid-template-columns:1fr 280px;gap:24px;align-items:start">
    <div>
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px">
        <h1 style="margin:0;font-size:22px">ğŸ·ï¸ Topics</h1>
        <span style="color:var(--text-muted,#8b949e);font-size:14px">
          {{ total }} topic{{ "" if total == 1 else "s" }}
        </span>
      </div>

      <div style="margin-bottom:16px">
        <input
          id="topic-filter"
          type="text"
          placeholder="Filter topicsâ€¦"
          style="width:100%;max-width:400px;padding:8px 12px;
                 background:var(--bg-primary,#0d1117);color:var(--text-secondary,#c9d1d9);
                 border:1px solid var(--border-color,#30363d);border-radius:6px;font-size:14px"
          oninput="filterTopics(this.value)"
        />
      </div>

      {# Server-rendered chip grid â€” JS filters client-side after load #}
      {% include "musehub/fragments/topic_grid.html" %}
    </div>

    <div>
      <div class="card" style="padding:16px">
        <h2 style="font-size:14px;margin:0 0 16px;color:var(--text-primary,#e6edf3)">Browse by category</h2>
        {% for group in curated_groups %}
          {% set visible = group.topics | selectattr("repo_count", "gt", 0) | list %}
          {% if visible %}
            <div style="margin-bottom:20px">
              <p class="curated-group-label">{{ group.label }}</p>
              <div style="display:flex;flex-wrap:wrap;gap:6px">
                {% for topic in visible %}
                  <a href="/musehub/ui/topics/{{ topic.name | urlencode }}"
                     class="curated-chip">
                    #{{ topic.name }}
                    <span style="color:var(--text-muted,#8b949e);font-size:11px">{{ topic.repo_count }}</span>
                  </a>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        {% endfor %}
        {% if not curated_groups %}
          <p style="color:var(--text-muted,#8b949e);font-size:13px">No curated groups available.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <script>
  (function() {
    var chips = document.querySelectorAll('.topic-chip[data-name]');
    function filterTopics(q) {
      q = q.toLowerCase().trim();
      chips.forEach(function(el) {
        el.style.display = (!q || el.dataset.name.includes(q)) ? '' : 'none';
      });
    }
    window.filterTopics = filterTopics;
    var input = document.getElementById('topic-filter');
    if (input) input.addEventListener('input', function() { filterTopics(this.value); });
  })();
  </script>

{% elif mode == "topic" %}
  {# â”€â”€ TOPIC DETAIL MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  <div style="margin-bottom:24px">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <h1 style="margin:0;font-size:24px">
        <a href="/musehub/ui/topics" style="color:var(--text-muted,#8b949e);text-decoration:none">Topics</a>
        / <span style="color:var(--accent-color,#58a6ff)">#{{ tag }}</span>
      </h1>
      <span style="color:var(--text-muted,#8b949e);font-size:14px">
        {{ total }} repo{{ "" if total == 1 else "s" }}
      </span>
    </div>
  </div>

  {% set featured = repos[:3] %}
  {% if featured %}
    <div style="margin-bottom:24px">
      <h2 style="font-size:15px;color:var(--text-muted,#8b949e);margin:0 0 12px;
                 text-transform:uppercase;letter-spacing:0.5px;font-weight:600">â­ Featured</h2>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px">
        {% for repo in featured %}
          <div class="card featured-card">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
              <a href="/musehub/ui/{{ repo.owner }}/{{ repo.slug }}"
                 style="font-weight:700;font-size:16px">{{ repo.owner }}/{{ repo.name }}</a>
              <span style="background:var(--surface-color,#21262d);padding:2px 8px;
                           border-radius:10px;font-size:12px;color:#f0b429">
                â­ {{ repo.star_count }}
              </span>
            </div>
            {% if repo.description %}
              <p style="font-size:13px;color:var(--text-muted,#8b949e);margin:0 0 10px">
                {{ repo.description }}
              </p>
            {% endif %}
            <div style="font-size:12px;color:var(--text-muted,#8b949e)">
              {% if repo.key_signature %}ğŸµ {{ repo.key_signature }}{% endif %}
              {% if repo.key_signature and repo.tempo_bpm %} &bull; {% endif %}
              {% if repo.tempo_bpm %}â™© {{ repo.tempo_bpm }} BPM{% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  {# Sort controls + repo grid (fragment for HTMX partial updates) #}
  {% include "musehub/fragments/topic_repos.html" %}

{% endif %}
{% endblock %}
