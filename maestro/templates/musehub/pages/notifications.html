{% extends "musehub/base.html" %}
{% from "musehub/macros/pagination.html" import pagination %}
{% from "musehub/macros/empty_state.html" import empty_state %}

{% block title %}Notifications{% endblock %}
{% block breadcrumb %}Notifications{% endblock %}

{% block content %}
{% if not authenticated %}
  {{ empty_state("ðŸ””", "Sign in to see notifications", "Your notifications appear here when you're signed in.") }}
{% else %}
<div class="card">
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:var(--space-2);margin-bottom:var(--space-4)">
    <h1 style="margin:0">
      Notifications
      {% if unread_count > 0 %}
        <span class="badge badge-accent" style="font-size:13px;font-weight:400;margin-left:var(--space-2)">{{ unread_count }} unread</span>
      {% endif %}
    </h1>
    {% if unread_count > 0 %}
    <button id="mark-all-read-btn" class="btn btn-secondary"
            style="font-size:12px;padding:4px 10px"
            onclick="markAllRead()">&#10003; Mark all as read</button>
    {% endif %}
  </div>

  {# Filter bar â€” HTMX form; swaps #notification-rows in-place #}
  <form method="get" action="/musehub/ui/notifications"
        hx-get="/musehub/ui/notifications"
        hx-target="#notification-rows"
        hx-push-url="true"
        style="display:flex;gap:var(--space-2);flex-wrap:wrap;margin-bottom:var(--space-3)">
    <label style="display:flex;align-items:center;gap:var(--space-2);font-size:13px;color:var(--text-muted);cursor:pointer">
      <input type="checkbox" name="unread_only" value="true"
             {% if unread_only %}checked{% endif %}
             onchange="this.form.requestSubmit()"/>
      Unread only
    </label>
    <select name="type_filter" class="filter-select"
            style="font-size:13px;padding:4px 8px;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary)"
            onchange="this.form.requestSubmit()">
      <option value="">All types</option>
      {% for et in event_types %}
        <option value="{{ et }}" {% if et == type_filter %}selected{% endif %}>{{ et | replace("_", " ") | title }}</option>
      {% endfor %}
    </select>
    {% if type_filter or unread_only %}
      <a href="/musehub/ui/notifications" class="btn btn-ghost btn-sm">Clear</a>
    {% endif %}
  </form>

  <p id="notif-error" style="color:var(--color-danger);font-size:13px;margin:0"></p>

  <div id="notification-rows">
    {% include "musehub/fragments/notification_rows.html" %}
  </div>

  {{ pagination(page, total_pages, '/musehub/ui/notifications',
                extra_params={'type_filter': type_filter or '', 'unread_only': 'true' if unread_only else ''}) }}
</div>

<script>
{# Mark a single notification as read via the existing REST action endpoint. #}
async function markOneRead(btn) {
  const notifId = btn.dataset.notifId;
  if (!notifId) return;
  const token = localStorage.getItem('stori_token') || '';
  try {
    const res = await fetch('/notifications/' + encodeURIComponent(notifId) + '/read', {
      method: 'POST',
      headers: token ? { 'Authorization': 'Bearer ' + token } : {},
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const card = document.getElementById('notif-' + notifId);
    if (card) {
      card.style.borderLeft = '3px solid transparent';
      card.style.opacity = '0.75';
      card.classList.remove('notification-unread');
    }
    btn.remove();
    decrementNavBadge();
  } catch (e) {
    document.getElementById('notif-error').textContent = 'Could not mark as read: ' + e.message;
  }
}

async function markAllRead() {
  const markAllBtn = document.getElementById('mark-all-read-btn');
  if (markAllBtn) markAllBtn.disabled = true;
  const token = localStorage.getItem('stori_token') || '';
  try {
    const res = await fetch('/notifications/read-all', {
      method: 'POST',
      headers: token ? { 'Authorization': 'Bearer ' + token } : {},
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    document.querySelectorAll('.notification-unread').forEach(card => {
      card.style.borderLeft = '3px solid transparent';
      card.style.opacity = '0.75';
      card.classList.remove('notification-unread');
      const btn = card.querySelector('.mark-read-btn');
      if (btn) btn.remove();
    });
    const badge = document.getElementById('nav-notif-badge');
    if (badge) badge.style.display = 'none';
    if (markAllBtn) markAllBtn.remove();
  } catch (e) {
    if (markAllBtn) markAllBtn.disabled = false;
    document.getElementById('notif-error').textContent = 'Could not mark all as read: ' + e.message;
  }
}

function decrementNavBadge() {
  const badge = document.getElementById('nav-notif-badge');
  if (!badge) return;
  const current = parseInt(badge.textContent, 10);
  if (isNaN(current) || current <= 1) {
    badge.style.display = 'none';
  } else {
    badge.textContent = String(current - 1);
  }
}
</script>
{% endif %}
{% endblock %}
