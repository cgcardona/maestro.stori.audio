{% extends "musehub/base.html" %}

{% block title %}Tags{% endblock %}
{% block breadcrumb %}
  <a href="/musehub/ui/{{ owner }}/{{ repo_slug }}">{{ owner }}/{{ repo_slug }}</a> / tags
{% endblock %}
{% block repo_nav %}{% include "musehub/partials/repo_nav.html" %}{% endblock %}

{% block page_data %}
const repoId    = {{ repo_id | tojson }};
const apiBase   = '/api/v1/musehub/repos/' + repoId;
const uiBase    = {{ base_url | tojson }};
const initialNs = {{ active_namespace | tojson }};
{% endblock %}

{% block page_script %}
{% raw %}
const NS_ICONS = {
  emotion:    '&#127768;',
  genre:      '&#127911;',
  instrument: '&#127929;',
  version:    '&#127991;',
  custom:     '&#127991;',
};

function nsIcon(ns) { return NS_ICONS[ns] || '&#127991;'; }

function nsColor(ns) {
  return { emotion:'#d2a8ff', genre:'#79c0ff', instrument:'#56d364',
           version:'#f0883e', custom:'#8b949e' }[ns] || '#8b949e';
}

function tagNamespace(tag) {
  return tag.includes(':') ? tag.split(':')[0] : 'version';
}

let allTags = [];
let allNamespaces = [];
let activeNs = initialNs || '';

function renderTags() {
  const filtered = activeNs ? allTags.filter(t => t.namespace === activeNs) : allTags;

  if (filtered.length === 0) {
    return '<p class="loading">No tags' + (activeNs ? ` in namespace "<strong>${escHtml(activeNs)}</strong>"` : '') + '.</p>';
  }

  // Group by namespace
  const byNs = {};
  for (const t of filtered) {
    (byNs[t.namespace] = byNs[t.namespace] || []).push(t);
  }

  return Object.entries(byNs).map(([ns, tags]) => {
    const rows = tags.map(t => {
      const sha = t.commitId ? t.commitId.substring(0, 8) : 'â€”';
      const commitUrl = t.commitId ? `${uiBase}/commits/${t.commitId}` : null;
      return `
        <div class="tag-row" style="padding:12px 0;border-bottom:1px solid #21262d">
          <div style="display:flex;align-items:flex-start;gap:12px">
            <div style="flex:1">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
                <span style="font-weight:600;font-size:14px;color:#e6edf3">${escHtml(t.tag)}</span>
              </div>
              <div style="font-size:12px;color:#8b949e;display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                ${commitUrl
                  ? `<a href="${commitUrl}" style="font-family:monospace;color:#58a6ff">${sha}</a>`
                  : '<span style="font-family:monospace;color:#8b949e">no commit</span>'}
                ${t.message ? `&bull; <span>${escHtml(t.message)}</span>` : ''}
                &bull; <span>${fmtDate(t.createdAt)}</span>
              </div>
            </div>
            ${commitUrl ? `
            <a href="${commitUrl}" class="btn btn-secondary" style="font-size:12px;padding:4px 10px;flex-shrink:0">
              View commit
            </a>` : ''}
          </div>
        </div>`;
    }).join('');

    return `
      <div class="card" style="margin-bottom:16px">
        <h2 style="margin-bottom:12px;display:flex;align-items:center;gap:8px">
          <span>${nsIcon(ns)}</span>
          <span style="color:${nsColor(ns)};text-transform:capitalize">${escHtml(ns)}</span>
          <span style="font-size:13px;font-weight:400;color:#8b949e">
            ${tags.length} tag${tags.length === 1 ? '' : 's'}
          </span>
        </h2>
        ${rows}
      </div>`;
  }).join('');
}

function setNamespace(ns) {
  activeNs = ns;
  document.getElementById('tag-count').textContent =
    (activeNs ? allTags.filter(t => t.namespace === ns).length : allTags.length)
    + ' tag' + ((activeNs ? allTags.filter(t => t.namespace === ns).length : allTags.length) === 1 ? '' : 's');
  document.getElementById('tag-list').innerHTML = renderTags();
}

async function load() {
  initRepoNav(repoId);
  try {
    // Releases are the tag source: their `tag` field carries namespaced names.
    const data = await apiFetch('/repos/' + repoId + '/releases');
    const releases = data.releases || [];

    allTags = releases.map(r => ({
      tag:       r.tag,
      namespace: tagNamespace(r.tag),
      commitId:  r.commitId || null,
      message:   r.title || '',
      createdAt: r.createdAt,
    }));

    // Collect ordered namespaces (preserve insertion order of first appearance)
    const nsSet = new Set();
    allTags.forEach(t => nsSet.add(t.namespace));
    allNamespaces = Array.from(nsSet).sort();

    const nsOptions = ['<option value="">All namespaces</option>']
      .concat(allNamespaces.map(ns =>
        `<option value="${escHtml(ns)}"${activeNs === ns ? ' selected' : ''}>${nsIcon(ns)} ${escHtml(ns)}</option>`
      )).join('');

    const totalLabel = allTags.length + ' tag' + (allTags.length === 1 ? '' : 's');

    document.getElementById('content').innerHTML = `
      <div style="margin-bottom:12px">
        <a href="${uiBase}">&larr; Back to repo</a>
      </div>
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap">
        <h1 style="margin:0">&#127991; Tags</h1>
        <select id="ns-filter" onchange="setNamespace(this.value)" style="margin-left:auto">
          ${nsOptions}
        </select>
        <span id="tag-count" style="font-size:13px;color:#8b949e">${totalLabel}</span>
      </div>
      <div id="tag-list">${renderTags()}</div>`;
  } catch(e) {
    if (e.message !== 'auth')
      document.getElementById('content').innerHTML =
        '<p class="error">&#10005; ' + escHtml(e.message) + '</p>';
  }
}

load();
{% endraw %}
{% endblock %}
