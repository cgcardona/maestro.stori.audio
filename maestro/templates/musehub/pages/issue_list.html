{% extends "musehub/base.html" %}
{% from "musehub/macros/issue.html" import issue_row %}
{% from "musehub/macros/milestone.html" import milestone_progress %}
{% from "musehub/macros/label.html" import label_chip %}
{% from "musehub/macros/pagination.html" import pagination %}
{% from "musehub/macros/empty_state.html" import empty_state %}

{% block title %}Issues â€” {{ owner }}/{{ repo_slug }}{% endblock %}
{% block breadcrumb %}
  <a href="/musehub/ui/{{ owner }}">{{ owner }}</a> /
  <a href="/musehub/ui/{{ owner }}/{{ repo_slug }}">{{ repo_slug }}</a> / issues
{% endblock %}
{% block repo_nav %}{% include "musehub/partials/repo_nav.html" %}{% endblock %}

{% block extra_css %}
<style>
/* â”€â”€ Issue list layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.issues-layout {
  display: grid;
  grid-template-columns: 220px 1fr 220px;
  gap: var(--space-4);
  align-items: start;
}
@media (max-width: 1100px) {
  .issues-layout { grid-template-columns: 200px 1fr; }
  .sidebar-right  { display: none; }
}
@media (max-width: 768px) {
  .issues-layout { grid-template-columns: 1fr; }
  .sidebar-left, .sidebar-right { display: none; }
}

/* â”€â”€ Filter sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.filter-sidebar {
  position: sticky;
  top: var(--space-4);
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
}
.filter-section {
  background: var(--color-surface-2, #161b22);
  border: 1px solid var(--color-border);
  border-radius: 6px;
  padding: var(--space-3);
}
.filter-section-title {
  font-size: 12px;
  font-weight: 600;
  color: #8b949e;
  text-transform: uppercase;
  letter-spacing: .05em;
  margin: 0 0 var(--space-2) 0;
}
.label-chip {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 500;
  cursor: pointer;
  border: 2px solid transparent;
  margin: 2px;
  transition: border-color .15s, opacity .15s;
  user-select: none;
}
.label-chip.active {
  border-color: var(--color-fg, #e6edf3);
  opacity: 1;
}
.label-chip:not(.active) { opacity: .75; }
.label-chip:hover { opacity: 1; }

.filter-select, .filter-input {
  width: 100%;
  background: var(--color-surface-3, #0d1117);
  border: 1px solid var(--color-border);
  border-radius: 4px;
  color: var(--color-fg, #e6edf3);
  font-size: 12px;
  padding: 4px 6px;
  box-sizing: border-box;
}
.filter-select:focus, .filter-input:focus {
  outline: none;
  border-color: var(--color-accent, #1f6feb);
}
.sort-radio-group { display: flex; flex-direction: column; gap: 4px; }
.sort-radio-label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--color-fg, #e6edf3);
  cursor: pointer;
}
.filter-clear-btn {
  display: block;
  width: 100%;
  background: none;
  border: 1px solid var(--color-border);
  border-radius: 4px;
  color: #8b949e;
  font-size: 11px;
  padding: 4px;
  cursor: pointer;
  text-align: center;
  text-decoration: none;
  margin-top: var(--space-2);
}
.filter-clear-btn:hover { color: var(--color-fg, #e6edf3); border-color: var(--color-fg, #e6edf3); }

/* â”€â”€ Right sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar-right {
  position: sticky;
  top: var(--space-4);
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
}
.sidebar-section {
  background: var(--color-surface-2, #161b22);
  border: 1px solid var(--color-border);
  border-radius: 6px;
  padding: var(--space-3);
}
.sidebar-section-title {
  font-size: 12px;
  font-weight: 600;
  color: #8b949e;
  text-transform: uppercase;
  letter-spacing: .05em;
  margin: 0 0 var(--space-2) 0;
}
.milestone-progress-bar-track {
  height: 6px;
  background: var(--color-surface-3, #0d1117);
  border-radius: 3px;
  overflow: hidden;
  margin-bottom: 2px;
}
.milestone-progress-bar-fill {
  height: 100%;
  background: var(--color-success, #3fb950);
  border-radius: 3px;
  transition: width .4s ease;
}
.milestone-progress-counts { font-size: 10px; color: #8b949e; }

/* â”€â”€ Bulk actions toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#bulk-toolbar {
  display: none;
  align-items: center;
  gap: var(--space-2);
  padding: var(--space-2) var(--space-3);
  background: var(--color-accent-subtle, #1c2d3f);
  border: 1px solid var(--color-accent, #1f6feb);
  border-radius: 6px;
  margin-bottom: var(--space-3);
}
#bulk-toolbar.visible { display: flex; }
#bulk-count { font-size: 13px; color: var(--color-fg, #e6edf3); font-weight: 600; }
.bulk-action-btn {
  font-size: 12px;
  padding: 4px 10px;
  border-radius: 4px;
  cursor: pointer;
  border: 1px solid var(--color-border);
  background: var(--color-surface-2, #161b22);
  color: var(--color-fg, #e6edf3);
}
#bulk-label-select, #bulk-milestone-select {
  font-size: 12px;
  padding: 4px 6px;
  border-radius: 4px;
  border: 1px solid var(--color-border);
  background: var(--color-surface-2, #161b22);
  color: var(--color-fg, #e6edf3);
}
.bulk-sep { width: 1px; height: 20px; background: var(--color-border); flex-shrink: 0; }

/* â”€â”€ Issue row checkboxes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.issue-row { display: flex; align-items: flex-start; gap: var(--space-2); }
.issue-row-check {
  width: 14px; height: 14px; margin-top: 3px; flex-shrink: 0;
  cursor: pointer; accent-color: var(--color-accent, #1f6feb);
}

/* â”€â”€ Template selector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.template-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: var(--space-3);
  margin-bottom: var(--space-3);
}
.template-card {
  border: 1px solid var(--color-border);
  border-radius: 6px;
  padding: var(--space-3);
  cursor: pointer;
  background: var(--color-surface-2, #161b22);
  transition: border-color .15s;
}
.template-card:hover { border-color: var(--color-accent, #1f6feb); }
.template-card-title { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
.template-card-desc { font-size: 11px; color: #8b949e; }
.template-card-icon { font-size: 22px; margin-bottom: 6px; }
</style>
{% endblock %}

{% block content %}
<div class="issues-layout">

  {# â”€â”€ Left filter sidebar â€” rendered server-side, no JS needed â”€â”€ #}
  <aside class="filter-sidebar" id="filter-sidebar">
    <form method="get"
          hx-get="{{ base_url }}/issues"
          hx-target="#issue-rows"
          hx-push-url="true"
          hx-indicator="#htmx-loading"
          id="issue-filter-form">

      {# Labels â€” multi-select chips #}
      <div class="filter-section" id="label-chip-container">
        <p class="filter-section-title" id="filter-labels-heading">Labels</p>
        {% if labels_data %}
          <div style="display:flex;flex-wrap:wrap;gap:2px">
            {% for lbl in labels_data %}
              <label>
                <input type="checkbox" name="label" value="{{ lbl.name }}"
                       {% if lbl.name == active_label %}checked{% endif %}
                       onchange="this.form.requestSubmit()" style="display:none"/>
                {{ label_chip(lbl.name, lbl.color, active=(lbl.name == active_label)) }}
              </label>
            {% endfor %}
          </div>
        {% else %}
          <span style="font-size:11px;color:#8b949e">No labels yet</span>
        {% endif %}
      </div>

      {# Milestone dropdown #}
      <div class="filter-section">
        <p class="filter-section-title">Milestone</p>
        <select name="milestone_id" id="filter-milestone" class="filter-select"
                onchange="this.form.requestSubmit()">
          <option value="">All milestones</option>
          {% for ms in milestones_data %}
            <option value="{{ ms.milestone_id }}"
                    {% if ms.milestone_id == active_milestone_id %}selected{% endif %}>
              {{ ms.title }}
            </option>
          {% endfor %}
        </select>
      </div>

      {# Assignee dropdown #}
      <div class="filter-section">
        <p class="filter-section-title">Assignee</p>
        <select name="assignee" id="filter-assignee" class="filter-select"
                onchange="this.form.requestSubmit()">
          <option value="">All assignees</option>
          {% for a in assignees %}
            <option value="{{ a }}" {% if a == active_assignee %}selected{% endif %}>{{ a }}</option>
          {% endfor %}
        </select>
      </div>

      {# Author text input #}
      <div class="filter-section">
        <p class="filter-section-title">Author</p>
        <input name="author" id="filter-author" type="text" class="filter-input"
               placeholder="Filter by authorâ€¦" value="{{ active_author }}"
               oninput="clearTimeout(this._t);this._t=setTimeout(()=>this.form.requestSubmit(),300)"/>
      </div>

      {# Sort radios #}
      <div class="filter-section">
        <p class="filter-section-title">Sort</p>
        <div class="sort-radio-group" id="sort-radio-group">
          {% for value, lbl in [('newest','Newest'),('oldest','Oldest'),('most-commented','Most commented')] %}
            <label class="sort-radio-label">
              <input type="radio" name="sort" value="{{ value }}"
                     {% if value == active_sort %}checked{% endif %}
                     onchange="this.form.requestSubmit()"/>
              {{ lbl }}
            </label>
          {% endfor %}
        </div>
      </div>

      {# Hidden state field so filter form preserves active tab #}
      <input type="hidden" name="state" value="{{ state }}"/>

      {% if active_label or active_milestone_id or active_assignee or active_author %}
        <a href="{{ base_url }}/issues?state={{ state }}" class="filter-clear-btn">âœ• Clear filters</a>
      {% endif %}
    </form>
  </aside>

  {# â”€â”€ Main column â”€â”€ #}
  <div style="flex:1;min-width:0">

    {# Bulk actions toolbar â€” shown via JS when checkboxes are selected #}
    <div id="bulk-toolbar" aria-live="polite">
      <span id="bulk-count"></span>
      <span class="bulk-sep"></span>
      <select id="bulk-label-select" title="Label to assign">
        <option value="">Assign labelâ€¦</option>
        {% for lbl in labels_data %}
          <option value="{{ lbl.name }}">{{ lbl.name }}</option>
        {% endfor %}
      </select>
      <button class="bulk-action-btn" onclick="bulkAssignLabel()">Apply label</button>
      <span class="bulk-sep"></span>
      <select id="bulk-milestone-select" title="Milestone to assign">
        <option value="">Assign milestoneâ€¦</option>
        {% for ms in milestones_data %}
          <option value="{{ ms.milestone_id }}">{{ ms.title }}</option>
        {% endfor %}
      </select>
      <button class="bulk-action-btn" onclick="bulkAssignMilestone()">Apply milestone</button>
      <span class="bulk-sep"></span>
      <button class="bulk-action-btn" onclick="bulkClose()">Close</button>
      <button class="bulk-action-btn" onclick="bulkReopen()">Reopen</button>
      <button class="bulk-action-btn" style="margin-left:auto"
              onclick="deselectAll()">âœ• Deselect</button>
    </div>

    <div class="card">
      {# Open / Closed tab strip #}
      <div class="tab-strip" style="display:flex;gap:0;border-bottom:1px solid var(--color-border);margin-bottom:var(--space-3)">
        <a href="{{ base_url }}/issues?state=open"
           id="tab-open"
           class="tab-btn{% if state != 'closed' %} tab-active{% endif %}"
           hx-get="{{ base_url }}/issues?state=open"
           hx-target="#issue-rows"
           hx-push-url="true">
          â—‹ Open <span class="tab-count">{{ open_count }}</span>
        </a>
        <a href="{{ base_url }}/issues?state=closed"
           id="tab-closed"
           class="tab-btn{% if state == 'closed' %} tab-active{% endif %}"
           hx-get="{{ base_url }}/issues?state=closed"
           hx-target="#issue-rows"
           hx-push-url="true">
          âœ“ Closed <span class="tab-count">{{ closed_count }}</span>
        </a>
        <div style="margin-left:auto">
          <button class="btn btn-secondary btn-sm" id="new-issue-btn"
                  onclick="showTemplatePicker()">+ New Issue</button>
        </div>
      </div>

      {# Issue rows â€” HTMX target for filter/tab swaps #}
      <div id="issue-rows">
        {% include "musehub/fragments/issue_rows.html" %}
      </div>

      {# Pagination #}
      {{ pagination(page, total_pages, base_url ~ '/issues',
                    extra_params={'state': state, 'label': active_label, 'sort': active_sort}) }}
    </div>

    {# Template picker (shown on + New Issue click) #}
    <div id="template-picker" style="display:none">
      <div class="card" style="border-color:var(--color-accent)">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-3)">
          <h2 style="margin:0">Choose a template</h2>
          <button class="btn btn-ghost btn-sm"
                  onclick="document.getElementById('template-picker').style.display='none'">âœ•</button>
        </div>
        <div class="template-grid" id="template-grid">
          {# Template cards rendered server-side so JS-off browsers see them #}
          {% for tpl in [
            {'id':'blank','icon':'ğŸ“','title':'Blank Issue','desc':'Start with a clean slate.'},
            {'id':'bug','icon':'ğŸ›','title':'Bug Report','desc':'Something isn\'t working as expected.'},
            {'id':'feature','icon':'âœ¨','title':'Feature Request','desc':'Suggest a new musical idea or capability.'},
            {'id':'arrangement','icon':'ğŸµ','title':'Arrangement Issue','desc':'Track needs musical arrangement work.'},
            {'id':'theory','icon':'ğŸ¼','title':'Music Theory','desc':'Related to harmony, rhythm, or theory decisions.'},
          ] %}
            <div class="template-card" id="template-card-{{ tpl.id }}"
                 onclick="selectTemplate('{{ tpl.id }}')">
              <div class="template-card-icon">{{ tpl.icon }}</div>
              <div class="template-card-title">{{ tpl.title }}</div>
              <div class="template-card-desc">{{ tpl.desc }}</div>
            </div>
          {% endfor %}
        </div>
        <a href="#" onclick="document.getElementById('template-picker').style.display='none';return false"
           style="font-size:12px;color:#8b949e">â† Templates</a>
      </div>
    </div>

    {# New issue form (shown after template selection) #}
    <div id="create-issue-panel" style="display:none">
      <div class="card" style="border-color:var(--color-accent)">
        <div style="display:flex;align-items:center;gap:var(--space-2);margin-bottom:var(--space-3)">
          <button class="btn btn-ghost btn-sm" onclick="showTemplatePicker()">â† Templates</button>
          <h2 style="margin:0">New Issue</h2>
        </div>
        <div class="form-group" style="margin-bottom:var(--space-3)">
          <label class="form-label" for="issue-title">Title</label>
          <input id="issue-title" class="form-input" type="text" placeholder="Brief descriptionâ€¦"/>
        </div>
        <div class="form-group" style="margin-bottom:var(--space-3)">
          <label class="form-label" for="issue-body">Description</label>
          <textarea id="issue-body" class="form-input" rows="7"
                    placeholder="Describe the musical problem or requestâ€¦"
                    style="resize:vertical;width:100%;font-family:monospace"></textarea>
        </div>
        <div style="display:flex;gap:var(--space-2)">
          <button class="btn btn-primary" onclick="createIssue()">Submit Issue</button>
          <button class="btn btn-secondary"
                  onclick="document.getElementById('create-issue-panel').style.display='none';
                           document.getElementById('template-picker').style.display='none'">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  {# â”€â”€ Right sidebar â€” milestone progress + labels summary, server-side â”€â”€ #}
  <aside class="sidebar-right" id="sidebar-right">
    <div class="sidebar-section">
      <p class="sidebar-section-title" id="milestone-progress-heading">Milestones</p>
      <div id="milestone-progress-list">
        {% for ms in milestones_data %}
          {{ milestone_progress(ms) }}
        {% else %}
          <span style="font-size:11px;color:#8b949e">No open milestones</span>
        {% endfor %}
      </div>
      {% if milestones_data %}
        <a href="{{ base_url }}/milestones"
           style="font-size:11px;color:var(--color-accent,#1f6feb);display:block;margin-top:var(--space-2)">
          View all milestones â†’
        </a>
      {% endif %}
    </div>

    <div class="sidebar-section">
      <p class="sidebar-section-title" id="labels-summary-heading">Labels</p>
      <div id="labels-summary-list">
        {% for lbl in labels_data %}
          <div class="sidebar-label-row" style="display:flex;align-items:center;margin-bottom:4px">
            <span style="width:10px;height:10px;border-radius:50%;background:{{ lbl.color }};flex-shrink:0"></span>
            <a href="{{ base_url }}/issues?label={{ lbl.name }}&state={{ state }}"
               style="font-size:12px;color:var(--color-fg,#e6edf3);flex:1;margin:0 6px">
              {{ lbl.name }}
            </a>
          </div>
        {% else %}
          <span style="font-size:11px;color:#8b949e">No labels in use</span>
        {% endfor %}
      </div>
      <a href="{{ base_url }}/labels"
         style="font-size:11px;color:var(--color-accent,#1f6feb);display:block;margin-top:var(--space-2)">
        Manage labels â†’
      </a>
    </div>
  </aside>
</div>
{% endblock %}

{% block page_script %}
{% raw %}
// â”€â”€ Minimal JS for create-issue flow and bulk toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ISSUE_TEMPLATES = [
  { id: 'blank',       icon: 'ğŸ“', title: 'Blank Issue',       body: '' },
  { id: 'bug',         icon: 'ğŸ›', title: 'Bug Report',
    body: '## What happened?\n\n\n## Steps to reproduce\n\n1. \n2. \n\n## Expected\n\n\n## Actual\n\n' },
  { id: 'feature',     icon: 'âœ¨', title: 'Feature Request',
    body: '## Summary\n\n\n## Motivation\n\n\n## Proposed approach\n\n' },
  { id: 'arrangement', icon: 'ğŸµ', title: 'Arrangement Issue',
    body: '## Track / Section\n\n\n## Current arrangement\n\n\n## Desired arrangement\n\n' },
  { id: 'theory',      icon: 'ğŸ¼', title: 'Music Theory',
    body: '## Theory concern\n\n\n## Affected section\n\n\n## Suggested resolution\n\n' },
];

function showTemplatePicker() {
  document.getElementById('template-picker').style.display = '';
  document.getElementById('create-issue-panel').style.display = 'none';
}

function selectTemplate(tplId) {
  const tpl = ISSUE_TEMPLATES.find(t => t.id === tplId);
  if (!tpl) return;
  document.getElementById('issue-body').value = tpl.body;
  document.getElementById('template-picker').style.display = 'none';
  document.getElementById('create-issue-panel').style.display = '';
  document.getElementById('issue-title').focus();
}

async function createIssue() {
  const title = document.getElementById('issue-title').value.trim();
  const body  = document.getElementById('issue-body').value.trim();
  if (!title) { alert('Please enter a title'); return; }
  try {
    await apiFetch('/repos/' + repoId + '/issues', {
      method: 'POST',
      body: JSON.stringify({ title, body }),
    });
    location.reload();
  } catch(e) {
    if (e.message !== 'auth') alert('Failed to create issue: ' + e.message);
  }
}

// â”€â”€ Checkbox selection and bulk actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const selectedIssues = new Set();

function toggleIssueSelect(issueId, checked) {
  if (checked) selectedIssues.add(issueId);
  else selectedIssues.delete(issueId);
  updateBulkToolbar();
}

function updateBulkToolbar() {
  const toolbar = document.getElementById('bulk-toolbar');
  const countEl = document.getElementById('bulk-count');
  if (!toolbar || !countEl) return;
  const n = selectedIssues.size;
  if (n > 0) {
    toolbar.classList.add('visible');
    countEl.textContent = n === 1 ? '1 issue selected' : n + ' issues selected';
  } else {
    toolbar.classList.remove('visible');
  }
}

function deselectAll() {
  selectedIssues.clear();
  document.querySelectorAll('.issue-row-check').forEach(c => { c.checked = false; });
  updateBulkToolbar();
}

function bulkClose() { alert('Bulk close coming soon'); }
function bulkReopen() { alert('Bulk reopen coming soon'); }
function bulkAssignLabel() { alert('Bulk label assignment coming soon'); }
function bulkAssignMilestone() { alert('Bulk milestone assignment coming soon'); }
{% endraw %}
{% endblock %}
