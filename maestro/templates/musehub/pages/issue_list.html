{% extends "musehub/base.html" %}

{% block title %}Issues{% endblock %}
{% block breadcrumb %}
  <a href="/musehub/ui/{{ owner }}/{{ repo_slug }}">{{ owner }}/{{ repo_slug }}</a> / issues
{% endblock %}

{% block page_data %}
const repoId = {{ repo_id | tojson }};
const base   = {{ base_url | tojson }};
{% endblock %}

{% block page_script %}
{% raw %}
function escHtml(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

async function load(state) {
  try {
    const data   = await apiFetch('/repos/' + repoId + '/issues?state=' + state);
    const issues = data.issues || [];

    const rows = issues.length === 0
      ? '<p class="loading">No issues found.</p>'
      : issues.map(i => `
        <div class="issue-row">
          <span class="badge badge-${i.state}">#${i.number}</span>
          <div style="flex:1">
            <a href="${base}/issues/${i.number}">${escHtml(i.title)}</a>
            <div style="margin-top:4px">
              ${(i.labels||[]).map(l => '<span class="label">' + escHtml(l) + '</span>').join('')}
            </div>
            <div style="font-size:12px;color:#8b949e;margin-top:2px">
              Opened ${fmtDate(i.createdAt)}
            </div>
          </div>
          <span class="badge badge-${i.state}">${i.state}</span>
        </div>`).join('');

    document.getElementById('content').innerHTML = `
      <div style="margin-bottom:12px">
        <a href="${base}">&larr; Back to repo</a>
      </div>
      <div class="card">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
          <h1 style="margin:0">Issues</h1>
          <select onchange="load(this.value)">
            <option value="open"   ${state==='open'  ?'selected':''}>Open</option>
            <option value="closed" ${state==='closed'?'selected':''}>Closed</option>
            <option value="all"    ${state==='all'   ?'selected':''}>All</option>
          </select>
        </div>
        ${rows}
      </div>`;
  } catch(e) {
    if (e.message !== 'auth')
      document.getElementById('content').innerHTML = '<p class="error">&#10005; ' + escHtml(e.message) + '</p>';
  }
}

load('open');
{% endraw %}
{% endblock %}
