{% extends "musehub/base.html" %}

{% block title %}PR {{ pr_id[:8] }} Â· {{ owner }}/{{ repo_slug }}{% endblock %}
{% block breadcrumb %}
  <a href="/musehub/ui/{{ owner }}/{{ repo_slug }}">{{ owner }}/{{ repo_slug }}</a> /
  <a href="/musehub/ui/{{ owner }}/{{ repo_slug }}/pulls">pulls</a> / {{ pr_id[:8] }}
{% endblock %}
{% block repo_nav %}{% include "musehub/partials/repo_nav.html" %}{% endblock %}

{% block page_data %}
const repoId = {{ repo_id | tojson }};
const prId   = {{ pr_id | tojson }};
const base   = {{ base_url | tojson }};
const apiBase = '/api/v1/musehub/repos/' + repoId;
{% endblock %}

{% block page_script %}
{% raw %}
// â”€â”€ Colour constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DIMENSIONS  = ['melodic','harmonic','rhythmic','structural','dynamic'];
const LEVEL_COLOR = { NONE:'#1f6feb', LOW:'#388bfd', MED:'#f0883e', HIGH:'#f85149' };
const LEVEL_BG    = { NONE:'#0d2942', LOW:'#102a4c', MED:'#341a00', HIGH:'#3d0000' };
const AXIS_LABELS = {
  melodic:'Melodic', harmonic:'Harmonic', rhythmic:'Rhythmic',
  structural:'Structural', dynamic:'Dynamic',
};

// â”€â”€ Radar SVG helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function radarSvg(dims) {
  const cx = 180, cy = 180, r = 140;
  const n = dims.length;
  const pts = dims.map((d, i) => {
    const angle = (i / n) * 2 * Math.PI - Math.PI / 2;
    const sr = d.score * r;
    return { x: cx + sr * Math.cos(angle), y: cy + sr * Math.sin(angle) };
  });
  const bgPts = DIMENSIONS.map((_, i) => {
    const angle = (i / n) * 2 * Math.PI - Math.PI / 2;
    return `${cx + r * Math.cos(angle)},${cy + r * Math.sin(angle)}`;
  }).join(' ');
  const scorePoly = pts.map(p => `${p.x},${p.y}`).join(' ');
  const axisLines = DIMENSIONS.map((_, i) => {
    const angle = (i / n) * 2 * Math.PI - Math.PI / 2;
    const ex = cx + r * Math.cos(angle), ey = cy + r * Math.sin(angle);
    return `<line x1="${cx}" y1="${cy}" x2="${ex}" y2="${ey}" stroke="#30363d" stroke-width="1"/>`;
  }).join('');
  const gridLines = [0.25, 0.5, 0.75, 1.0].map(frac => {
    const gPts = DIMENSIONS.map((_, i) => {
      const angle = (i / n) * 2 * Math.PI - Math.PI / 2;
      return `${cx + frac * r * Math.cos(angle)},${cy + frac * r * Math.sin(angle)}`;
    }).join(' ');
    return `<polygon points="${gPts}" fill="none" stroke="#21262d" stroke-width="1"/>`;
  }).join('');
  const labels = dims.map((d, i) => {
    const angle = (i / n) * 2 * Math.PI - Math.PI / 2;
    const lx = cx + (r + 22) * Math.cos(angle);
    const ly = cy + (r + 22) * Math.sin(angle);
    const color = LEVEL_COLOR[d.level] || '#8b949e';
    return `<text x="${lx}" y="${ly + 4}" text-anchor="middle"
      font-size="12" fill="${color}" font-family="system-ui">${AXIS_LABELS[d.dimension]}</text>`;
  }).join('');
  const dots = pts.map((p, i) => {
    const color = LEVEL_COLOR[dims[i].level] || '#58a6ff';
    return `<circle cx="${p.x}" cy="${p.y}" r="4" fill="${color}" stroke="#0d1117" stroke-width="2"/>`;
  }).join('');
  return `<svg viewBox="0 0 360 360" xmlns="http://www.w3.org/2000/svg"
      style="width:100%;max-width:360px;display:block;margin:0 auto">
    ${gridLines}${axisLines}
    <polygon points="${bgPts}" fill="rgba(88,166,255,0.04)" stroke="#30363d" stroke-width="1"/>
    <polygon points="${scorePoly}" fill="rgba(248,81,73,0.18)" stroke="#f85149" stroke-width="2"/>
    ${labels}${dots}
  </svg>`;
}

// â”€â”€ Diff badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function diffBadge(d) {
  const color = LEVEL_COLOR[d.level] || '#8b949e';
  const label = d.deltaLabel === 'unchanged'
    ? '<span style="color:#8b949e">unchanged</span>'
    : `<span style="color:${color};font-weight:700">${escHtml(d.deltaLabel)}%</span>`;
  return `<div class="card" style="background:${LEVEL_BG[d.level] || '#161b22'};
      display:flex;align-items:center;gap:10px;padding:var(--space-2) var(--space-3);margin-bottom:6px">
    <span style="font-size:13px;color:#e6edf3;min-width:90px;font-weight:600">
      ${AXIS_LABELS[d.dimension]}</span>
    ${label}
    <div style="flex:1;height:6px;background:#21262d;border-radius:3px;overflow:hidden">
      <div style="height:100%;width:${Math.round(d.score*100)}%;background:${color};
        border-radius:3px;transition:width .3s"></div>
    </div>
  </div>`;
}

// â”€â”€ Piano roll diff SVG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Renders a deterministic pseudo-piano-roll from branch name seeds.
// Green = added in from_branch, red = removed in from_branch, grey = unchanged.
function pianoRollSvg(fromBranch, toBranch) {
  const PITCHES = 24, STEPS = 32;
  const W = 480, H = 120;
  const sw = W / STEPS, sh = H / PITCHES;

  function refSeed(s) {
    let h = 0;
    for (let i = 0; i < s.length; i++) { h = Math.imul(31, h) + s.charCodeAt(i) | 0; }
    return h >>> 0;
  }
  function noteGrid(seed) {
    let x = seed;
    const grid = new Set();
    for (let i = 0; i < STEPS * PITCHES; i++) {
      x = (x * 1103515245 + 12345) & 0x7fffffff;
      if ((x % 100) < 22) grid.add(i);
    }
    return grid;
  }

  const toGrid   = noteGrid(refSeed(toBranch));
  const fromGrid = noteGrid(refSeed(fromBranch));

  let rects = '';
  for (let p = 0; p < PITCHES; p++) {
    for (let s = 0; s < STEPS; s++) {
      const idx = p * STEPS + s;
      const inTo   = toGrid.has(idx);
      const inFrom = fromGrid.has(idx);
      if (!inTo && !inFrom) continue;
      let fill;
      if (inTo && inFrom) fill = '#30363d';       // unchanged
      else if (inFrom)    fill = '#3fb95088';     // added in from_branch
      else                fill = '#f8514988';     // removed (only in to_branch)
      rects += `<rect x="${s * sw + 1}" y="${(PITCHES - 1 - p) * sh + 1}"
        width="${sw - 2}" height="${sh - 1}" fill="${fill}" rx="1"/>`;
    }
  }

  return `<svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg"
      style="width:100%;max-width:${W}px;border-radius:6px;background:#0d1117;display:block">
    ${rects}
  </svg>
  <div style="display:flex;gap:16px;margin-top:6px;font-size:11px;color:#8b949e">
    <span><span style="display:inline-block;width:10px;height:10px;background:#3fb950;
      border-radius:2px;margin-right:4px"></span>Added</span>
    <span><span style="display:inline-block;width:10px;height:10px;background:#f85149;
      border-radius:2px;margin-right:4px"></span>Removed</span>
    <span><span style="display:inline-block;width:10px;height:10px;background:#30363d;
      border-radius:2px;margin-right:4px"></span>Unchanged</span>
  </div>`;
}

// â”€â”€ Audio A/B toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _audioSide = 'from';
function toggleAudio(side, fromBranch, toBranch) {
  _audioSide = side;
  ['btn-audio-from','btn-audio-to'].forEach(id => {
    const el = document.getElementById(id);
    if (el) { el.style.background = '#21262d'; el.style.color = '#8b949e'; }
  });
  const active = document.getElementById('btn-audio-' + side);
  if (active) { active.style.background = '#1f6feb'; active.style.color = '#fff'; }
  const lbl = document.getElementById('audio-label');
  if (lbl) lbl.textContent = side === 'from' ? fromBranch : toBranch;
}

// â”€â”€ Merge strategy selector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _mergeStrategy = 'merge_commit';
function selectStrategy(strategy) {
  _mergeStrategy = strategy;
  ['merge_commit','squash','rebase'].forEach(s => {
    const el = document.getElementById('strategy-' + s);
    if (!el) return;
    el.style.background  = s === strategy ? '#1f6feb' : '#21262d';
    el.style.color       = s === strategy ? '#fff'    : '#8b949e';
    el.style.borderColor = s === strategy ? '#1f6feb' : '#30363d';
  });
}

async function mergePrWithStrategy() {
  if (!confirm(`Merge this pull request using "${_mergeStrategy}" strategy?`)) return;
  const deleteBranchEl = document.getElementById('cb-delete-branch');
  const deleteBranch = deleteBranchEl ? deleteBranchEl.checked : true;
  try {
    await apiFetch(apiBase + '/pull-requests/' + prId + '/merge', {
      method: 'POST',
      body: JSON.stringify({ mergeStrategy: _mergeStrategy, deleteBranch }),
    });
    location.reload();
  } catch (e) {
    if (e.message !== 'auth') alert('Merge failed: ' + e.message);
  }
}

function targetBadge(comment) {
  if (comment.targetType === 'general') return '';
  let label = comment.targetType;
  if (comment.targetTrack) label += ': ' + comment.targetTrack;
  if (comment.targetBeatStart != null) label += ' beats ' + comment.targetBeatStart;
  if (comment.targetBeatEnd   != null) label += 'â€“' + comment.targetBeatEnd;
  if (comment.targetNotePitch != null) label += ' pitch=' + comment.targetNotePitch;
  return `<span style="font-size:11px;background:var(--surface2,#21262d);color:var(--fg2,#8b949e);border-radius:3px;padding:1px 6px;margin-left:8px">${escHtml(label)}</span>`;
}

function renderComment(c, isReply) {
  const indent = isReply ? 'margin-left:32px;' : '';
  const repliesHtml = (c.replies || []).map(r => renderComment(r, true)).join('');
  const replyBtn = isReply ? '' :
    `<button onclick="showReplyForm('${escHtml(c.commentId)}')" style="background:none;border:none;color:var(--accent,#58a6ff);cursor:pointer;font-size:12px;padding:0">Reply</button>`;
  return `
    <div style="${indent}border-left:2px solid var(--border,#30363d);padding:8px 12px;margin-bottom:8px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
        <span style="font-weight:600">${escHtml(c.author)}</span>
        <span style="font-size:11px;color:var(--fg2,#8b949e)">${fmtDate(c.createdAt)}</span>
        ${targetBadge(c)}
      </div>
      <div style="white-space:pre-wrap;margin-bottom:4px">${escHtml(c.body)}</div>
      ${replyBtn}
      <div id="reply-form-${escHtml(c.commentId)}" style="display:none;margin-top:8px"></div>
      ${repliesHtml}
    </div>`;
}

function showReplyForm(parentId) {
  const container = document.getElementById('reply-form-' + parentId);
  if (!container) return;
  container.style.display = 'block';
  container.innerHTML = `
    <textarea id="reply-body-${parentId}" rows="3" placeholder="Write a replyâ€¦"
      style="width:100%;background:var(--surface2,#21262d);color:var(--fg,#e6edf3);border:1px solid var(--border,#30363d);border-radius:6px;padding:6px;resize:vertical;font-size:13px"></textarea>
    <div style="margin-top:4px;display:flex;gap:8px">
      <button onclick="submitComment('${parentId}')" class="btn btn-primary" style="font-size:12px;padding:4px 10px">Reply</button>
      <button onclick="document.getElementById('reply-form-${parentId}').style.display='none'" style="background:none;border:none;color:var(--fg2,#8b949e);cursor:pointer;font-size:12px">Cancel</button>
    </div>`;
}

async function submitComment(parentId) {
  const bodyEl = parentId
    ? document.getElementById('reply-body-' + parentId)
    : document.getElementById('new-comment-body');
  const targetTypeEl = document.getElementById('new-comment-target');
  const trackEl = document.getElementById('new-comment-track');
  const beatStartEl = document.getElementById('new-comment-beat-start');
  const beatEndEl = document.getElementById('new-comment-beat-end');

  if (!bodyEl || !bodyEl.value.trim()) return;

  const payload = {
    body: bodyEl.value.trim(),
    targetType: (parentId || !targetTypeEl) ? 'general' : (targetTypeEl.value || 'general'),
    targetTrack: (!parentId && trackEl && trackEl.value) ? trackEl.value : null,
    targetBeatStart: (!parentId && beatStartEl && beatStartEl.value) ? parseFloat(beatStartEl.value) : null,
    targetBeatEnd: (!parentId && beatEndEl && beatEndEl.value) ? parseFloat(beatEndEl.value) : null,
    parentCommentId: parentId || null,
  };

  try {
    await apiFetch('/repos/' + repoId + '/pull-requests/' + prId + '/comments', {
      method: 'POST',
      body: JSON.stringify(payload),
    });
    await loadComments();
    bodyEl.value = '';
  } catch(e) {
    if (e.message !== 'auth') alert('Failed to post comment: ' + e.message);
  }
}

async function loadComments() {
  const section = document.getElementById('comments-section');
  if (!section) return;
  try {
    const data = await apiFetch('/repos/' + repoId + '/pull-requests/' + prId + '/comments');
    const list = data.comments || [];
    const countEl = document.getElementById('comment-count');
    if (countEl) countEl.textContent = data.total || 0;

    const listEl = document.getElementById('comment-list');
    if (listEl) {
      listEl.innerHTML = list.length
        ? list.map(c => renderComment(c, false)).join('')
        : '<p style="color:var(--fg2,#8b949e);font-size:13px">No review comments yet.</p>';
    }
  } catch(e) {
    // Non-fatal â€” comment section degrades gracefully
  }
}

// â”€â”€ Timeline event row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function timelineRow(icon, label, ts) {
  const time = ts ? new Date(ts).toLocaleString() : '';
  return `<div style="display:flex;align-items:center;gap:10px;padding:6px 0;
      border-bottom:1px solid #21262d">
    <span style="font-size:16px">${icon}</span>
    <span style="font-size:13px;color:#e6edf3;flex:1">${escHtml(label)}</span>
    <span style="font-size:11px;color:#8b949e">${escHtml(time)}</span>
  </div>`;
}

// â”€â”€ Reactions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const REACTION_EMOJIS = ['ğŸ‘', 'ğŸ‘', 'â¤ï¸', 'ğŸµ', 'ğŸ”¥', 'âœ¨', 'ğŸ¸', 'ğŸ¥'];

/**
 * Load and render emoji reaction counts for a target into a container element.
 * Shows pill buttons for each emoji with counts; authenticated users can toggle.
 */
async function loadReactions(targetType, targetId, containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;
  try {
    const reactions = await apiFetch(
      '/repos/' + repoId + '/reactions?target_type=' + encodeURIComponent(targetType) +
      '&target_id=' + encodeURIComponent(targetId)
    );

    const countMap = {};
    const mySet = new Set();
    for (const r of reactions) {
      countMap[r.emoji] = r.count;
      if (r.reacted_by_me) mySet.add(r.emoji);
    }

    const authed = !!getToken();
    container.innerHTML = REACTION_EMOJIS.map(emoji => {
      const count = countMap[emoji] || 0;
      const active = mySet.has(emoji);
      const cls = 'reaction-btn' + (active ? ' reaction-btn--active' : '');
      const onclick = authed
        ? `toggleReaction('${targetType}','${targetId}','${emoji}','${containerId}')`
        : '';
      return `<button class="${cls}" ${onclick ? 'onclick="' + onclick + '"' : 'disabled title="Sign in to react"'}>${emoji}${count > 0 ? ' <span class="reaction-count">' + count + '</span>' : ''}</button>`;
    }).join('');
  } catch(e) {
    if (e.message !== 'auth') container.innerHTML = '';
  }
}

/**
 * Toggle an emoji reaction on a target and refresh the reaction bar.
 */
async function toggleReaction(targetType, targetId, emoji, containerId) {
  try {
    await apiFetch('/repos/' + repoId + '/reactions', {
      method: 'POST',
      body: JSON.stringify({ target_type: targetType, target_id: targetId, emoji }),
    });
    loadReactions(targetType, targetId, containerId);
  } catch(e) {
    if (e.message !== 'auth') console.error('Reaction error:', e.message);
  }
}

// â”€â”€ Lightweight Markdown renderer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/**
 * Convert a Markdown string to safe HTML without an external library.
 * Supports: headings, bold, italic, inline code, code fences, links,
 * unordered lists, ordered lists, blockquotes, and horizontal rules.
 * All literal HTML in the source is escaped first to prevent XSS.
 */
function renderMarkdown(text) {
  if (!text) return '';
  // Escape raw HTML first.
  let s = text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
  // Fenced code blocks (``` â€¦ ```).
  s = s.replace(/```([^`]*?)```/gs,
    (_, code) => `<pre style="background:#161b22;border:1px solid #30363d;border-radius:6px;padding:12px;overflow-x:auto;font-size:12px"><code>${code}</code></pre>`);
  // Headings.
  s = s.replace(/^### (.+)$/gm, '<h3 style="font-size:14px;margin:12px 0 6px;color:#e6edf3">$1</h3>');
  s = s.replace(/^## (.+)$/gm,  '<h2 style="font-size:16px;margin:14px 0 6px;color:#e6edf3">$1</h2>');
  s = s.replace(/^# (.+)$/gm,   '<h1 style="font-size:18px;margin:16px 0 8px;color:#e6edf3">$1</h1>');
  // Horizontal rules.
  s = s.replace(/^---+$/gm, '<hr style="border:none;border-top:1px solid #30363d;margin:12px 0">');
  // Blockquotes.
  s = s.replace(/^&gt; (.+)$/gm,
    '<blockquote style="border-left:3px solid #388bfd;margin:0;padding:4px 12px;color:#8b949e;font-style:italic">$1</blockquote>');
  // Unordered lists.
  s = s.replace(/^[*\-] (.+)$/gm, '<li style="margin-left:20px;margin-bottom:2px">$1</li>');
  // Ordered lists.
  s = s.replace(/^\d+\. (.+)$/gm, '<li style="margin-left:20px;margin-bottom:2px;list-style:decimal">$1</li>');
  // Bold and italic.
  s = s.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
  s = s.replace(/\*\*(.+?)\*\*/g,     '<strong>$1</strong>');
  s = s.replace(/\*(.+?)\*/g,         '<em>$1</em>');
  s = s.replace(/__(.+?)__/g,         '<strong>$1</strong>');
  s = s.replace(/_(.+?)_/g,           '<em>$1</em>');
  // Inline code.
  s = s.replace(/`([^`]+)`/g,
    '<code style="background:#21262d;border-radius:3px;padding:1px 5px;font-size:12px">$1</code>');
  // Links [text](url).
  s = s.replace(/\[([^\]]+)\]\(([^)]+)\)/g,
    '<a href="$2" style="color:#58a6ff" target="_blank" rel="noopener noreferrer">$1</a>');
  // Paragraphs: blank lines â†’ paragraph break.
  s = s.replace(/\n{2,}/g, '</p><p style="margin:8px 0">');
  s = `<p style="margin:8px 0">${s}</p>`;
  return s;
}

// â”€â”€ Mini 8-axis emotion radar (inline SVG for commit diff panels) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/**
 * Render a compact 8-axis spider chart from an EmotionDelta8D delta object.
 * Each axis shows absolute |delta| magnitude; sign is indicated by colour.
 */
function miniEmotionRadarSvg(delta) {
  const axes = ['valence','energy','tension','complexity','warmth','brightness','darkness','playfulness'];
  const cx = 80, cy = 80, r = 60;
  const n = axes.length;
  const vals = axes.map(a => delta[a] !== undefined ? Math.abs(delta[a]) : 0);
  const colors = axes.map(a => (delta[a] || 0) >= 0 ? '#3fb950' : '#f85149');

  const grid = [0.25, 0.5, 0.75, 1.0].map(frac => {
    const pts = axes.map((_, i) => {
      const angle = (i / n) * 2 * Math.PI - Math.PI / 2;
      return `${cx + frac * r * Math.cos(angle)},${cy + frac * r * Math.sin(angle)}`;
    }).join(' ');
    return `<polygon points="${pts}" fill="none" stroke="#21262d" stroke-width="1"/>`;
  }).join('');

  const axisLines = axes.map((_, i) => {
    const angle = (i / n) * 2 * Math.PI - Math.PI / 2;
    const ex = cx + r * Math.cos(angle), ey = cy + r * Math.sin(angle);
    return `<line x1="${cx}" y1="${cy}" x2="${ex}" y2="${ey}" stroke="#30363d" stroke-width="1"/>`;
  }).join('');

  const dataPts = vals.map((v, i) => {
    const angle = (i / n) * 2 * Math.PI - Math.PI / 2;
    return `${cx + v * r * Math.cos(angle)},${cy + v * r * Math.sin(angle)}`;
  }).join(' ');

  const dots = vals.map((v, i) => {
    const angle = (i / n) * 2 * Math.PI - Math.PI / 2;
    const px = cx + v * r * Math.cos(angle), py = cy + v * r * Math.sin(angle);
    return `<circle cx="${px}" cy="${py}" r="3" fill="${colors[i]}" stroke="#0d1117" stroke-width="1.5"/>`;
  }).join('');

  const labels = axes.map((a, i) => {
    const angle = (i / n) * 2 * Math.PI - Math.PI / 2;
    const lx = cx + (r + 14) * Math.cos(angle);
    const ly = cy + (r + 14) * Math.sin(angle);
    return `<text x="${lx}" y="${ly + 3}" text-anchor="middle" font-size="7" fill="#8b949e">${a.slice(0,5)}</text>`;
  }).join('');

  return `<svg viewBox="0 0 160 160" xmlns="http://www.w3.org/2000/svg"
      style="width:160px;height:160px;display:block">
    ${grid}${axisLines}
    <polygon points="${dataPts}" fill="rgba(88,166,255,0.12)" stroke="#58a6ff" stroke-width="1.5"/>
    ${dots}${labels}
  </svg>`;
}

// â”€â”€ Reviewer status panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/** Map review state â†’ display label + colour. */
const REVIEW_STATE_STYLE = {
  pending:           { label: 'Pending',            color: '#8b949e', bg: '#21262d' },
  approved:          { label: 'Approved',            color: '#3fb950', bg: '#0d2b00' },
  changes_requested: { label: 'Changes requested',   color: '#f0883e', bg: '#341a00' },
  dismissed:         { label: 'Dismissed',           color: '#484f58', bg: '#161b22' },
};

/** Render one reviewer avatar chip. */
function reviewerChip(review) {
  const style = REVIEW_STATE_STYLE[review.reviewerUsername ? review.state : 'pending'] || REVIEW_STATE_STYLE.pending;
  const initial = (review.reviewerUsername || '?').charAt(0).toUpperCase();
  return `<div title="${escHtml(review.reviewerUsername)} â€” ${style.label}"
      style="display:inline-flex;align-items:center;gap:6px;padding:4px 10px 4px 4px;
        border-radius:var(--radius-full,999px);border:1px solid ${style.color}44;
        background:${style.bg};cursor:default">
    <span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;
      border-radius:50%;background:${style.color}33;color:${style.color};font-size:12px;font-weight:700">
      ${initial}
    </span>
    <span style="font-size:12px;color:#e6edf3">${escHtml(review.reviewerUsername)}</span>
    <span style="font-size:10px;padding:1px 6px;border-radius:10px;background:${style.color}22;color:${style.color}">
      ${style.label}
    </span>
  </div>`;
}

/**
 * Fetch and render the reviewer status panel.
 * Requires a DOM element #reviewer-chips and (optionally) #review-form-section.
 */
async function loadReviewers() {
  const chipsEl = document.getElementById('reviewer-chips');
  if (!chipsEl) return;
  try {
    const data = await apiFetch('/repos/' + repoId + '/pull-requests/' + prId + '/reviews');
    const reviews = (data && data.reviews) ? data.reviews : [];
    chipsEl.innerHTML = reviews.length
      ? reviews.map(reviewerChip).join('')
      : '<span style="font-size:13px;color:#8b949e">No reviewers assigned.</span>';
  } catch (e) {
    if (e.message !== 'auth') chipsEl.innerHTML = '<span style="color:#8b949e;font-size:13px">Could not load reviewers.</span>';
  }
}

/**
 * Submit a review (approve / request_changes / comment) for the authenticated user.
 * event must be one of: 'approve' | 'request_changes' | 'comment'
 */
async function submitReview(event) {
  const bodyEl = document.getElementById('review-body');
  const body = bodyEl ? bodyEl.value.trim() : '';
  if (event === 'request_changes' && !body) {
    alert('A review body is required when requesting changes.');
    return;
  }
  try {
    await apiFetch('/repos/' + repoId + '/pull-requests/' + prId + '/reviews', {
      method: 'POST',
      body: JSON.stringify({ event, body }),
    });
    if (bodyEl) bodyEl.value = '';
    await loadReviewers();
    // Collapse the submit form.
    const details = document.getElementById('review-form-details');
    if (details) details.removeAttribute('open');
  } catch (e) {
    if (e.message !== 'auth') alert('Review submission failed: ' + e.message);
  }
}

// â”€â”€ Labels sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * Fetch labels assigned to this PR and repo labels (for edit controls).
 * Renders into #pr-labels-section.
 */
async function loadPRLabels() {
  const section = document.getElementById('pr-labels-section');
  if (!section) return;
  try {
    // Fetch the repo's full label catalogue first (always available).
    const allLabels = await apiFetch('/repos/' + repoId + '/labels').catch(() => []);

    // Try to fetch current PR labels (endpoint may not exist yet â€” degrade gracefully).
    let prLabels = [];
    try {
      const prLabelData = await apiFetch('/repos/' + repoId + '/pull-requests/' + prId + '/labels');
      prLabels = Array.isArray(prLabelData) ? prLabelData : [];
    } catch (_) { /* no GET endpoint yet â€” show empty */ }

    const prLabelIds = new Set(prLabels.map(l => l.id || l.label_id || ''));
    const authed = !!getToken();

    const labelChips = prLabels.length
      ? prLabels.map(l =>
          `<span style="display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:10px;
            font-size:11px;font-weight:600;background:${l.color ? l.color + '33' : '#21262d'};
            color:${l.color || '#8b949e'};border:1px solid ${l.color ? l.color + '55' : '#30363d'}">
            ${escHtml(l.name)}
            ${authed ? `<button onclick="removePRLabel('${escHtml(l.id || l.label_id || '')}')"
              style="background:none;border:none;color:${l.color || '#8b949e'};cursor:pointer;
                font-size:10px;padding:0;margin-left:2px" title="Remove label">Ã—</button>` : ''}
          </span>`).join(' ')
      : '<span style="font-size:12px;color:#8b949e">None yet</span>';

    let editHtml = '';
    if (authed && allLabels.length > 0) {
      const opts = allLabels
        .filter(l => !prLabelIds.has(l.id || l.label_id || ''))
        .map(l => `<option value="${escHtml(l.id || l.label_id || '')}">${escHtml(l.name)}</option>`)
        .join('');
      editHtml = opts ? `
        <div style="margin-top:8px;display:flex;gap:6px;align-items:center">
          <select id="label-add-select" style="flex:1;background:#21262d;color:#e6edf3;
            border:1px solid #30363d;border-radius:4px;padding:3px 6px;font-size:12px">
            <option value="">Add labelâ€¦</option>
            ${opts}
          </select>
          <button onclick="addPRLabel()" style="padding:3px 10px;border-radius:4px;border:1px solid #30363d;
            background:#21262d;color:#e6edf3;cursor:pointer;font-size:12px">Add</button>
        </div>` : '';
    }

    section.innerHTML = `
      <h3 style="font-size:13px;font-weight:600;color:#8b949e;margin:0 0 8px;text-transform:uppercase;
        letter-spacing:.05em">Labels</h3>
      <div style="display:flex;flex-wrap:wrap;gap:4px">${labelChips}</div>
      ${editHtml}`;
  } catch (e) {
    // Non-fatal â€” label section degrades gracefully.
  }
}

/** Assign a label to this PR (maintainer action). */
async function addPRLabel() {
  const sel = document.getElementById('label-add-select');
  if (!sel || !sel.value) return;
  try {
    await apiFetch('/repos/' + repoId + '/pull-requests/' + prId + '/labels', {
      method: 'POST',
      body: JSON.stringify({ label_ids: [sel.value] }),
    });
    await loadPRLabels();
  } catch (e) {
    if (e.message !== 'auth') alert('Could not add label: ' + e.message);
  }
}

/** Remove a label from this PR (maintainer action). */
async function removePRLabel(labelId) {
  if (!labelId) return;
  try {
    await apiFetch('/repos/' + repoId + '/pull-requests/' + prId + '/labels/' + labelId,
      { method: 'DELETE' });
    await loadPRLabels();
  } catch (e) {
    if (e.message !== 'auth') alert('Could not remove label: ' + e.message);
  }
}

// â”€â”€ Collapsible commit diff panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * Fetch the commits on the head branch that are not on the base branch,
 * then for each commit render a collapsible panel showing similarity % and
 * an 8-axis emotion-diff mini radar chart relative to the to_branch.
 */
async function loadCommitDiffPanels(fromBranch, toBranch) {
  const container = document.getElementById('commit-diff-panels');
  if (!container) return;
  container.innerHTML = '<p style="color:#8b949e;font-size:13px">Loading commit diffsâ€¦</p>';
  try {
    // Fetch head-branch commits (newest first, limit to 8 for performance).
    const commitsData = await apiFetch(
      '/repos/' + repoId + '/commits?branch=' + encodeURIComponent(fromBranch) + '&limit=8'
    ).catch(() => null);
    const commits = (commitsData && commitsData.commits) ? commitsData.commits : [];
    if (!commits.length) {
      container.innerHTML = '<p style="color:#8b949e;font-size:13px">No commits found on this branch.</p>';
      return;
    }

    // Render a placeholder panel for each commit immediately, then fill async.
    container.innerHTML = commits.map((c, idx) => `
      <details id="commit-panel-${idx}" style="margin-bottom:8px;border:1px solid #30363d;
          border-radius:6px;background:#0d1117;overflow:hidden">
        <summary style="display:flex;align-items:center;gap:10px;padding:8px 12px;cursor:pointer;
            list-style:none;user-select:none;background:#161b22">
          <span style="font-family:monospace;font-size:12px;color:#58a6ff">${escHtml((c.commitId || '').substring(0,8))}</span>
          <span style="flex:1;font-size:13px;color:#e6edf3;overflow:hidden;text-overflow:ellipsis;
              white-space:nowrap">${escHtml(c.message || '(no message)')}</span>
          <span style="font-size:11px;color:#8b949e">${fmtDate(c.createdAt || c.committedAt || null)}</span>
          <span style="font-size:11px">â–¸</span>
        </summary>
        <div id="commit-panel-body-${idx}" style="padding:12px">
          <p style="color:#8b949e;font-size:12px">Loading diffâ€¦</p>
        </div>
      </details>`).join('');

    // Fill each panel body asynchronously.
    commits.forEach(async (c, idx) => {
      const bodyEl = document.getElementById('commit-panel-body-' + idx);
      if (!bodyEl) return;
      try {
        const commitRef = c.commitId || c.sha || '';
        const [sim, emo] = await Promise.allSettled([
          apiFetch('/repos/' + repoId + '/analysis/' + encodeURIComponent(commitRef) +
                   '/similarity?compare=' + encodeURIComponent(toBranch)),
          apiFetch('/repos/' + repoId + '/analysis/' + encodeURIComponent(commitRef) +
                   '/emotion-diff?base=' + encodeURIComponent(toBranch)),
        ]);

        const simData  = sim.status  === 'fulfilled' ? sim.value  : null;
        const emoData  = emo.status  === 'fulfilled' ? emo.value  : null;

        const simPct = simData ? Math.round((simData.overallSimilarity || 0) * 100) : null;
        const simColor = simPct === null ? '#8b949e'
          : simPct >= 80 ? '#3fb950' : simPct >= 50 ? '#f0883e' : '#f85149';

        const simHtml = simPct !== null
          ? `<div style="display:inline-flex;align-items:center;gap:6px;padding:4px 10px;
              border-radius:4px;background:#0d2b00;border:1px solid ${simColor}33">
              <span style="font-size:20px;font-weight:700;color:${simColor}">${simPct}%</span>
              <span style="font-size:11px;color:#8b949e">similarity<br>to ${escHtml(toBranch)}</span>
            </div>`
          : '<span style="font-size:12px;color:#8b949e">Similarity unavailable</span>';

        const deltaObj = (emoData && emoData.delta) ? emoData.delta : null;
        const emoHtml  = deltaObj
          ? `<div>
              <div style="font-size:11px;color:#8b949e;margin-bottom:4px">Emotion delta vs ${escHtml(toBranch)}</div>
              ${miniEmotionRadarSvg(deltaObj)}
              ${emoData.interpretation
                ? `<p style="font-size:11px;color:#8b949e;margin:4px 0 0">${escHtml(emoData.interpretation)}</p>` : ''}
            </div>`
          : '<span style="font-size:12px;color:#8b949e">Emotion diff unavailable</span>';

        bodyEl.innerHTML = `
          <div style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap">
            ${simHtml}
            ${emoHtml}
          </div>`;
      } catch (e) {
        bodyEl.innerHTML = '<p style="color:#8b949e;font-size:12px">Diff unavailable for this commit.</p>';
      }
    });
  } catch (e) {
    container.innerHTML = '<p style="color:#8b949e;font-size:13px">Could not load commit diffs.</p>';
  }
}

// â”€â”€ General discussion helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * Soft-delete a general discussion comment by ID and reload the thread.
 */
async function deleteComment(commentId) {
  if (!confirm('Delete this comment?')) return;
  try {
    await apiFetch('/repos/' + repoId + '/comments/' + commentId, { method: 'DELETE' });
    await refreshComments();
  } catch(e) {
    if (e.message !== 'auth') alert('Delete failed: ' + e.message);
  }
}

/**
 * Fetch general discussion comments and re-render via loadComments alias.
 * Satisfies the refreshComments API used by the discussion section.
 */
async function refreshComments() {
  await loadComments();
}

// â”€â”€ Main loader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function load() {
  initRepoNav(repoId);
  document.getElementById('content').innerHTML =
    '<p class="loading">Loading PR&#8230;</p>';

  try {
    // Fetch PR metadata and musical diff in parallel.
    const [pr, diff] = await Promise.all([
      apiFetch(apiBase + '/pull-requests/' + prId),
      apiFetch(apiBase + '/pull-requests/' + prId + '/diff').catch(() => null),
    ]);

    const dims          = (diff && diff.dimensions) ? diff.dimensions : [];
    const overallScore  = (diff && diff.overallScore) ? diff.overallScore : 0;
    const pct           = Math.round(overallScore * 100);
    const ancestor      = (diff && diff.commonAncestor) ? diff.commonAncestor.substring(0, 8) : null;
    const affected      = (diff && diff.affectedSections) ? diff.affectedSections : [];
    const fromBranch    = pr.fromBranch || '';
    const toBranch      = pr.toBranch   || '';

    // â”€â”€ Merge controls (only for open PRs) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // pr.mergeable may be absent in older API responses â€” treat undefined as true.
    const isMergeable = pr.mergeable !== false;
    const mergeSection = pr.state === 'open' ? `
      <div class="card" style="margin-top:24px">
        <h2 style="margin:0 0 12px;font-size:16px;color:#e6edf3">Merge Pull Request</h2>
        ${!isMergeable ? `<div style="padding:8px 12px;border-radius:6px;background:#341a00;border:1px solid #f0883e44;
            font-size:13px;color:#f0883e;margin-bottom:12px">
          âš ï¸ This pull request has conflicts and cannot be merged automatically.
        </div>` : ''}
        <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
          <button id="strategy-merge_commit" onclick="selectStrategy('merge_commit')"
            ${!isMergeable ? 'disabled' : ''}
            style="padding:6px 14px;border-radius:6px;border:1px solid #1f6feb;cursor:${isMergeable ? 'pointer' : 'not-allowed'};
              font-size:13px;background:#1f6feb;color:#fff;opacity:${isMergeable ? '1' : '0.5'}">
            Merge commit
          </button>
          <button id="strategy-squash" onclick="selectStrategy('squash')"
            ${!isMergeable ? 'disabled' : ''}
            style="padding:6px 14px;border-radius:6px;border:1px solid #30363d;cursor:${isMergeable ? 'pointer' : 'not-allowed'};
              font-size:13px;background:#21262d;color:#8b949e;opacity:${isMergeable ? '1' : '0.5'}">
            Squash &amp; merge
          </button>
          <button id="strategy-rebase" onclick="selectStrategy('rebase')"
            ${!isMergeable ? 'disabled' : ''}
            style="padding:6px 14px;border-radius:6px;border:1px solid #30363d;cursor:${isMergeable ? 'pointer' : 'not-allowed'};
              font-size:13px;background:#21262d;color:#8b949e;opacity:${isMergeable ? '1' : '0.5'}">
            Rebase &amp; merge
          </button>
        </div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
          <input type="checkbox" id="cb-delete-branch" checked
            style="width:14px;height:14px;accent-color:#1f6feb;cursor:pointer">
          <label for="cb-delete-branch" style="font-size:13px;color:#e6edf3;cursor:pointer">
            Delete branch after merge
          </label>
        </div>
        <button class="btn btn-primary" onclick="mergePrWithStrategy()"
          ${!isMergeable ? 'disabled' : ''}
          style="font-size:14px;padding:10px 24px;opacity:${isMergeable ? '1' : '0.5'};
            cursor:${isMergeable ? 'pointer' : 'not-allowed'}">
          &#10003; Merge pull request
        </button>
      </div>` : '';

    // â”€â”€ Affected sections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const affectedHtml = affected.length > 0
      ? `<div style="margin-top:10px;font-size:13px;color:#8b949e">
          Affected sections: ${affected.map(s => `<span style="margin-right:6px;padding:2px 8px;
            background:#21262d;border-radius:10px;font-size:11px;color:#e6edf3">${escHtml(s)}</span>`).join('')}
         </div>` : '';

    // â”€â”€ PR timeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const timelineHtml = `
      <div class="card" style="margin-bottom:24px">
        <h2 style="margin:0 0 12px;font-size:16px;color:#e6edf3">PR Timeline</h2>
        ${timelineRow('ğŸŸ¢', `Opened by ${pr.author || 'unknown'}`, pr.createdAt)}
        ${pr.state === 'merged' && pr.mergeCommitId
          ? timelineRow('ğŸŸ£', `Merged â€” commit <a href="${base}/commits/${pr.mergeCommitId}"
              style="font-family:monospace;color:#58a6ff">${pr.mergeCommitId.substring(0,8)}</a>`, null)
          : ''}
        ${pr.state === 'closed' && !pr.mergeCommitId
          ? timelineRow('ğŸ”´', 'Closed without merging', null)
          : ''}
        ${pr.state === 'open' ? timelineRow('â³', 'Awaiting review', null) : ''}
      </div>`;

    document.getElementById('content').innerHTML = `
      <!-- â”€â”€ Back nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div style="margin-bottom:12px">
        <a href="${base}/pulls">&larr; Back to pull requests</a>
      </div>

      <!-- â”€â”€ PR header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="card" style="margin-bottom:24px">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap">
          <h1 style="margin:0;font-size:20px;color:#e6edf3">${escHtml(pr.title)}</h1>
          <span class="badge badge-${pr.state}">${pr.state}</span>
        </div>
        <div class="meta-row">
          ${pr.author ? `
          <div class="meta-item">
            <span class="meta-label">Author</span>
            <span class="meta-value" style="display:flex;align-items:center;gap:6px">
              <span style="display:inline-flex;align-items:center;justify-content:center;width:20px;
                height:20px;border-radius:50%;background:var(--accent,#58a6ff);color:#0d1117;
                font-size:11px;font-weight:700;flex-shrink:0">
                ${escHtml(pr.author.charAt(0).toUpperCase())}</span>
              <a href="${base.replace(/\/[^/]+\/[^/]+$/, '')}/users/${encodeURIComponent(escHtml(pr.author))}">
                ${escHtml(pr.author)}</a>
            </span>
          </div>` : ''}
          <div class="meta-item">
            <span class="meta-label">From</span>
            <span class="meta-value" style="font-family:monospace">${escHtml(fromBranch)}</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Into</span>
            <span class="meta-value" style="font-family:monospace">${escHtml(toBranch)}</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Created</span>
            <span class="meta-value">${fmtDate(pr.createdAt)}</span>
          </div>
          ${pr.mergeCommitId ? `
          <div class="meta-item">
            <span class="meta-label">Merge commit</span>
            <span class="meta-value" style="font-family:monospace">
              <a href="${base}/commits/${pr.mergeCommitId}">${pr.mergeCommitId.substring(0,8)}</a>
            </span>
          </div>` : ''}
        </div>
        ${pr.body ? `<div style="margin-top:12px;font-size:14px;color:#e6edf3;line-height:1.6;
            border-top:1px solid #21262d;padding-top:12px">${renderMarkdown(pr.body)}</div>` : ''}
        ${mergeSection}
      </div>

      <!-- â”€â”€ Sidebar: Labels + Milestone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div style="display:grid;grid-template-columns:1fr 240px;gap:16px;margin-bottom:24px;
          align-items:start" class="pr-sidebar-grid">
        <!-- Main meta (reactions) -->
        <div class="card" style="padding:var(--space-3) var(--space-4)">
          <div id="pr-reactions" class="reaction-bar"><p class="text-muted text-sm">Loading reactionsâ€¦</p></div>
        </div>
        <!-- Sidebar column -->
        <div style="display:flex;flex-direction:column;gap:12px">
          <!-- Labels -->
          <div class="card" style="padding:12px">
            <div id="pr-labels-section">
              <h3 style="font-size:13px;font-weight:600;color:#8b949e;margin:0 0 8px;text-transform:uppercase;
                letter-spacing:.05em">Labels</h3>
              <p style="font-size:12px;color:#8b949e;margin:0">Loadingâ€¦</p>
            </div>
          </div>
          <!-- Milestone -->
          ${(pr.milestoneId || pr.milestone_id || pr.milestoneTitle || pr.milestone_title) ? `
          <div class="card" style="padding:12px">
            <h3 style="font-size:13px;font-weight:600;color:#8b949e;margin:0 0 8px;text-transform:uppercase;
              letter-spacing:.05em">Milestone</h3>
            <div style="display:flex;align-items:center;gap:6px">
              <span style="font-size:14px">ğŸ</span>
              <span style="font-size:13px;color:#e6edf3">
                ${escHtml(pr.milestoneTitle || pr.milestone_title || pr.milestoneId || pr.milestone_id || '')}
              </span>
            </div>
          </div>` : ''}
        </div>
      </div>

      <!-- â”€â”€ Musical diff radar + badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      ${dims.length > 0 ? `
      <div style="display:grid;grid-template-columns:1fr auto;gap:24px;align-items:start;
          margin-bottom:24px;flex-wrap:wrap">
        <div>
          <h2 style="margin:0 0 12px;font-size:16px;color:#e6edf3">Musical Diff</h2>
          <div style="text-align:center;margin-bottom:16px">
            <div style="font-size:40px;font-weight:700;color:#e6edf3">${pct}%</div>
            <div style="font-size:12px;color:#8b949e">overall musical change</div>
            ${ancestor ? `<div style="font-size:11px;color:#8b949e;margin-top:4px">
              Merge base: <span class="text-mono">${escHtml(ancestor)}</span>
            </div>` : ''}
          </div>
          ${dims.map(diffBadge).join('')}
          ${affectedHtml}
        </div>
        <div style="flex-shrink:0">
          <div style="width:280px">${radarSvg(dims)}</div>
        </div>
      </div>` : ''}

      <!-- â”€â”€ Reviewer status panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="card" style="margin-bottom:24px">
        <h2 style="margin:0 0 12px;font-size:16px;color:#e6edf3">Reviewers</h2>
        <div id="reviewer-chips" style="display:flex;flex-wrap:wrap;gap:8px;min-height:28px">
          <p style="color:#8b949e;font-size:13px;margin:0">Loading reviewersâ€¦</p>
        </div>
        ${pr.state === 'open' && getToken() ? `
        <details id="review-form-details" style="margin-top:16px;border-top:1px solid #21262d;padding-top:12px">
          <summary style="cursor:pointer;font-weight:600;color:#58a6ff;font-size:14px;
              list-style:none;user-select:none">
            â–¸ Submit your review
          </summary>
          <div style="margin-top:12px">
            <textarea id="review-body" rows="3"
              placeholder="Leave a review comment (required when requesting changes)â€¦"
              style="width:100%;background:#21262d;color:#e6edf3;border:1px solid #30363d;
                border-radius:6px;padding:8px;resize:vertical;font-size:13px;box-sizing:border-box"></textarea>
            <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
              <button onclick="submitReview('approve')" class="btn btn-primary"
                style="font-size:13px;padding:6px 14px">âœ“ Approve</button>
              <button onclick="submitReview('request_changes')"
                style="padding:6px 14px;border-radius:6px;border:1px solid #f0883e;cursor:pointer;
                  font-size:13px;background:#341a00;color:#f0883e">
                âš  Request changes
              </button>
              <button onclick="submitReview('comment')"
                style="padding:6px 14px;border-radius:6px;border:1px solid #30363d;cursor:pointer;
                  font-size:13px;background:#21262d;color:#8b949e">
                ğŸ’¬ Comment only
              </button>
            </div>
          </div>
        </details>` : ''}
      </div>

      <!-- â”€â”€ Piano roll diff â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="card" style="margin-bottom:24px">
        <h2 style="margin:0 0 12px;font-size:16px;color:#e6edf3">Piano Roll Comparison</h2>
        <div style="font-size:12px;color:#8b949e;margin-bottom:12px">
          Before/after note representation from branch name seeds â€” green = added in
          <code>${escHtml(fromBranch)}</code>, red = removed.
        </div>
        ${pianoRollSvg(fromBranch, toBranch)}
      </div>

      <!-- â”€â”€ Collapsible musical diff panels (per commit) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="card" style="margin-bottom:24px">
        <h2 style="margin:0 0 12px;font-size:16px;color:#e6edf3">Commit Musical Diffs</h2>
        <p style="font-size:12px;color:#8b949e;margin:0 0 12px">
          Similarity to <code style="font-size:11px">${escHtml(toBranch)}</code> and
          emotional character shift for each commit on <code style="font-size:11px">${escHtml(fromBranch)}</code>.
        </p>
        <div id="commit-diff-panels"></div>
      </div>

      <!-- â”€â”€ Audio A/B comparison â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="card" style="margin-bottom:24px">
        <h2 style="margin:0 0 12px;font-size:16px;color:#e6edf3">Audio A/B Comparison</h2>
        <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
          <button id="btn-audio-from" onclick="toggleAudio('from', ${JSON.stringify(fromBranch)}, ${JSON.stringify(toBranch)})"
            style="padding:6px 14px;border-radius:6px;border:none;cursor:pointer;font-size:13px;
              background:#1f6feb;color:#fff">
            &#9654; Base: ${escHtml(toBranch)}
          </button>
          <button id="btn-audio-to" onclick="toggleAudio('to', ${JSON.stringify(fromBranch)}, ${JSON.stringify(toBranch)})"
            style="padding:6px 14px;border-radius:6px;border:none;cursor:pointer;font-size:13px;
              background:#21262d;color:#8b949e">
            &#9654; Head: ${escHtml(fromBranch)}
          </button>
        </div>
        <div style="font-size:12px;color:#8b949e">
          Listening to: <span id="audio-label" style="color:#e6edf3">${escHtml(toBranch)}</span>
        </div>
        <div style="margin-top:8px;font-size:12px;color:#484f58">
          Audio render requires snapshot objects. Toggle queues the correct branch in the player.
        </div>
      </div>

      <!-- â”€â”€ PR Timeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      ${timelineHtml}

      <!-- Review comments section -->
      <div id="comment-section" class="card" style="margin-top:16px">
        <h2 style="margin:0 0 12px">Review comments (<span id="comment-count">0</span>)</h2>
        <div id="comment-list"></div>

        <!-- New top-level comment form -->
        <details style="margin-top:16px">
          <summary style="cursor:pointer;font-weight:600;color:var(--accent,#58a6ff)">Leave a review comment</summary>
          <div style="margin-top:12px">
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:8px">
              <div>
                <label style="font-size:12px;color:var(--fg2,#8b949e)">Target</label>
                <select id="new-comment-target" style="width:100%;background:var(--surface2,#21262d);color:var(--fg,#e6edf3);border:1px solid var(--border,#30363d);border-radius:4px;padding:4px">
                  <option value="general">General</option>
                  <option value="track">Track</option>
                  <option value="region">Region</option>
                  <option value="note">Note</option>
                </select>
              </div>
              <div>
                <label style="font-size:12px;color:var(--fg2,#8b949e)">Track name</label>
                <input id="new-comment-track" type="text" placeholder="e.g. bass"
                  style="width:100%;background:var(--surface2,#21262d);color:var(--fg,#e6edf3);border:1px solid var(--border,#30363d);border-radius:4px;padding:4px">
              </div>
              <div style="display:flex;gap:6px">
                <div style="flex:1">
                  <label style="font-size:12px;color:var(--fg2,#8b949e)">Beat start</label>
                  <input id="new-comment-beat-start" type="number" min="0" step="0.5" placeholder="16"
                    style="width:100%;background:var(--surface2,#21262d);color:var(--fg,#e6edf3);border:1px solid var(--border,#30363d);border-radius:4px;padding:4px">
                </div>
                <div style="flex:1">
                  <label style="font-size:12px;color:var(--fg2,#8b949e)">Beat end</label>
                  <input id="new-comment-beat-end" type="number" min="0" step="0.5" placeholder="24"
                    style="width:100%;background:var(--surface2,#21262d);color:var(--fg,#e6edf3);border:1px solid var(--border,#30363d);border-radius:4px;padding:4px">
                </div>
              </div>
            </div>
            <textarea id="new-comment-body" rows="4" placeholder="Write a review comment (Markdown supported)â€¦"
              style="width:100%;background:var(--surface2,#21262d);color:var(--fg,#e6edf3);border:1px solid var(--border,#30363d);border-radius:6px;padding:8px;resize:vertical;font-size:13px"></textarea>
            <div style="margin-top:8px">
              <button onclick="submitComment(null)" class="btn btn-primary">Comment</button>
            </div>
          </div>
        </details>
      </div>`;

    loadReactions('pull_request', prId, 'pr-reactions');
    loadReviewers();
    loadPRLabels();
    loadCommitDiffPanels(fromBranch, toBranch);
    await loadComments();
  } catch(e) {
    if (e.message !== 'auth')
      document.getElementById('content').innerHTML =
        '<p class="error">&#10005; ' + escHtml(e.message) + '</p>';
  }
}

load();
{% endraw %}
{% endblock %}

{% block extra_css %}
<style>
/* â”€â”€ Reaction bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.reaction-bar {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-1);
  min-height: 32px;
}

.reaction-btn {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 10px;
  border-radius: var(--radius-full);
  border: 1px solid var(--border-subtle);
  background: var(--bg-overlay);
  color: var(--text-secondary);
  font-size: var(--font-size-sm);
  cursor: pointer;
  transition: border-color 0.15s, background 0.15s;
}

.reaction-btn:hover:not(:disabled) {
  border-color: var(--accent, #58a6ff);
  background: var(--bg-inset);
}

.reaction-btn--active {
  border-color: var(--accent, #58a6ff);
  background: #1d3557;
  color: var(--accent, #58a6ff);
}

.reaction-btn:disabled {
  cursor: default;
  opacity: 0.6;
}

.reaction-count {
  font-size: 11px;
  font-weight: 600;
}

/* â”€â”€ PR sidebar grid (labels + milestone) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pr-sidebar-grid {
  grid-template-columns: 1fr 240px;
}
@media (max-width: 720px) {
  .pr-sidebar-grid {
    grid-template-columns: 1fr;
  }
}

/* â”€â”€ Reviewer chip states â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.reviewer-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px 4px 4px;
  border-radius: var(--radius-full, 999px);
  border: 1px solid var(--border-subtle);
  background: var(--bg-overlay);
  font-size: 12px;
  cursor: default;
}

/* â”€â”€ Commit diff panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#commit-diff-panels details > summary::-webkit-details-marker { display: none; }
#commit-diff-panels details[open] > summary > span:last-child { transform: rotate(90deg); display: inline-block; }

/* â”€â”€ Comment threads â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.comment-list {
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
}

.comment-thread {
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-base);
  background: var(--bg-overlay);
  overflow: hidden;
}

.comment-reply {
  border: none;
  border-top: 1px solid var(--border-subtle);
  border-radius: 0;
  background: var(--bg-inset);
  margin-left: var(--space-4);
}

.comment-header {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  padding: var(--space-2) var(--space-3);
  border-bottom: 1px solid var(--border-subtle);
  background: var(--bg-inset);
}

.comment-body {
  padding: var(--space-3);
  font-size: var(--font-size-sm);
  color: var(--text-primary);
  white-space: pre-wrap;
  word-break: break-word;
}

.comment-actions {
  padding: var(--space-1) var(--space-3) var(--space-2);
  display: flex;
  gap: var(--space-1);
}

.reply-form {
  padding: var(--space-2) var(--space-3) var(--space-3);
  border-top: 1px solid var(--border-subtle);
  background: var(--bg-inset);
}

.reply-textarea {
  width: 100%;
  resize: vertical;
  font-family: var(--font-sans);
}

.replies-container {
  border-top: 1px solid var(--border-subtle);
}

.new-comment-form {
  padding-top: var(--space-3);
  border-top: 1px solid var(--border-subtle);
}
</style>
{% endblock %}
