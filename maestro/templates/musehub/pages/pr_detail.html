{% extends "musehub/base.html" %}

{% block title %}PR {{ pr_id[:8] }}{% endblock %}
{% block breadcrumb %}
  <a href="/musehub/ui/{{ owner }}/{{ repo_slug }}">{{ owner }}/{{ repo_slug }}</a> /
  <a href="/musehub/ui/{{ owner }}/{{ repo_slug }}/pulls">pulls</a> / {{ pr_id[:8] }}
{% endblock %}
{% block repo_nav %}{% include "musehub/partials/repo_nav.html" %}{% endblock %}

{% block page_data %}
const repoId = {{ repo_id | tojson }};
const prId   = {{ pr_id | tojson }};
const base   = {{ base_url | tojson }};
{% endblock %}

{% block page_script %}
{% raw %}
async function mergePr() {
  if (!confirm('Merge this pull request?')) return;
  try {
    await apiFetch('/repos/' + repoId + '/pull-requests/' + prId + '/merge', {
      method: 'POST',
      body: JSON.stringify({ mergeStrategy: 'merge_commit' }),
    });
    location.reload();
  } catch(e) {
    if (e.message !== 'auth')
      alert('Merge failed: ' + e.message);
  }
}

// â”€â”€ Reactions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const REACTION_EMOJIS = ['ðŸ‘', 'ðŸ‘Ž', 'â¤ï¸', 'ðŸŽµ', 'ðŸ”¥', 'âœ¨', 'ðŸŽ¸', 'ðŸ¥'];

/**
 * Load and render emoji reaction counts for a target into a container element.
 * Shows pill buttons for each emoji with counts; authenticated users can toggle.
 */
async function loadReactions(targetType, targetId, containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;
  try {
    const reactions = await apiFetch(
      '/repos/' + repoId + '/reactions?target_type=' + encodeURIComponent(targetType) +
      '&target_id=' + encodeURIComponent(targetId)
    );

    const countMap = {};
    const mySet = new Set();
    for (const r of reactions) {
      countMap[r.emoji] = r.count;
      if (r.reacted_by_me) mySet.add(r.emoji);
    }

    const authed = !!getToken();
    container.innerHTML = REACTION_EMOJIS.map(emoji => {
      const count = countMap[emoji] || 0;
      const active = mySet.has(emoji);
      const cls = 'reaction-btn' + (active ? ' reaction-btn--active' : '');
      const onclick = authed
        ? `toggleReaction('${targetType}','${targetId}','${emoji}','${containerId}')`
        : '';
      return `<button class="${cls}" ${onclick ? 'onclick="' + onclick + '"' : 'disabled title="Sign in to react"'}>${emoji}${count > 0 ? ' <span class="reaction-count">' + count + '</span>' : ''}</button>`;
    }).join('');
  } catch(e) {
    if (e.message !== 'auth') container.innerHTML = '';
  }
}

/**
 * Toggle an emoji reaction on a target and refresh the reaction bar.
 */
async function toggleReaction(targetType, targetId, emoji, containerId) {
  try {
    await apiFetch('/repos/' + repoId + '/reactions', {
      method: 'POST',
      body: JSON.stringify({ target_type: targetType, target_id: targetId, emoji }),
    });
    loadReactions(targetType, targetId, containerId);
  } catch(e) {
    if (e.message !== 'auth') console.error('Reaction error:', e.message);
  }
}

// â”€â”€ Comments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * Render a flat list of comments into a container, preserving thread depth
 * by grouping replies under their parent.
 */
function renderComments(comments, containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;

  if (!comments.length) {
    container.innerHTML = '<p class="text-muted text-sm" style="padding:var(--space-3) 0">No comments yet. Be the first to comment.</p>';
    return;
  }

  const me = getToken() ? _parseTokenSub(getToken()) : null;

  // Separate top-level and replies
  const topLevel = comments.filter(c => !c.parent_id);
  const byParent = {};
  for (const c of comments) {
    if (c.parent_id) {
      if (!byParent[c.parent_id]) byParent[c.parent_id] = [];
      byParent[c.parent_id].push(c);
    }
  }

  function commentHtml(c, isReply) {
    const avatar = `<span style="display:inline-flex;align-items:center;justify-content:center;width:${isReply ? 20 : 24}px;height:${isReply ? 20 : 24}px;border-radius:50%;background:var(--accent,#58a6ff);color:#0d1117;font-size:${isReply ? 10 : 12}px;font-weight:700;flex-shrink:0">${escHtml(c.author.charAt(0).toUpperCase())}</span>`;
    const canDelete = me && me === c.author;
    const replyBtn = !isReply
      ? `<button class="btn btn-ghost btn-xs" onclick="showReplyForm('${c.comment_id}')">â†© Reply</button>`
      : '';
    const deleteBtn = canDelete
      ? `<button class="btn btn-ghost btn-xs" style="color:var(--color-danger)" onclick="deleteComment('${c.comment_id}')">âœ• Delete</button>`
      : '';
    const replies = byParent[c.comment_id] || [];
    const repliesHtml = replies.map(r => commentHtml(r, true)).join('');

    return `<div class="comment-thread${isReply ? ' comment-reply' : ''}" data-comment-id="${c.comment_id}">
      <div class="comment-header">
        ${avatar}
        <a href="${base.replace(/\/[^/]+\/[^/]+$/, '')}/users/${encodeURIComponent(escHtml(c.author))}" class="text-sm" style="font-weight:600">${escHtml(c.author)}</a>
        <span class="text-muted text-sm" style="margin-left:auto">${fmtRelative(c.created_at)}</span>
      </div>
      <div class="comment-body">${escHtml(c.body)}</div>
      <div class="comment-actions">
        ${replyBtn}
        ${deleteBtn}
      </div>
      ${!isReply ? `<div class="reply-form" id="reply-form-${c.comment_id}" style="display:none">
        <textarea class="form-input reply-textarea" id="reply-body-${c.comment_id}" rows="2" placeholder="Write a replyâ€¦"></textarea>
        <div style="display:flex;gap:var(--space-2);margin-top:var(--space-1)">
          <button class="btn btn-primary btn-sm" onclick="submitComment('${c.comment_id}')">Reply</button>
          <button class="btn btn-ghost btn-sm" onclick="hideReplyForm('${c.comment_id}')">Cancel</button>
        </div>
      </div>` : ''}
      ${repliesHtml ? `<div class="replies-container">${repliesHtml}</div>` : ''}
    </div>`;
  }

  container.innerHTML = topLevel.map(c => commentHtml(c, false)).join('');
}

/**
 * Parse the `sub` claim from a JWT without verifying the signature.
 * Used only for UI display decisions (delete button visibility).
 */
function _parseTokenSub(token) {
  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    return payload.sub || null;
  } catch(_) { return null; }
}

function showReplyForm(parentId) {
  const form = document.getElementById('reply-form-' + parentId);
  if (form) { form.style.display = ''; form.querySelector('textarea').focus(); }
}

function hideReplyForm(parentId) {
  const form = document.getElementById('reply-form-' + parentId);
  if (form) form.style.display = 'none';
}

/**
 * Submit a new comment or reply, then refresh the comment list.
 * @param {string|null} parentId - If set, this is a reply to that comment.
 */
async function submitComment(parentId) {
  let body, inputId;
  if (parentId) {
    inputId = 'reply-body-' + parentId;
  } else {
    inputId = 'new-comment-body';
  }
  const el = document.getElementById(inputId);
  if (!el) return;
  body = el.value.trim();
  if (!body) return;

  const submitBtn = parentId
    ? document.querySelector(`[onclick="submitComment('${parentId}')"]`)
    : document.getElementById('comment-submit-btn');
  if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Postingâ€¦'; }

  try {
    await apiFetch('/repos/' + repoId + '/comments', {
      method: 'POST',
      body: JSON.stringify({
        target_type: 'pull_request',
        target_id: prId,
        body,
        parent_id: parentId || null,
      }),
    });
    el.value = '';
    if (parentId) hideReplyForm(parentId);
    await refreshComments();
  } catch(e) {
    if (e.message !== 'auth') alert('Failed to post comment: ' + e.message);
  } finally {
    if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = parentId ? 'Reply' : 'Comment'; }
  }
}

/**
 * Soft-delete a comment by ID and refresh the list.
 */
async function deleteComment(commentId) {
  if (!confirm('Delete this comment?')) return;
  try {
    await apiFetch('/repos/' + repoId + '/comments/' + commentId, { method: 'DELETE' });
    await refreshComments();
  } catch(e) {
    if (e.message !== 'auth') alert('Delete failed: ' + e.message);
  }
}

/**
 * Fetch fresh comments from the API and re-render the comment list.
 */
async function refreshComments() {
  try {
    const comments = await apiFetch(
      '/repos/' + repoId + '/comments?target_type=pull_request&target_id=' + encodeURIComponent(prId)
    );
    renderComments(comments, 'comment-list');
  } catch(e) {
    if (e.message !== 'auth') {
      const el = document.getElementById('comment-list');
      if (el) el.innerHTML = '<p class="error text-sm">Failed to load comments.</p>';
    }
  }
}

// â”€â”€ Main page load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function load() {
  initRepoNav(repoId);
  try {
    const pr = await apiFetch('/repos/' + repoId + '/pull-requests/' + prId);

    const mergeSection = pr.state === 'open' ? `
      <div style="margin-top:16px">
        <button class="btn btn-primary" onclick="mergePr()">&#10003; Merge pull request</button>
      </div>` : '';

    document.getElementById('content').innerHTML = `
      <div style="margin-bottom:12px">
        <a href="${base}/pulls">&larr; Back to pull requests</a>
      </div>
      <div class="card">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
          <h1 style="margin:0">${escHtml(pr.title)}</h1>
          <span class="badge badge-${pr.state}">${pr.state}</span>
        </div>
        <div class="meta-row">
          ${pr.author ? `
          <div class="meta-item">
            <span class="meta-label">Author</span>
            <span class="meta-value" style="display:flex;align-items:center;gap:6px">
              <span style="display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;background:var(--accent,#58a6ff);color:#0d1117;font-size:11px;font-weight:700;flex-shrink:0">${escHtml(pr.author.charAt(0).toUpperCase())}</span>
              <a href="${base.replace(/\/[^/]+\/[^/]+$/, '')}/users/${encodeURIComponent(escHtml(pr.author))}">${escHtml(pr.author)}</a>
            </span>
          </div>` : ''}
          <div class="meta-item">
            <span class="meta-label">From</span>
            <span class="meta-value" style="font-family:monospace">${escHtml(pr.fromBranch)}</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Into</span>
            <span class="meta-value" style="font-family:monospace">${escHtml(pr.toBranch)}</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Created</span>
            <span class="meta-value">${fmtDate(pr.createdAt)}</span>
          </div>
          ${pr.mergeCommitId ? `
          <div class="meta-item">
            <span class="meta-label">Merge commit</span>
            <span class="meta-value" style="font-family:monospace">
              <a href="${base}/commits/${pr.mergeCommitId}">${pr.mergeCommitId.substring(0,8)}</a>
            </span>
          </div>` : ''}
        </div>
        ${pr.body ? '<pre>' + escHtml(pr.body) + '</pre>' : ''}
        ${mergeSection}
      </div>

      <!-- Reactions -->
      <div class="card" style="padding:var(--space-3)">
        <div id="pr-reactions" class="reaction-bar"></div>
      </div>

      <!-- Comment threads -->
      <div class="card" id="comment-section">
        <h2 style="margin:0 0 var(--space-3) 0">&#128172; Discussion</h2>
        <div id="comment-list" class="comment-list"></div>

        ${getToken() ? `
        <div class="new-comment-form" style="margin-top:var(--space-4)">
          <h3 style="margin:0 0 var(--space-2) 0;font-size:var(--font-size-sm);font-weight:600;color:var(--text-secondary)">Leave a comment</h3>
          <textarea id="new-comment-body" class="form-input" rows="3"
                    placeholder="Write a commentâ€¦"
                    style="resize:vertical;width:100%;font-family:var(--font-sans)"></textarea>
          <div style="margin-top:var(--space-2)">
            <button class="btn btn-primary btn-sm" id="comment-submit-btn" onclick="submitComment(null)">Comment</button>
          </div>
        </div>` : `
        <p class="text-sm text-muted" style="margin-top:var(--space-4)">
          <a href="#" onclick="showTokenForm('Sign in to comment')">Sign in</a> to leave a comment.
        </p>`}
      </div>`;

    // Load reactions and comments in parallel (non-fatal)
    loadReactions('pull_request', prId, 'pr-reactions');
    refreshComments();

  } catch(e) {
    if (e.message !== 'auth')
      document.getElementById('content').innerHTML = '<p class="error">&#10005; ' + escHtml(e.message) + '</p>';
  }
}

load();
{% endraw %}
{% endblock %}

{% block extra_css %}
<style>
/* â”€â”€ Reaction bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.reaction-bar {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-1);
  min-height: 32px;
}

.reaction-btn {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 10px;
  border-radius: var(--radius-full);
  border: 1px solid var(--border-subtle);
  background: var(--bg-overlay);
  color: var(--text-secondary);
  font-size: var(--font-size-sm);
  cursor: pointer;
  transition: border-color 0.15s, background 0.15s;
}

.reaction-btn:hover:not(:disabled) {
  border-color: var(--accent, #58a6ff);
  background: var(--bg-inset);
}

.reaction-btn--active {
  border-color: var(--accent, #58a6ff);
  background: #1d3557;
  color: var(--accent, #58a6ff);
}

.reaction-btn:disabled {
  cursor: default;
  opacity: 0.6;
}

.reaction-count {
  font-size: 11px;
  font-weight: 600;
}

/* â”€â”€ Comment threads â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.comment-list {
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
}

.comment-thread {
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-base);
  background: var(--bg-overlay);
  overflow: hidden;
}

.comment-reply {
  border: none;
  border-top: 1px solid var(--border-subtle);
  border-radius: 0;
  background: var(--bg-inset);
  margin-left: var(--space-4);
}

.comment-header {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  padding: var(--space-2) var(--space-3);
  border-bottom: 1px solid var(--border-subtle);
  background: var(--bg-inset);
}

.comment-body {
  padding: var(--space-3);
  font-size: var(--font-size-sm);
  color: var(--text-primary);
  white-space: pre-wrap;
  word-break: break-word;
}

.comment-actions {
  padding: var(--space-1) var(--space-3) var(--space-2);
  display: flex;
  gap: var(--space-1);
}

.reply-form {
  padding: var(--space-2) var(--space-3) var(--space-3);
  border-top: 1px solid var(--border-subtle);
  background: var(--bg-inset);
}

.reply-textarea {
  width: 100%;
  resize: vertical;
  font-family: var(--font-sans);
}

.replies-container {
  border-top: 1px solid var(--border-subtle);
}

.new-comment-form {
  padding-top: var(--space-3);
  border-top: 1px solid var(--border-subtle);
}
</style>
{% endblock %}
