{% extends "musehub/base.html" %}

{% block title %}@{{ username }}{% endblock %}
{% block breadcrumb %}<a href="/musehub/ui/users/{{ username }}">@{{ username }}</a>{% endblock %}

{% block extra_css %}
<style>
/* â”€â”€ Profile layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.profile-layout {
  display: grid;
  grid-template-columns: 260px 1fr;
  gap: var(--space-4);
  align-items: start;
}
@media (max-width: 768px) {
  .profile-layout { grid-template-columns: 1fr; }
}

/* â”€â”€ Avatar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.profile-avatar {
  width: 100%;
  aspect-ratio: 1;
  border-radius: 50%;
  object-fit: cover;
  margin-bottom: var(--space-3);
  display: block;
}
.profile-avatar-placeholder {
  width: 100%;
  aspect-ratio: 1;
  background: var(--color-surface-2, #161b22);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 3rem;
  color: #e6edf3;
  margin-bottom: var(--space-3);
}

/* â”€â”€ Contribution heatmap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.heatmap-grid {
  display: grid;
  grid-template-columns: repeat(52, 1fr);
  gap: 2px;
  margin-bottom: var(--space-3);
  overflow-x: auto;
}
.heatmap-week {
  display: grid;
  grid-template-rows: repeat(7, 1fr);
  gap: 2px;
}
.heatmap-cell {
  height: 12px;
  border-radius: 2px;
  background: var(--color-surface-2, #161b22);
}
.heatmap-cell[data-level="1"] { background: #0d4429; }
.heatmap-cell[data-level="2"] { background: #006d32; }
.heatmap-cell[data-level="3"] { background: #26a641; }
.heatmap-cell[data-level="4"] { background: #39d353; }

/* â”€â”€ Badge cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.badge-grid {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-2);
  margin-bottom: var(--space-4);
}
.badge-card {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  padding: var(--space-2) var(--space-3);
  border-radius: 6px;
  border: 1px solid var(--border, #30363d);
  background: var(--color-surface-2, #161b22);
  opacity: 0.45;
}
.badge-card.earned {
  border-color: #39d353;
  background: #0d4429;
  opacity: 1;
}
.badge-icon { font-size: 1.4rem; line-height: 1; }
.badge-name { font-weight: 600; font-size: 13px; }
.badge-desc { font-size: 11px; color: #8b949e; margin-top: 2px; }

/* â”€â”€ Pinned repos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pinned-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: var(--space-3);
  margin-bottom: var(--space-4);
}
.pinned-card {
  padding: var(--space-3);
  border: 1px solid var(--border, #30363d);
  border-radius: 6px;
  background: var(--color-surface-2, #161b22);
}
.pinned-card h3 { margin: 0 0 var(--space-2); font-size: 14px; }
.pinned-card p  { font-size: 12px; color: #8b949e; margin: 0 0 var(--space-2); }
.pinned-meta    { display: flex; gap: var(--space-2); font-size: 11px; color: #8b949e; }

/* â”€â”€ Activity feed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.activity-row {
  display: flex;
  align-items: flex-start;
  gap: var(--space-2);
  padding: var(--space-2) 0;
  border-bottom: 1px solid var(--border, #21262d);
  font-size: 13px;
}
.activity-type {
  font-size: 11px;
  color: #8b949e;
  white-space: nowrap;
  padding-top: 2px;
  min-width: 100px;
}
.activity-desc { flex: 1; }
.activity-date { font-size: 11px; color: #8b949e; white-space: nowrap; }
</style>
{% endblock %}

{% block content %}
<div class="profile-layout">

  {# â”€â”€ Left column: avatar, bio, meta â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  <aside>
    {% if profile.avatar_url %}
      <img class="profile-avatar" src="{{ profile.avatar_url }}" alt="{{ username }}" />
    {% else %}
      <div class="profile-avatar-placeholder">{{ username[0] | upper }}</div>
    {% endif %}

    <h1 style="font-size:1.25rem;margin:0 0 var(--space-1)">
      {{ profile.display_name or username }}
    </h1>
    <p style="color:#8b949e;margin:0 0 var(--space-2)">@{{ username }}</p>

    {% if profile.bio %}
      <p style="margin:0 0 var(--space-2)">{{ profile.bio }}</p>
    {% endif %}

    {% if profile.location %}
      <p style="font-size:13px;margin:0 0 var(--space-1)">ğŸ“ {{ profile.location }}</p>
    {% endif %}

    {% if profile.website_url %}
      <p style="font-size:13px;margin:0 0 var(--space-1)">
        <a href="{{ profile.website_url }}" rel="nofollow noreferrer">{{ profile.website_url }}</a>
      </p>
    {% endif %}

    {% if profile.twitter_handle %}
      <p style="font-size:13px;margin:0 0 var(--space-1)">
        <a href="https://twitter.com/{{ profile.twitter_handle }}" rel="nofollow noreferrer">
          @{{ profile.twitter_handle }}
        </a>
      </p>
    {% endif %}

    {% if profile.is_verified %}
      <span class="badge badge-open" style="margin-top:var(--space-2);display:inline-block">
        âœ“ Verified
      </span>
    {% endif %}

    {% if profile.cc_license %}
      <p style="font-size:12px;color:#8b949e;margin-top:var(--space-2)">
        ğŸµ {{ profile.cc_license }}
      </p>
    {% endif %}
  </aside>

  {# â”€â”€ Right column: heatmap, badges, pinned repos, activity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  <main>

    {# 52Ã—7 contribution heatmap â€” server-rendered CSS grid, no JS #}
    <div class="card" style="margin-bottom:var(--space-4)">
      <h2 style="margin-bottom:var(--space-3)">ğŸ“ˆ Contribution Activity</h2>
      <div class="heatmap-grid">
        {% for week in heatmap_weeks %}
        <div class="heatmap-week">
          {% for day in week %}
          <div class="heatmap-cell"
               data-level="{{ day.intensity }}"
               title="{{ day.date }}: {{ day.count }} commit{{ 's' if day.count != 1 else '' }}">
          </div>
          {% endfor %}
        </div>
        {% endfor %}
      </div>
      <p style="font-size:12px;color:#8b949e;margin:var(--space-2) 0 0">
        {{ heatmap_stats.total_contributions }} contributions in the last year
        Â· Longest streak: {{ heatmap_stats.longest_streak }} days
        Â· Current streak: {{ heatmap_stats.current_streak }} days
      </p>
    </div>

    {# Achievement badges â€” server-rendered, earned ones highlighted #}
    {% if badges %}
    <div class="card" style="margin-bottom:var(--space-4)">
      {% set earned_count = badges | selectattr('earned') | list | length %}
      <h2 style="margin-bottom:var(--space-3)">
        ğŸ† Achievements ({{ earned_count }}/{{ badges | length }})
      </h2>
      <div class="badge-grid">
        {% for badge in badges %}
        <div class="badge-card {% if badge.earned %}earned{% endif %}"
             title="{{ badge.description }}">
          <span class="badge-icon">{{ badge.icon }}</span>
          <div>
            <div class="badge-name">{{ badge.name }}</div>
            <div class="badge-desc">{{ badge.description }}</div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    {# Pinned repos â€” up to 6, server-rendered #}
    {% if pinned_repos %}
    <div class="card" style="margin-bottom:var(--space-4)">
      <h2 style="margin-bottom:var(--space-3)">ğŸ“Œ Pinned Repositories</h2>
      <div class="pinned-grid">
        {% for repo in pinned_repos %}
        <div class="pinned-card">
          <h3>
            <a href="/musehub/ui/{{ repo.owner }}/{{ repo.slug }}">{{ repo.name }}</a>
          </h3>
          {% if repo.description %}
            <p>{{ repo.description }}</p>
          {% endif %}
          <div class="pinned-meta">
            {% if repo.primary_genre %}
              <span>ğŸµ {{ repo.primary_genre }}</span>
            {% endif %}
            {% if repo.language %}
              <span>ğŸ”¤ {{ repo.language }}</span>
            {% endif %}
            <span>â­ {{ repo.star_count }}</span>
            <span>ğŸŒ¿ {{ repo.fork_count }}</span>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    {# Activity feed â€” server-rendered, paginated #}
    <div class="card">
      <h2 style="margin-bottom:var(--space-3)">âš¡ Activity</h2>

      {# Filter tabs #}
      <div style="display:flex;gap:var(--space-2);flex-wrap:wrap;margin-bottom:var(--space-3)">
        {% for filter_key, filter_label in [
            ('all', 'All'), ('commits', 'Commits'), ('prs', 'PRs'),
            ('issues', 'Issues'), ('stars', 'Stars')] %}
        <a href="?tab={{ filter_key }}&page=1"
           class="btn {% if activity_filter == filter_key %}btn-primary{% else %}btn-secondary{% endif %}"
           style="font-size:12px">
          {{ filter_label }}
        </a>
        {% endfor %}
      </div>

      {% if activity %}
        {% for event in activity %}
        <div class="activity-row">
          <span class="activity-type">{{ event.event_type | replace('_', ' ') }}</span>
          <span class="activity-desc">
            {{ event.description }}
            {% if event.repo_owner and event.repo_slug %}
              in <a href="/musehub/ui/{{ event.repo_owner }}/{{ event.repo_slug }}">
                {{ event.repo_name or event.repo_slug }}</a>
            {% endif %}
          </span>
          <span class="activity-date">{{ event.created_at | fmtrelative }}</span>
        </div>
        {% endfor %}

        {# Pagination #}
        {% set total_pages = ((total_events + per_page - 1) // per_page) %}
        {% if total_pages > 1 %}
        <div style="display:flex;gap:var(--space-2);justify-content:center;margin-top:var(--space-3)">
          {% if page > 1 %}
            <a href="?tab={{ activity_filter }}&page={{ page - 1 }}" class="btn btn-secondary">
              â† Prev
            </a>
          {% endif %}
          <span style="font-size:13px;color:#8b949e;padding:6px">
            Page {{ page }} of {{ total_pages }}
          </span>
          {% if page < total_pages %}
            <a href="?tab={{ activity_filter }}&page={{ page + 1 }}" class="btn btn-secondary">
              Next â†’
            </a>
          {% endif %}
        </div>
        {% endif %}
      {% else %}
        <p style="color:#8b949e">No activity yet.</p>
      {% endif %}
    </div>

  </main>
</div>
{% endblock %}
