{% extends "musehub/base.html" %}

{% block title %}Fork Network â€” {{ owner }}/{{ repo_slug }}{% endblock %}
{% block breadcrumb %}
  <a href="/musehub/ui/{{ owner }}">{{ owner }}</a> /
  <a href="/musehub/ui/{{ owner }}/{{ repo_slug }}">{{ repo_slug }}</a> / forks
{% endblock %}
{% block repo_nav %}{% include "musehub/partials/repo_nav.html" %}{% endblock %}

{% block extra_css %}
<style>
/* â”€â”€ Fork network SVG canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#fork-canvas {
  width: 100%;
  overflow-x: auto;
  background: var(--bg-canvas, #0d1117);
  border: 1px solid var(--border, #30363d);
  border-radius: 8px;
  padding: 16px;
  min-height: 220px;
}
.fork-svg {
  display: block;
  overflow: visible;
}

/* Nodes */
.fork-node-label {
  font-family: ui-monospace, monospace;
  font-size: 11px;
  fill: var(--text-primary, #e6edf3);
  text-anchor: middle;
  dominant-baseline: middle;
  pointer-events: none;
}
.fork-node-sub {
  font-size: 10px;
  fill: var(--text-muted, #8b949e);
  text-anchor: middle;
  dominant-baseline: middle;
  pointer-events: none;
}

/* Legend */
.legend {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  margin-bottom: 12px;
  font-size: 12px;
  color: var(--text-muted, #8b949e);
  align-items: center;
}
.legend-swatch {
  display: inline-block;
  width: 28px;
  height: 4px;
  border-radius: 2px;
  vertical-align: middle;
  margin-right: 4px;
}

/* Detail panel */
#fork-detail { margin-top: 16px; display: none; }
.fork-card {
  background: var(--bg-overlay, #161b22);
  border: 1px solid var(--border, #30363d);
  border-radius: 8px;
  padding: 16px 20px;
}
.fork-card-title {
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--text-primary, #e6edf3);
}
.fork-card-meta {
  font-size: 12px;
  color: var(--text-muted, #8b949e);
  margin-bottom: 12px;
}
.fork-card-actions { display: flex; gap: 8px; flex-wrap: wrap; }

/* Stats bar */
.stats-bar {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  margin-bottom: 16px;
  font-size: 13px;
  color: var(--text-secondary, #c9d1d9);
}
.stat { display: flex; align-items: center; gap: 4px; }
.stat-count { font-weight: 600; color: var(--text-primary, #e6edf3); }

/* Fork table â€” server-rendered, no JS required */
.fork-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
  margin-top: 16px;
}
.fork-table th {
  text-align: left;
  padding: 8px 10px;
  border-bottom: 1px solid var(--border, #30363d);
  color: var(--text-muted, #8b949e);
  font-weight: 500;
  font-size: 12px;
}
.fork-table td {
  padding: 10px;
  border-bottom: 1px solid var(--border, #21262d);
  color: var(--text-secondary, #c9d1d9);
  vertical-align: middle;
}
.fork-table tr:last-child td { border-bottom: none; }
.fork-table tr:hover td { background: rgba(255,255,255,0.03); }
.avatar-badge {
  display: inline-flex;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: var(--bg-overlay, #161b22);
  border: 1px solid var(--border, #30363d);
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 600;
  color: var(--text-muted, #8b949e);
  vertical-align: middle;
  margin-right: 6px;
}
</style>
{% endblock %}

{% block page_data %}
const repoId   = {{ repo_id | tojson }};
const owner    = {{ owner | tojson }};
const repoSlug = {{ repo_slug | tojson }};
const base     = {{ base_url | tojson }};
{# Embed full fork network for the SVG DAG renderer â€” no async fetch needed. #}
window.__forkNetwork = {{ fork_network_json | tojson }};
{% endblock %}

{% block page_script %}
{% raw %}
// â”€â”€ Colour scale by divergence (commits ahead) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function divColour(ahead) {
  if (ahead === 0)  return '#3fb950'; // green  â€” in sync
  if (ahead <= 5)   return '#d29922'; // yellow â€” slightly ahead
  if (ahead <= 20)  return '#e3964e'; // orange â€” moderately diverged
  return '#f85149';                    // red    â€” highly diverged
}

// â”€â”€ SVG namespace helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function svgEl(tag, attrs) {
  const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
  for (const [k, v] of Object.entries(attrs)) el.setAttribute(k, String(v));
  return el;
}

// â”€â”€ Layout constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const NW = 140, NH = 50, HGAP = 50, VGAP = 80, PAD = 20;

function buildLayout(rootNode, forks) {
  const colCount = Math.max(1, forks.length);
  const svgW = Math.max(500, colCount * (NW + HGAP) + HGAP);

  const rootX = svgW / 2 - NW / 2;
  const rootY = PAD;

  const childY   = PAD + NH + VGAP;
  const totalW   = forks.length * NW + Math.max(0, forks.length - 1) * HGAP;
  const startX   = svgW / 2 - totalW / 2;
  const svgH     = forks.length > 0 ? childY + NH + PAD : NH + PAD * 2;

  const children = forks.map((f, i) => ({
    x: startX + i * (NW + HGAP),
    y: childY,
    node: f,
  }));

  return { svgW, svgH, rootX, rootY, children };
}

// â”€â”€ Render the SVG DAG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDAG(rootNode, forks) {
  const { svgW, svgH, rootX, rootY, children } = buildLayout(rootNode, forks);
  const svg = document.getElementById('fork-svg');
  if (!svg) return;
  while (svg.firstChild) svg.removeChild(svg.firstChild);

  svg.setAttribute('viewBox', `0 0 ${svgW} ${svgH}`);
  svg.setAttribute('width', svgW);
  svg.setAttribute('height', svgH);

  // Arrowhead marker
  const defs   = svgEl('defs', {});
  const marker = svgEl('marker', {
    id: 'arr', markerWidth: '8', markerHeight: '6',
    refX: '7', refY: '3', orient: 'auto',
  });
  marker.appendChild(svgEl('polygon', { points: '0 0, 8 3, 0 6', fill: '#8b949e' }));
  defs.appendChild(marker);
  svg.appendChild(defs);

  // Edges from root to children
  const rx = rootX + NW / 2, ry = rootY + NH;
  for (const { x, y, node } of children) {
    const cx  = x + NW / 2;
    const mid = (ry + y) / 2;
    const col = divColour(node.divergenceCommits || 0);
    svg.appendChild(svgEl('path', {
      d: `M${rx},${ry} C${rx},${mid} ${cx},${mid} ${cx},${y}`,
      fill: 'none',
      stroke: col,
      'stroke-width': '1.5',
      'marker-end': 'url(#arr)',
    }));
  }

  // Root node
  svg.appendChild(makeNode(rootX, rootY, rootNode, true));

  // Fork children
  for (const { x, y, node } of children) {
    svg.appendChild(makeNode(x, y, node, false));
  }
}

function makeNode(x, y, node, isRoot) {
  const g = svgEl('g', { style: 'cursor:pointer', tabindex: '0', role: 'button',
                          'aria-label': `${node.owner}/${node.repoSlug}` });
  const col = isRoot ? '#3fb950' : divColour(node.divergenceCommits || 0);

  // Background
  g.appendChild(svgEl('rect', {
    x, y, width: NW, height: NH,
    rx: '8', ry: '8',
    fill: 'var(--bg-overlay, #161b22)',
    stroke: col, 'stroke-width': isRoot ? '2' : '1.5',
  }));

  // Label: owner/slug
  const lbl = svgEl('text', { x: x + NW / 2, y: y + 18, class: 'fork-node-label' });
  lbl.textContent = `${node.owner}/${node.repoSlug}`;
  g.appendChild(lbl);

  // Sub-label: divergence
  const sub = svgEl('text', { x: x + NW / 2, y: y + 34, class: 'fork-node-sub', fill: col });
  if (isRoot) {
    sub.textContent = 'â—‰ upstream';
    sub.setAttribute('fill', '#3fb950');
  } else {
    const a = node.divergenceCommits || 0;
    sub.textContent = a === 0 ? 'â‰¡ in sync' : `+${a} ahead`;
  }
  g.appendChild(sub);

  g.addEventListener('click', () => showDetail(node, isRoot));
  g.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') showDetail(node, isRoot); });

  return g;
}

// â”€â”€ Detail panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showDetail(node, isRoot) {
  const panel = document.getElementById('fork-detail');
  if (!panel) return;
  panel.style.display = '';

  const ahead   = node.divergenceCommits || 0;
  const col     = divColour(ahead);
  const initial = (node.owner || '?').charAt(0).toUpperCase();
  const repoHref = `/musehub/ui/${escHtml(node.owner)}/${escHtml(node.repoSlug)}`;
  const compareHref  = `${base}/compare/${encodeURIComponent(node.repoSlug)}`;
  const prHref = `${base}/pulls/new?head=${encodeURIComponent(node.owner + ':main')}`;

  panel.innerHTML = `
    <div class="fork-card">
      <div class="fork-card-title">
        <span class="avatar-badge">${escHtml(initial)}</span>
        <a href="${repoHref}" style="color:var(--accent,#58a6ff)">
          ${escHtml(node.owner)}/${escHtml(node.repoSlug)}
        </a>
        ${isRoot ? ' <span style="font-size:12px;color:#3fb950">â—‰ upstream</span>' : ''}
      </div>
      <div class="fork-card-meta">
        ${isRoot
          ? 'This is the upstream (source) repository.'
          : `Forked by <strong>${escHtml(node.forkedBy || node.owner)}</strong>
             &bull; <span style="color:${col}">+${ahead} commit${ahead !== 1 ? 's' : ''} ahead</span>`}
      </div>
      <div class="fork-card-actions">
        ${!isRoot ? `
          <a class="btn btn-secondary" href="${compareHref}" style="font-size:13px">ğŸ”€ Compare</a>
          <a class="btn btn-primary"   href="${prHref}"      style="font-size:13px">â†‘ Contribute upstream</a>
        ` : ''}
        <a class="btn btn-secondary" href="${repoHref}" style="font-size:13px">View repo â†’</a>
      </div>
    </div>`;
}

// â”€â”€ Bootstrap: render SVG DAG from embedded JSON (no API fetch needed) â”€â”€â”€â”€
function load() {
  initRepoNav(repoId);
  const data  = window.__forkNetwork || {};
  const root  = data.root || {};
  const forks = root.children || [];
  renderDAG(root, forks);
}

load();
{% endraw %}
{% endblock %}

{% block content %}
<div style="margin-bottom:12px"><a href="{{ base_url }}">&larr; Back to repo</a></div>
<div class="card">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px">
    <h1 style="margin:0">ğŸ´ Fork Network</h1>
    <span style="font-size:13px;color:var(--text-muted,#8b949e)">
      {{ total_forks }} fork{{ 's' if total_forks != 1 else '' }}
    </span>
  </div>

  {# Divergence legend â€” static, no JS needed #}
  <div class="legend">
    <span><span class="legend-swatch" style="background:#3fb950"></span>In sync / upstream</span>
    <span><span class="legend-swatch" style="background:#d29922"></span>1â€“5 commits ahead</span>
    <span><span class="legend-swatch" style="background:#e3964e"></span>6â€“20 ahead</span>
    <span><span class="legend-swatch" style="background:#f85149"></span>&gt;20 ahead</span>
  </div>

  {# Stats bar â€” server-rendered so visible immediately without JS #}
  <div class="stats-bar">
    <div class="stat">
      ğŸ´ <span class="stat-count">{{ total_forks }}</span>
      fork{{ 's' if total_forks != 1 else '' }}
    </div>
  </div>

  {# SVG DAG â€” complex layout algorithm requires JS; reads window.__forkNetwork #}
  <div id="fork-canvas">
    <svg id="fork-svg" class="fork-svg"
         role="img"
         aria-label="Fork network DAG â€” {{ total_forks }} fork{{ 's' if total_forks != 1 else '' }}"></svg>
  </div>
  <p style="font-size:12px;color:var(--text-muted,#8b949e);margin-top:6px">
    Click a node to view fork details and action buttons.
  </p>

  {# Click-selected detail panel â€” populated by DAG JS on node click #}
  <div id="fork-detail"></div>

  {# Fork table â€” server-rendered; visible without JavaScript #}
  {% if forks %}
  <table class="fork-table" id="fork-table">
    <thead>
      <tr>
        <th>Fork</th>
        <th>Divergence</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for fork in forks %}
      <tr>
        <td>
          <span class="avatar-badge">{{ fork.owner[0] | upper }}</span>
          <a href="/musehub/ui/{{ fork.owner }}/{{ fork.repo_slug }}"
             style="color:var(--accent,#58a6ff);font-weight:500">
            {{ fork.owner }}/{{ fork.repo_slug }}
          </a>
        </td>
        <td>
          {% if fork.divergence_commits == 0 %}
            <span style="color:#3fb950">â‰¡ in sync</span>
          {% elif fork.divergence_commits <= 5 %}
            <span style="color:#d29922">+{{ fork.divergence_commits }} ahead</span>
          {% elif fork.divergence_commits <= 20 %}
            <span style="color:#e3964e">+{{ fork.divergence_commits }} ahead</span>
          {% else %}
            <span style="color:#f85149">+{{ fork.divergence_commits }} ahead</span>
          {% endif %}
        </td>
        <td>
          <a class="btn btn-secondary"
             href="{{ base_url }}/compare/{{ fork.repo_slug }}"
             style="font-size:12px">Compare</a>
          <a class="btn btn-secondary"
             href="{{ base_url }}/pulls/new?head={{ fork.owner }}:main"
             style="font-size:12px;margin-left:4px">Contribute upstream</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p id="no-forks-msg" style="color:var(--text-muted,#8b949e);margin-top:12px">
    No forks yet â€” be the first!
  </p>
  {% endif %}
</div>
{% endblock %}
