{% extends "musehub/base.html" %}

{% block title %}Labels{% endblock %}
{% block breadcrumb %}
  <a href="/musehub/ui/{{ owner }}/{{ repo_slug }}">{{ owner }}/{{ repo_slug }}</a> / labels
{% endblock %}
{% block repo_nav %}{% include "musehub/partials/repo_nav.html" %}{% endblock %}

{% block extra_css %}
<style>
/* â”€â”€ Label management page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.labels-toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 18px;
  flex-wrap: wrap;
  gap: 10px;
}
.labels-toolbar h1 { margin: 0; }
.toolbar-actions { display: flex; gap: 8px; flex-wrap: wrap; }

/* Create / edit form card */
.label-form-card {
  background: var(--bg-overlay, #161b22);
  border: 1px solid var(--border, #30363d);
  border-radius: 8px;
  padding: 18px;
  margin-bottom: 18px;
  display: none;
}
.label-form-card.active { display: block; }
.label-form-row {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: flex-end;
  margin-bottom: 10px;
}
.label-form-group { display: flex; flex-direction: column; gap: 4px; flex: 1; min-width: 140px; }
.label-form-group label { font-size: 12px; color: var(--text-muted, #8b949e); font-weight: 500; }
.label-form-group input[type="text"],
.label-form-group input[type="color"] {
  border: 1px solid var(--border, #30363d);
  border-radius: 6px;
  background: var(--bg-base, #0d1117);
  color: var(--text-primary, #e6edf3);
  font-size: 14px;
  padding: 6px 10px;
}
.label-form-group input[type="color"] {
  padding: 3px 6px;
  height: 36px;
  cursor: pointer;
  width: 60px;
  flex: 0 0 60px;
  min-width: 60px;
}
.form-actions { display: flex; gap: 8px; flex-wrap: wrap; }
.color-preview {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  color: var(--text-muted, #8b949e);
}
.color-preview-swatch {
  width: 20px;
  height: 20px;
  border-radius: 4px;
  border: 1px solid var(--border, #30363d);
}

/* Label rows */
.label-list { display: flex; flex-direction: column; gap: 0; }
.label-row {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 0;
  border-bottom: 1px solid var(--border, #30363d);
  flex-wrap: wrap;
}
.label-row:last-child { border-bottom: none; }
.label-swatch {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  flex-shrink: 0;
}
.label-pill {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  border-radius: 999px;
  padding: 3px 10px;
  font-size: 13px;
  font-weight: 600;
  line-height: 1.4;
  white-space: nowrap;
  /* color set inline */
}
.label-info { flex: 1; min-width: 120px; }
.label-desc { font-size: 12px; color: var(--text-muted, #8b949e); margin-top: 2px; }
.issue-count-badge {
  font-size: 12px;
  color: var(--text-muted, #8b949e);
  white-space: nowrap;
}
.label-row-actions {
  display: none;  /* shown only when authed */
  gap: 6px;
  flex-shrink: 0;
}
.label-row-actions.visible { display: flex; }

/* Inline edit form row */
.label-edit-form {
  width: 100%;
  background: var(--bg-overlay, #161b22);
  border: 1px solid var(--border, #30363d);
  border-radius: 8px;
  padding: 14px;
  margin-top: 8px;
  display: none;
}
.label-edit-form.active { display: block; }

/* Utility */
.btn-danger { background: var(--red-dim, #3d1c1c); border-color: var(--red, #f85149); color: var(--red, #f85149); }
.btn-danger:hover { background: var(--red, #f85149); color: #fff; }
.empty-state { padding: 40px 0; text-align: center; color: var(--text-muted, #8b949e); }
.form-error { color: var(--red, #f85149); font-size: 13px; margin-top: 6px; display: none; }
.form-error.visible { display: block; }
</style>
{% endblock %}

{% block page_data %}
const repoId   = {{ repo_id | tojson }};
const base     = {{ base_url | tojson }};
const owner    = {{ owner | tojson }};
const repoSlug = {{ repo_slug | tojson }};
{% endblock %}

{% block page_script %}
{% raw %}
// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function contrastColor(hex) {
  // Return #000 or #fff depending on luminance of background hex colour.
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
  return luminance > 0.5 ? '#000000' : '#ffffff';
}

function pillStyle(color) {
  return `background:${color};color:${contrastColor(color)}`;
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderLabelRow(label, authed) {
  const actionsClass = authed ? 'label-row-actions visible' : 'label-row-actions';
  const issueWord = label.issue_count === 1 ? 'issue' : 'issues';
  return `
    <div class="label-row" id="label-row-${label.label_id}" data-label-id="${label.label_id}">
      <span class="label-pill" style="${pillStyle(label.color)}">
        ${escHtml(label.name)}
      </span>
      <div class="label-info">
        ${label.description ? `<div class="label-desc">${escHtml(label.description)}</div>` : ''}
      </div>
      <span class="issue-count-badge">
        <a href="${base}/issues?label=${encodeURIComponent(label.name)}"
           style="color:inherit;text-decoration:none">
          ${label.issue_count} ${issueWord}
        </a>
      </span>
      <div class="${actionsClass}">
        <button class="btn btn-secondary" style="font-size:12px;padding:4px 10px"
                onclick="openEditForm('${label.label_id}')">Edit</button>
        <button class="btn btn-danger" style="font-size:12px;padding:4px 10px"
                onclick="deleteLabel('${label.label_id}', '${escHtml(label.name)}')">Delete</button>
      </div>
      <!-- Inline edit form for this label -->
      <div class="label-edit-form" id="edit-form-${label.label_id}">
        <div class="label-form-row">
          <div class="label-form-group">
            <label>Name</label>
            <input type="text" id="edit-name-${label.label_id}" value="${escHtml(label.name)}"
                   maxlength="50" placeholder="Label name">
          </div>
          <div class="label-form-group" style="flex:0 0 auto">
            <label>Colour</label>
            <input type="color" id="edit-color-${label.label_id}" value="${label.color}"
                   oninput="updateEditPreview('${label.label_id}')">
          </div>
          <div class="label-form-group">
            <label>Description (optional)</label>
            <input type="text" id="edit-desc-${label.label_id}"
                   value="${label.description ? escHtml(label.description) : ''}"
                   maxlength="200" placeholder="Short description">
          </div>
        </div>
        <div class="form-actions">
          <button class="btn btn-primary" style="font-size:13px"
                  onclick="submitEdit('${label.label_id}')">Save changes</button>
          <button class="btn btn-secondary" style="font-size:13px"
                  onclick="closeEditForm('${label.label_id}')">Cancel</button>
        </div>
        <div class="form-error" id="edit-error-${label.label_id}"></div>
      </div>
    </div>`;
}

function renderLabels(labels, authed) {
  if (labels.length === 0) {
    return `<div class="empty-state">
      <p>No labels yet. Click <strong>New label</strong> to get started.</p>
    </div>`;
  }
  return `<div class="label-list">${labels.map(l => renderLabelRow(l, authed)).join('')}</div>`;
}

// â”€â”€ Create form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function updateColorPreview() {
  const color = document.getElementById('create-color').value;
  const swatch = document.getElementById('create-color-swatch');
  const preview = document.getElementById('create-color-preview-pill');
  if (swatch) swatch.style.background = color;
  if (preview) {
    preview.style.background = color;
    preview.style.color = contrastColor(color);
    const name = document.getElementById('create-name').value.trim();
    preview.textContent = name || 'Preview';
  }
}

function updateEditPreview(labelId) {
  const color = document.getElementById(`edit-color-${labelId}`).value;
  // Optionally update some preview â€” for now just let the save do it.
}

function toggleCreateForm() {
  const form = document.getElementById('create-form');
  if (!form) return;
  const isActive = form.classList.contains('active');
  form.classList.toggle('active', !isActive);
  if (!isActive) document.getElementById('create-name').focus();
}

// â”€â”€ Edit form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openEditForm(labelId) {
  // Close any other open edit forms first.
  document.querySelectorAll('.label-edit-form.active').forEach(el => el.classList.remove('active'));
  const form = document.getElementById(`edit-form-${labelId}`);
  if (form) form.classList.add('active');
}

function closeEditForm(labelId) {
  const form = document.getElementById(`edit-form-${labelId}`);
  if (form) form.classList.remove('active');
}

// â”€â”€ API calls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function submitCreate() {
  const name = document.getElementById('create-name').value.trim();
  const color = document.getElementById('create-color').value;
  const desc = document.getElementById('create-desc').value.trim() || null;
  const errEl = document.getElementById('create-error');
  if (!name) { showErr(errEl, 'Name is required'); return; }

  try {
    await apiFetch(`/ui/${owner}/${repoSlug}/labels`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, color, description: desc }),
    });
    hideErr(errEl);
    document.getElementById('create-form').classList.remove('active');
    document.getElementById('create-name').value = '';
    document.getElementById('create-color').value = '#a2eeef';
    document.getElementById('create-desc').value = '';
    load();
  } catch(e) {
    if (e.message !== 'auth') showErr(errEl, e.message || 'Failed to create label');
  }
}

async function submitEdit(labelId) {
  const name  = document.getElementById(`edit-name-${labelId}`).value.trim() || null;
  const color = document.getElementById(`edit-color-${labelId}`).value || null;
  const desc  = document.getElementById(`edit-desc-${labelId}`).value.trim() || null;
  const errEl = document.getElementById(`edit-error-${labelId}`);

  try {
    await apiFetch(`/ui/${owner}/${repoSlug}/labels/${labelId}/edit`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, color, description: desc }),
    });
    hideErr(errEl);
    load();
  } catch(e) {
    if (e.message !== 'auth') showErr(errEl, e.message || 'Failed to save changes');
  }
}

async function deleteLabel(labelId, labelName) {
  if (!confirm(`Delete label "${labelName}"? This removes it from all issues and pull requests.`)) return;
  try {
    await apiFetch(`/ui/${owner}/${repoSlug}/labels/${labelId}/delete`, { method: 'POST' });
    load();
  } catch(e) {
    if (e.message !== 'auth') alert('Failed to delete label: ' + (e.message || 'unknown error'));
  }
}

async function resetLabels() {
  if (!confirm('Reset to defaults? All current labels and their associations will be deleted and replaced with the 10 default labels.')) return;
  try {
    await apiFetch(`/ui/${owner}/${repoSlug}/labels/reset`, { method: 'POST' });
    load();
  } catch(e) {
    if (e.message !== 'auth') alert('Reset failed: ' + (e.message || 'unknown error'));
  }
}

// â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function showErr(el, msg) { if (el) { el.textContent = msg; el.classList.add('visible'); } }
function hideErr(el) { if (el) { el.textContent = ''; el.classList.remove('visible'); } }

// â”€â”€ Load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function load() {
  initRepoNav(repoId);
  document.getElementById('content').innerHTML = '<p class="loading">Loading labelsâ€¦</p>';

  try {
    const data   = await apiFetch(`/repos/${repoId}/labels`);
    const labels = data.items || [];
    const authed = !!getToken();

    const resetBtn = authed
      ? `<button class="btn btn-secondary" onclick="resetLabels()"
                style="font-size:13px">â†º Reset to defaults</button>`
      : '';
    const newBtn = authed
      ? `<button class="btn btn-primary" onclick="toggleCreateForm()"
                style="font-size:13px">+ New label</button>`
      : '';

    // Build create form (visible only when authed and toggled).
    const createForm = authed ? `
      <div class="label-form-card" id="create-form">
        <h3 style="margin:0 0 14px">New label</h3>
        <div class="label-form-row">
          <div class="label-form-group">
            <label>Name *</label>
            <input type="text" id="create-name" maxlength="50" placeholder="e.g. bug"
                   oninput="updateColorPreview()">
          </div>
          <div class="label-form-group" style="flex:0 0 auto">
            <label>Colour</label>
            <input type="color" id="create-color" value="#a2eeef"
                   oninput="updateColorPreview()">
          </div>
          <div class="label-form-group">
            <label>Description (optional)</label>
            <input type="text" id="create-desc" maxlength="200" placeholder="Short description">
          </div>
        </div>
        <div class="form-actions">
          <button class="btn btn-primary" style="font-size:13px" onclick="submitCreate()">Create label</button>
          <button class="btn btn-secondary" style="font-size:13px"
                  onclick="document.getElementById('create-form').classList.remove('active')">Cancel</button>
          <span class="color-preview">
            Preview: <span id="create-color-preview-pill" class="label-pill" style="background:#a2eeef;color:#000">Preview</span>
          </span>
        </div>
        <div class="form-error" id="create-error"></div>
      </div>` : '';

    document.getElementById('content').innerHTML = `
      <div style="margin-bottom:12px">
        <a href="${base}">&larr; Back to repo</a>
      </div>
      <div class="card">
        <div class="labels-toolbar">
          <h1>ğŸ· Labels <span style="font-size:16px;font-weight:400;color:var(--text-muted,#8b949e)">(${labels.length})</span></h1>
          <div class="toolbar-actions">
            ${resetBtn}
            ${newBtn}
          </div>
        </div>
        ${createForm}
        ${renderLabels(labels, authed)}
      </div>`;
  } catch(e) {
    if (e.message !== 'auth')
      document.getElementById('content').innerHTML = '<p class="error">âœ• ' + escHtml(e.message) + '</p>';
  }
}

load();
{% endraw %}
{% endblock %}
