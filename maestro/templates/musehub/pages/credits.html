{% extends "musehub/base.html" %}

{% block title %}Credits{% endblock %}
{% block breadcrumb %}
  <a href="/musehub/ui/{{ owner }}/{{ repo_slug }}">{{ owner }}/{{ repo_slug }}</a> / credits
{% endblock %}
{% block repo_nav %}{% include "musehub/partials/repo_nav.html" %}{% endblock %}

{% block page_data %}
const repoId = {{ repo_id | tojson }};
const base   = {{ base_url | tojson }};
{% endblock %}

{% block page_script %}
{% raw %}
function fmtYear(iso) {
  if (!iso) return '--';
  return new Date(iso).getFullYear();
}

/**
 * Deterministic hsl background from a username string — ensures a stable,
 * visually distinct colour per contributor without storing any colour data.
 */
function avatarHsl(username) {
  let hash = 0;
  for (let i = 0; i < username.length; i++) {
    hash = username.charCodeAt(i) + ((hash << 5) - hash);
  }
  const hue = Math.abs(hash) % 360;
  return `hsl(${hue},45%,32%)`;
}

/**
 * Render an avatar circle: real image if avatarUrl is present, otherwise the
 * contributor's first character on a deterministic hsl background.
 */
function avatarCircle(username, avatarUrl) {
  const size = 'width:36px;height:36px;border-radius:50%;flex-shrink:0;';
  if (avatarUrl) {
    return `<img src="${escHtml(avatarUrl)}" alt="${escHtml(username)}"
              style="${size}object-fit:cover;border:2px solid #30363d;" />`;
  }
  const bg = avatarHsl(username);
  const initial = escHtml(username.charAt(0).toUpperCase());
  return `<div style="${size}background:${bg};display:flex;align-items:center;
              justify-content:center;font-size:16px;font-weight:700;
              color:#e6edf3;border:2px solid #30363d;">${initial}</div>`;
}

function contributorRow(c, profile) {
  const roles = (c.contributionTypes || []).map(r =>
    '<span class="label">' + escHtml(r) + '</span>'
  ).join(' ');
  const window = fmtDate(c.firstActive) + ' &ndash; ' + fmtDate(c.lastActive);

  const avatarUrl = profile ? (profile.avatarUrl || null) : null;
  const bio       = profile ? (profile.bio       || '')   : '';
  const bioPreview = bio.length > 80 ? escHtml(bio.slice(0, 80)) + '&hellip;' : escHtml(bio);

  const nameHtml = `<a href="/musehub/ui/users/${encodeURIComponent(c.author)}"
      style="font-size:15px;color:#e6edf3;font-weight:600;text-decoration:none;
             flex:1;word-break:break-word;"
      onmouseover="this.style.textDecoration='underline'"
      onmouseout="this.style.textDecoration='none'">${escHtml(c.author)}</a>`;

  return `
    <div class="commit-row" style="align-items:flex-start;flex-direction:column;gap:6px">
      <div style="display:flex;align-items:center;gap:10px;width:100%">
        ${avatarCircle(c.author, avatarUrl)}
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            ${nameHtml}
            <span class="badge badge-open" style="font-size:12px;background:#1a3a5c">
              ${c.sessionCount} session${c.sessionCount !== 1 ? 's' : ''}
            </span>
          </div>
          ${bioPreview ? `<div style="font-size:12px;color:#8b949e;margin-top:2px">${bioPreview}</div>` : ''}
        </div>
      </div>
      <div>${roles}</div>
      <div style="font-size:12px;color:#8b949e">${window}</div>
    </div>`;
}

function injectJsonLd(credits) {
  const contributors = (credits.contributors || []).map(c => ({
    '@type': 'Person',
    name: c.author,
    roleName: (c.contributionTypes || []).join(', '),
  }));
  const ld = {
    '@context': 'https://schema.org',
    '@type': 'MusicComposition',
    identifier: credits.repoId,
    contributor: contributors,
  };
  const el = document.createElement('script');
  el.type = 'application/ld+json';
  el.textContent = JSON.stringify(ld, null, 2);
  document.head.appendChild(el);
}

/**
 * Fetch a single user profile; returns null on any error (404, network, etc.)
 * so a missing/private profile never breaks the credits page.
 */
async function fetchProfile(username) {
  try {
    return await apiFetch('/users/' + encodeURIComponent(username));
  } catch (_) {
    return null;
  }
}

async function load(sort) {
  initRepoNav(repoId);
  try {
    const credits = await apiFetch('/repos/' + repoId + '/credits?sort=' + sort);
    const contributors = credits.contributors || [];

    injectJsonLd(credits);

    // Enrich every contributor row with profile data (avatar + bio) fetched in parallel.
    // A failed profile fetch returns null — the row still renders with a fallback initial.
    const profiles = await Promise.all(
      contributors.map(c => fetchProfile(c.author))
    );

    const rows = contributors.length === 0
      ? '<p class="loading">No sessions recorded yet. Start a session with <code>muse session start</code>.</p>'
      : contributors.map((c, i) => contributorRow(c, profiles[i])).join('');

    document.getElementById('content').innerHTML = `
      <div style="margin-bottom:12px">
        <a href="${base}">&larr; Back to repo</a>
      </div>
      <div class="card">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap">
          <h1 style="margin:0">&#127926; Credits</h1>
          <span style="flex:1"></span>
          <span style="font-size:13px;color:#8b949e">
            ${credits.totalContributors} contributor${credits.totalContributors !== 1 ? 's' : ''}
          </span>
          <label style="font-size:13px;color:#8b949e;display:flex;align-items:center;gap:6px">
            Sort:
            <select onchange="load(this.value)">
              <option value="count"   ${sort==='count'  ?'selected':''}>Most prolific</option>
              <option value="recency" ${sort==='recency'?'selected':''}>Most recent</option>
              <option value="alpha"   ${sort==='alpha'  ?'selected':''}>A &ndash; Z</option>
            </select>
          </label>
        </div>
        ${rows}
      </div>
      <p style="font-size:11px;color:#8b949e;margin-top:8px;text-align:center">
        Machine-readable credits embedded as JSON-LD (schema.org/MusicComposition)
      </p>`;
  } catch(e) {
    if (e.message !== 'auth')
      document.getElementById('content').innerHTML = '<p class="error">&#10005; ' + escHtml(e.message) + '</p>';
  }
}

load('count');
{% endraw %}
{% endblock %}
