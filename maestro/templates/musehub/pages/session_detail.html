{% extends "musehub/base.html" %}

{% block title %}Session {{ session_id[:8] }}{% endblock %}
{% block breadcrumb %}
  <a href="/musehub/ui/{{ owner }}/{{ repo_slug }}">{{ owner }}/{{ repo_slug }}</a> /
  <a href="/musehub/ui/{{ owner }}/{{ repo_slug }}/sessions">sessions</a> / {{ session_id[:8] }}
{% endblock %}
{% block repo_nav %}{% include "musehub/partials/repo_nav.html" %}{% endblock %}

{% block page_data %}
const repoId    = {{ repo_id | tojson }};
const sessionId = {{ session_id | tojson }};
const base      = {{ base_url | tojson }};
{% endblock %}

{% block page_script %}
{% raw %}
function fmtDuration(startIso, endIso) {
  if (!startIso || !endIso) return '--';
  const ms = new Date(endIso) - new Date(startIso);
  if (ms < 0) return '--';
  const h = Math.floor(ms / 3600000);
  const m = Math.floor((ms % 3600000) / 60000);
  return h > 0 ? h + 'h ' + m + 'm' : m + 'm';
}

async function loadSessionCounts() {
  try {
    const data = await apiFetch('/repos/' + repoId + '/sessions?limit=200');
    const sessions = data.sessions || [];
    const counts = {};
    sessions.forEach(s => {
      (s.participants || []).forEach(p => {
        counts[p] = (counts[p] || 0) + 1;
      });
    });
    return counts;
  } catch(e) {
    return {};
  }
}

async function load() {
  initRepoNav(repoId);
  try {
    const [session, counts] = await Promise.all([
      apiFetch('/repos/' + repoId + '/sessions/' + sessionId),
      loadSessionCounts(),
    ]);

    const duration = fmtDuration(session.startedAt, session.endedAt);

    const participantHtml = (session.participants || []).length === 0
      ? '<p style="color:#8b949e;font-size:14px">No participants recorded.</p>'
      : (session.participants || []).map(p => `
          <div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #21262d">
            <span style="flex:1;font-size:14px">${escHtml(p)}</span>
            <span class="badge" style="background:#1f6feb;color:#e6edf3">
              ${counts[p] || 1} session${(counts[p] || 1) !== 1 ? 's' : ''}
            </span>
          </div>`).join('');

    const commitHtml = (session.commits || []).length === 0
      ? '<p style="color:#8b949e;font-size:14px">No commits associated with this session.</p>'
      : (session.commits || []).map(c => `
          <div class="commit-row">
            <a class="commit-sha" href="${base}/commits/${c}">${c.substring(0,8)}</a>
            <span class="commit-msg"><a href="${base}/commits/${c}">${c}</a></span>
          </div>`).join('');

    const notesHtml = session.notes
      ? '<pre>' + escHtml(session.notes) + '</pre>'
      : '<p style="color:#8b949e;font-size:14px">No closing notes.</p>';

    const allSessions = await apiFetch('/repos/' + repoId + '/sessions?limit=200')
      .then(d => d.sessions || []).catch(() => []);
    const idx = allSessions.findIndex(s => s.sessionId === sessionId);
    const prevSession = idx >= 0 && idx + 1 < allSessions.length ? allSessions[idx + 1] : null;
    const nextSession = idx > 0 ? allSessions[idx - 1] : null;

    const navHtml = `
      <div style="display:flex;justify-content:space-between;margin-top:12px;font-size:13px">
        <span>
          ${prevSession
            ? '<a href="' + base + '/sessions/' + prevSession.sessionId + '">&larr; Previous session</a>'
            : '<span style="color:#8b949e">No previous session</span>'}
        </span>
        <span>
          ${nextSession
            ? '<a href="' + base + '/sessions/' + nextSession.sessionId + '">Next session &rarr;</a>'
            : '<span style="color:#8b949e">No next session</span>'}
        </span>
      </div>`;

    const isLive = !session.endedAt;
    document.getElementById('content').innerHTML = `
      <div class="card">
        <div style="display:flex;align-items:center;gap:var(--space-3);margin-bottom:var(--space-4);flex-wrap:wrap">
          <h1 style="margin:0">Recording Session</h1>
          ${isLive ? '<span class="badge badge-active" style="font-size:13px;animation:pulse 1.5s ease-in-out infinite">ðŸ”´ Live</span>' : ''}
          <a href="${base}/sessions" class="btn btn-ghost btn-sm" style="margin-left:auto">&larr; All sessions</a>
        </div>
        <div class="meta-row">
          <div class="meta-item">
            <span class="meta-label">Started</span>
            <span class="meta-value">${fmtDate(session.startedAt)}</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Ended</span>
            <span class="meta-value">${session.endedAt ? fmtDate(session.endedAt) : '<em class="text-muted">in progress</em>'}</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Duration</span>
            <span class="meta-value">${session.endedAt ? duration : fmtRelative(session.startedAt)}</span>
          </div>
          ${session.location ? `
          <div class="meta-item">
            <span class="meta-label">Location</span>
            <span class="meta-value">${escHtml(session.location)}</span>
          </div>` : ''}
          <div class="meta-item">
            <span class="meta-label">Session ID</span>
            <span class="meta-value text-mono text-sm">${shortSha(session.sessionId)}</span>
          </div>
        </div>
        ${session.intent ? `
        <div style="margin-top:var(--space-3)">
          <span class="meta-label">&#127358; Intent</span>
          <p style="margin-top:4px;font-size:var(--font-size-sm);color:var(--text-secondary)">${escHtml(session.intent)}</p>
        </div>` : ''}
        ${navHtml}
      </div>
      <div class="card">
        <h2>Participants (${(session.participants||[]).length})</h2>
        <div style="margin-top:8px">${participantHtml}</div>
      </div>
      <div class="card">
        <h2>Commits (${(session.commits||[]).length})</h2>
        <div style="margin-top:8px">${commitHtml}</div>
      </div>
      <div class="card">
        <h2>Closing Notes</h2>
        <div style="margin-top:8px">${notesHtml}</div>
      </div>`;
  } catch(e) {
    if (e.message !== 'auth') {
      const msg = e.message.startsWith('404') ? 'Session not found.' : escHtml(e.message);
      document.getElementById('content').innerHTML =
        '<div style="margin-bottom:12px"><a href="' + base + '/sessions">&larr; Back to sessions</a></div>' +
        '<p class="error">&#10005; ' + msg + '</p>';
    }
  }
}

let _liveTimer = null;

async function startLivePolling() {
  // Poll every 10 seconds for live sessions; stop when session ends
  _liveTimer = setInterval(async () => {
    try {
      const session = await apiFetch('/repos/' + repoId + '/sessions/' + sessionId);
      if (session.endedAt) {
        clearInterval(_liveTimer);
        // Reload to show final state
        load();
        return;
      }
      // Update participant list and commit count live
      const liveEl = document.getElementById('live-commit-count');
      if (liveEl) liveEl.textContent = (session.commits || []).length + ' commits so far';
    } catch(e) { /* non-fatal */ }
  }, 10000);
}

async function loadAndMaybePoll() {
  await load();
  // Check if session is live after load completes
  try {
    const session = await apiFetch('/repos/' + repoId + '/sessions/' + sessionId);
    if (!session.endedAt) startLivePolling();
  } catch(e) { /* non-fatal */ }
}

loadAndMaybePoll();
{% endraw %}
{% endblock %}
