{
  "setup-worktree-unix": [
    "COORD_PARENT='..'",
    "NOW=$(date +%s)",
    "find \"$COORD_PARENT\" -maxdepth 1 -type d -name '.coord-*' -mmin +60 -exec rm -rf {} + 2>/dev/null || true",
    "SESSION=''",
    "for dir in $COORD_PARENT/.coord-*; do",
    "  if [ -d \"$dir\" ]; then",
    "    CREATED=$(stat -c %W \"$dir\" 2>/dev/null || stat -f %B \"$dir\" 2>/dev/null || echo 0)",
    "    AGE=$((NOW - CREATED))",
    "    if [ $AGE -lt 10 ]; then",
    "      SESSION=$(basename \"$dir\" | sed 's/^\\.coord-//')",
    "      break",
    "    fi",
    "  fi",
    "done",
    "if [ -z \"$SESSION\" ]; then",
    "  SESSION=\"s-$(date +%Y%m%d%H%M%S)-$$\"",
    "fi",
    "COORD_DIR=\"$COORD_PARENT/.coord-$SESSION\"",
    "mkdir -p \"$COORD_DIR\"",
    "CURRENT_WORKTREE=$(pwd)",
    "for claim in \"$COORD_DIR\"/task-*.json; do",
    "  if [ -f \"$claim\" ]; then",
    "    WORKTREE=$(grep -o '\"worktree\":\"[^\"]*\"' \"$claim\" | cut -d'\"' -f4)",
    "    if [ -n \"$WORKTREE\" ] && [ ! -d \"$WORKTREE\" ]; then",
    "      rm -f \"$claim\"",
    "    fi",
    "  fi",
    "done",
    "TASK_NUM=0",
    "for i in 1 2; do",
    "  LOCK_DIR=\"$COORD_DIR/task-$i.lock\"",
    "  CLAIM_FILE=\"$COORD_DIR/task-$i.json\"",
    "  if mkdir \"$LOCK_DIR\" 2>/dev/null; then",
    "    if [ ! -f \"$CLAIM_FILE\" ]; then",
    "      TASK_NUM=$i",
    "      echo \"{\\\"task\\\":$i,\\\"worktree\\\":\\\"$CURRENT_WORKTREE\\\",\\\"claimed_at\\\":\\\"$(date -Iseconds)\\\",\\\"pid\\\":$$}\" > \"$CLAIM_FILE\"",
    "      rmdir \"$LOCK_DIR\"",
    "      break",
    "    fi",
    "    rmdir \"$LOCK_DIR\"",
    "  fi",
    "  sleep 0.05",
    "done",
    "echo \"$TASK_NUM\" > .agent-id",
    "echo \"$SESSION\" > .session-id",
    "cp \"$ROOT_WORKTREE_PATH/.env\" .env 2>/dev/null || true"
  ],
  "setup-worktree-windows": [
    "$coordParent = '..'",
    "$now = Get-Date",
    "Get-ChildItem -Path $coordParent -Directory -Filter '.coord-*' -ErrorAction SilentlyContinue | Where-Object { ($now - $_.CreationTime).TotalSeconds -gt 3600 } | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue",
    "$session = $null",
    "Get-ChildItem -Path $coordParent -Directory -Filter '.coord-*' -ErrorAction SilentlyContinue | Where-Object { ($now - $_.CreationTime).TotalSeconds -lt 10 } | Select-Object -First 1 | ForEach-Object { $session = $_.Name -replace '^\\.coord-','' }",
    "if (-not $session) { $session = \"s-$(Get-Date -Format 'yyyyMMddHHmmss')-$PID\" }",
    "$coordDir = \"$coordParent/.coord-$session\"",
    "New-Item -ItemType Directory -Path $coordDir -Force | Out-Null",
    "$currentWorktree = (Get-Location).Path",
    "Get-ChildItem -Path $coordDir -Filter 'task-*.json' -ErrorAction SilentlyContinue | ForEach-Object { try { $claim = Get-Content $_.FullName | ConvertFrom-Json; if (-not (Test-Path $claim.worktree)) { Remove-Item $_.FullName -Force } } catch { } }",
    "$taskNum = 0",
    "for ($i = 1; $i -le 2; $i++) {",
    "  $lockDir = \"$coordDir/task-$i.lock\"",
    "  $claimFile = \"$coordDir/task-$i.json\"",
    "  try {",
    "    New-Item -ItemType Directory -Path $lockDir -ErrorAction Stop | Out-Null",
    "    if (-not (Test-Path $claimFile)) {",
    "      $taskNum = $i",
    "      $claim = @{ task = $i; worktree = $currentWorktree; claimed_at = (Get-Date -Format 'o'); pid = $PID }",
    "      $claim | ConvertTo-Json | Out-File -FilePath $claimFile -Encoding UTF8",
    "      Remove-Item -Path $lockDir -Force",
    "      break",
    "    }",
    "    Remove-Item -Path $lockDir -Force",
    "  } catch { }",
    "  Start-Sleep -Milliseconds 50",
    "}",
    "$taskNum | Out-File -FilePath '.agent-id' -Encoding UTF8 -NoNewline",
    "$session | Out-File -FilePath '.session-id' -Encoding UTF8 -NoNewline",
    "if (Test-Path \"$env:ROOT_WORKTREE_PATH\\.env\") { Copy-Item \"$env:ROOT_WORKTREE_PATH\\.env\" .env }"
  ]
}
